<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Gemforce Team" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Deployer Guide - Gemforce Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Deployer Guide";
        var mkdocs_page_input_path = "gemforce-deployer-guide.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Gemforce Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../system-architecture/gemforce-system-architecture/">System Architecture</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">API Documentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../api-documentation/gemforce-api-documentation/">Full API Reference</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../api-documentation/gemforce-api-quick-reference/">Quick Reference</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">EIPs (Ethereum Improvement Proposals)</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../eips/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eips/EIP-DRAFT-Diamond-Enhanced-Marketplace/">Diamond-Enhanced Marketplace</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eips/EIP-DRAFT-Multi-Token-Sale-Standard/">Multi-Token Sale Standard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eips/EIP-DRAFT-Collateralized-Trade-Deal-Standard/">Collateralized Trade Deal Standard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eips/EIP-DRAFT-Enhanced-Identity-System/">Enhanced Identity System</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eips/EIP-DRAFT-Diamond-Factory-Standard/">Diamond Factory Standard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../eips/EIP-DRAFT-Carbon-Credit-Standard/">Carbon Credit Standard</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">User Guides</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../gemforce-administrator-guide/">Administrator Guide</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Deployer Guide</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#table-of-contents">Table of Contents</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#deployment-prerequisites">Deployment Prerequisites</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#development-environment-setup">Development Environment Setup</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#required-tools-and-software">Required Tools and Software</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#network-access-requirements">Network Access Requirements</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#key-management-setup">Key Management Setup</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#environment-preparation">Environment Preparation</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#smart-contract-deployment">Smart Contract Deployment</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#contract-compilation">Contract Compilation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#diamond-pattern-deployment-workflow">Diamond Pattern Deployment Workflow</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#facet-deployment-process">Facet Deployment Process</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#contract-initialization">Contract Initialization</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#contract-verification">Contract Verification</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#gas-optimization-strategies">Gas Optimization Strategies</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#cloud-functions-deployment">Cloud Functions Deployment</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#parse-server-deployment">Parse Server Deployment</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#cloud-function-deployment">Cloud Function Deployment</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#environment-configuration">Environment Configuration</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#database-migration">Database Migration</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#websocket-setup">WebSocket Setup</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#environment-configuration_1">Environment Configuration</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#development-environment">Development Environment</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#testing-environment">Testing Environment</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#staging-environment">Staging Environment</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#production-environment">Production Environment</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#environment-specific-settings">Environment-Specific Settings</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#deployment-automation">Deployment Automation</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#cicd-pipeline-setup">CI/CD Pipeline Setup</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#automated-testing">Automated Testing</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#deployment-scripts">Deployment Scripts</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#infrastructure-as-code">Infrastructure as Code</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#continuous-monitoring">Continuous Monitoring</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#upgrade-procedures">Upgrade Procedures</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#smart-contract-upgrades">Smart Contract Upgrades</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#cloud-function-updates">Cloud Function Updates</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#database-schema-migrations">Database Schema Migrations</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#backward-compatibility-considerations">Backward Compatibility Considerations</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#feature-flagging">Feature Flagging</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#rollback-procedures">Rollback Procedures</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#smart-contract-rollbacks">Smart Contract Rollbacks</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#cloud-function-rollbacks">Cloud Function Rollbacks</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#database-rollbacks">Database Rollbacks</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#emergency-procedures">Emergency Procedures</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#data-integrity-verification">Data Integrity Verification</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#testing-and-verification">Testing and Verification</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#unit-testing">Unit Testing</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#integration-testing">Integration Testing</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#contract-verification_1">Contract Verification</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#load-testing">Load Testing</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#security-testing">Security Testing</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#network-management">Network Management</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#blockchain-node-management">Blockchain Node Management</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#rpc-endpoint-configuration">RPC Endpoint Configuration</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#transaction-monitoring">Transaction Monitoring</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#gas-price-management">Gas Price Management</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#network-upgrades-handling">Network Upgrades Handling</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#version-control">Version Control</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#repository-structure">Repository Structure</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#branching-strategy">Branching Strategy</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#release-management">Release Management</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#tagging-conventions">Tagging Conventions</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#documentation-versioning">Documentation Versioning</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gemforce-integrator-guide/">Integrator Guide</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../external-services/gemforce-external-services/">External Services</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../documentation-plan/">Documentation Plan</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Gemforce Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">User Guides</li>
      <li class="breadcrumb-item active">Deployer Guide</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="gemforce-deployer-guide">Gemforce Deployer Guide<a class="headerlink" href="#gemforce-deployer-guide" title="Permanent link">&para;</a></h1>
<h2 id="table-of-contents">Table of Contents<a class="headerlink" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="#deployment-prerequisites">Deployment Prerequisites</a></li>
<li><a href="#smart-contract-deployment">Smart Contract Deployment</a></li>
<li><a href="#cloud-functions-deployment">Cloud Functions Deployment</a></li>
<li><a href="#environment-configuration">Environment Configuration</a></li>
<li><a href="#deployment-automation">Deployment Automation</a></li>
<li><a href="#upgrade-procedures">Upgrade Procedures</a></li>
<li><a href="#rollback-procedures">Rollback Procedures</a></li>
<li><a href="#testing-and-verification">Testing and Verification</a></li>
<li><a href="#network-management">Network Management</a></li>
<li><a href="#version-control">Version Control</a></li>
</ul>
<h2 id="deployment-prerequisites">Deployment Prerequisites<a class="headerlink" href="#deployment-prerequisites" title="Permanent link">&para;</a></h2>
<h3 id="development-environment-setup">Development Environment Setup<a class="headerlink" href="#development-environment-setup" title="Permanent link">&para;</a></h3>
<p>To deploy the Gemforce platform, you'll need the following tools and software:</p>
<ol>
<li><strong>Node.js and npm</strong>:</li>
<li>Node.js v16 or later</li>
<li>npm v7 or later</li>
</ol>
<p>```bash
   # Install using nvm (recommended)
   nvm install 16
   nvm use 16</p>
<p># Verify installation
   node -v
   npm -v
   ```</p>
<ol>
<li><strong>Hardhat</strong>:</li>
<li>Used for smart contract development and deployment</li>
</ol>
<p>```bash
   # Install hardhat
   npm install --save-dev hardhat</p>
<p># Verify installation
   npx hardhat --version
   ```</p>
<ol>
<li><strong>MongoDB</strong>:</li>
<li>Version 4.4 or later</li>
<li>Required for Parse Server</li>
</ol>
<p>```bash
   # Installation varies by OS
   # macOS (using Homebrew)
   brew install mongodb-community</p>
<p># Verify installation
   mongod --version
   ```</p>
<ol>
<li><strong>Git</strong>:</li>
<li>For version control</li>
</ol>
<p><code>bash
   # Verify installation
   git --version</code></p>
<ol>
<li><strong>TypeScript</strong>:</li>
<li>Latest version</li>
</ol>
<p>```bash
   # Install TypeScript
   npm install -g typescript</p>
<p># Verify installation
   tsc --version
   ```</p>
<h3 id="required-tools-and-software">Required Tools and Software<a class="headerlink" href="#required-tools-and-software" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Development IDE</strong>:</li>
<li>Visual Studio Code (recommended)</li>
<li>
<p>Plugins:</p>
<ul>
<li>Solidity</li>
<li>TypeScript</li>
<li>ESLint</li>
<li>Prettier</li>
</ul>
</li>
<li>
<p><strong>Blockchain Tools</strong>:</p>
</li>
<li>MetaMask or similar wallet</li>
<li>Etherscan account (for contract verification)</li>
<li>
<p>Infura or Alchemy account (for RPC endpoints)</p>
</li>
<li>
<p><strong>Deployment Tools</strong>:</p>
</li>
<li>PM2 (for process management)</li>
<li>Docker (optional, for containerized deployment)</li>
</ol>
<p>```bash
   # Install PM2
   npm install -g pm2</p>
<p># Verify installation
   pm2 --version
   ```</p>
<ol>
<li><strong>Database Tools</strong>:</li>
<li>MongoDB Compass (GUI for MongoDB)</li>
<li>MongoDB Database Tools (mongodump, mongorestore)</li>
</ol>
<h3 id="network-access-requirements">Network Access Requirements<a class="headerlink" href="#network-access-requirements" title="Permanent link">&para;</a></h3>
<p>Ensure your deployment environment has access to:</p>
<ol>
<li><strong>Blockchain Networks</strong>:</li>
<li>Ethereum Mainnet (if deploying to production)</li>
<li>BaseSepolia (for testing)</li>
<li>
<p>Other EVM-compatible networks as needed</p>
</li>
<li>
<p><strong>External APIs</strong>:</p>
</li>
<li>DFNS API</li>
<li>Bridge API</li>
<li>
<p>SendGrid API</p>
</li>
<li>
<p><strong>Database Access</strong>:</p>
</li>
<li>MongoDB server (local or hosted)</li>
<li>
<p>Redis (if using for caching)</p>
</li>
<li>
<p><strong>Github/Version Control</strong>:</p>
</li>
<li>Access to Gemforce repositories</li>
</ol>
<h3 id="key-management-setup">Key Management Setup<a class="headerlink" href="#key-management-setup" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Create a secure key management strategy</strong>:</li>
</ol>
<p><code>bash
   # Create a directory for keys (outside of repository)
   mkdir -p ~/.gemforce/keys
   chmod 700 ~/.gemforce/keys</code></p>
<ol>
<li><strong>Generate deployment keys</strong>:</li>
</ol>
<p>```bash
   # Generate a private key for deployment
   openssl genpkey -algorithm RSA -out ~/.gemforce/keys/deployment_key.pem -pkeyopt rsa_keygen_bits:2048
   chmod 600 ~/.gemforce/keys/deployment_key.pem</p>
<p># Generate a DFNS private key
   openssl genpkey -algorithm RSA -out ~/.gemforce/keys/dfns_private.key -pkeyopt rsa_keygen_bits:2048
   chmod 600 ~/.gemforce/keys/dfns_private.key
   ```</p>
<ol>
<li><strong>Use environment files for sensitive data</strong>:</li>
</ol>
<p>```bash
   # Create a .env file for local development
   cp .env.example .env</p>
<p># Edit to add your keys and endpoints
   nano .env
   ```</p>
<h3 id="environment-preparation">Environment Preparation<a class="headerlink" href="#environment-preparation" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Clone the repository</strong>:</li>
</ol>
<p><code>bash
   git clone https://github.com/your-org/gemforce.git
   cd gemforce</code></p>
<ol>
<li><strong>Install dependencies</strong>:</li>
</ol>
<p><code>bash
   npm install</code></p>
<ol>
<li><strong>Set up environment files</strong>:</li>
</ol>
<p>```bash
   # Copy sample environment files
   cp .env.example .env
   cp gemforce.config.example.ts gemforce.config.ts</p>
<p># Edit the files with your configuration
   nano .env
   nano gemforce.config.ts
   ```</p>
<ol>
<li><strong>Create deployment directories</strong>:</li>
</ol>
<p><code>bash
   mkdir -p deployments</code></p>
<h2 id="smart-contract-deployment">Smart Contract Deployment<a class="headerlink" href="#smart-contract-deployment" title="Permanent link">&para;</a></h2>
<h3 id="contract-compilation">Contract Compilation<a class="headerlink" href="#contract-compilation" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Compile contracts using Hardhat</strong>:</li>
</ol>
<p><code>bash
   npx hardhat compile</code></p>
<ol>
<li><strong>Verify compilation output</strong>:</li>
<li>Check for successful compilation in <code>artifacts/</code> directory</li>
<li>
<p>Resolve any compilation errors</p>
</li>
<li>
<p><strong>Configuration for different networks</strong>:</p>
</li>
</ol>
<p><code>javascript
   // hardhat.config.ts
   module.exports = {
     solidity: {
       version: "0.8.17",
       settings: {
         optimizer: {
           enabled: true,
           runs: 200
         }
       }
     },
     networks: {
       hardhat: {
         chainId: 31337
       },
       baseSepolia: {
         url: `https://sepolia.base.org`,
         accounts: [process.env.PRIVATE_KEY],
         chainId: 84532
       },
       mainnet: {
         url: `https://mainnet.infura.io/v3/${process.env.INFURA_KEY}`,
         accounts: [process.env.PRIVATE_KEY],
         chainId: 1
       }
     }
   };</code></p>
<h3 id="diamond-pattern-deployment-workflow">Diamond Pattern Deployment Workflow<a class="headerlink" href="#diamond-pattern-deployment-workflow" title="Permanent link">&para;</a></h3>
<p>The Gemforce platform uses the Diamond pattern (EIP-2535) for smart contract deployment:</p>
<ol>
<li><strong>Deploy libraries first</strong>:</li>
</ol>
<p><code>bash
   npx hardhat deploy --tags Libraries --network baseSepolia</code></p>
<ol>
<li><strong>Deploy facets</strong>:</li>
</ol>
<p><code>bash
   npx hardhat deploy --tags Facets --network baseSepolia</code></p>
<ol>
<li><strong>Deploy Diamond contract</strong>:</li>
</ol>
<p><code>bash
   npx hardhat deploy --tags Diamond --network baseSepolia</code></p>
<ol>
<li><strong>Verify the deployment</strong>:</li>
</ol>
<p><code>bash
   npx hardhat verify --network baseSepolia &lt;DIAMOND_ADDRESS&gt;</code></p>
<h3 id="facet-deployment-process">Facet Deployment Process<a class="headerlink" href="#facet-deployment-process" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Develop new facets</strong> in the <code>/contracts/facets</code> directory</li>
<li><strong>Add to deployment scripts</strong> in <code>/deploy</code> directory</li>
<li><strong>Set up facet cut data</strong> for the Diamond contract:</li>
</ol>
<p><code>javascript
   // Example facet cut data
   const facetCuts = [
     {
       facetAddress: newFacetAddress,
       action: FacetCutAction.Add,
       functionSelectors: selectors
     }
   ];</code></p>
<ol>
<li><strong>Update the Diamond</strong> with new facets:</li>
</ol>
<p><code>javascript
   // Using the DiamondFactory
   await diamondFactory.setFacets(setName, facetCuts);</code></p>
<h3 id="contract-initialization">Contract Initialization<a class="headerlink" href="#contract-initialization" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Prepare initialization data</strong>:</li>
</ol>
<p><code>javascript
   // Example initialization data
   const initData = diamondInit.interface.encodeFunctionData("init", [
     [
       // Initial parameters
       tokenName,
       tokenSymbol,
       baseURI,
       // ...other params
     ]
   ]);</code></p>
<ol>
<li><strong>Initialize the Diamond</strong>:</li>
</ol>
<p>```javascript
   const settings = {
     name: "Gemforce Token",
     symbol: "GEM",
     // other settings
   };</p>
<p>await diamondFactory.createFromSet(
     settings,
     diamondInit.address,
     initData,
     "defaultFacetSet"
   );
   ```</p>
<h3 id="contract-verification">Contract Verification<a class="headerlink" href="#contract-verification" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Verify Diamond contract on Etherscan/Basescan</strong>:</li>
</ol>
<p><code>bash
   npx hardhat verify --network baseSepolia &lt;DIAMOND_ADDRESS&gt;</code></p>
<ol>
<li><strong>Verify individual facets</strong>:</li>
</ol>
<p><code>bash
   npx hardhat verify --network baseSepolia &lt;FACET_ADDRESS&gt;</code></p>
<ol>
<li><strong>Manual verification</strong> (if automatic verification fails):</li>
<li>Flatten the contract using Hardhat</li>
<li>Upload the flattened contract to the block explorer</li>
<li>Verify with the correct compiler settings</li>
</ol>
<h3 id="gas-optimization-strategies">Gas Optimization Strategies<a class="headerlink" href="#gas-optimization-strategies" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Use optimized Solidity patterns</strong>:</li>
<li>Minimize storage operations</li>
<li>Batch operations where possible</li>
<li>
<p>Use efficient data structures</p>
</li>
<li>
<p><strong>Configure gas prices for deployment</strong>:</p>
</li>
</ol>
<p><code>javascript
   // Example configuration for gas
   const tx = await contract.functionName(params, {
     gasPrice: (await ethers.provider.getGasPrice()).mul(2), // 2x current gas price
     gasLimit: 5000000
   });</code></p>
<ol>
<li><strong>Monitor gas usage during testing</strong>:</li>
</ol>
<p><code>javascript
   // Add gas reporter to Hardhat config
   gasReporter: {
     enabled: true,
     currency: 'USD',
     gasPrice: 100,
     coinmarketcap: process.env.COINMARKETCAP_API_KEY
   }</code></p>
<h2 id="cloud-functions-deployment">Cloud Functions Deployment<a class="headerlink" href="#cloud-functions-deployment" title="Permanent link">&para;</a></h2>
<h3 id="parse-server-deployment">Parse Server Deployment<a class="headerlink" href="#parse-server-deployment" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Prepare Parse Server configuration</strong>:</li>
</ol>
<p><code>javascript
   // Example Parse Server configuration
   const parseServerConfig = {
     appId: process.env.APP_ID,
     masterKey: process.env.MASTER_KEY,
     databaseURI: process.env.DATABASE_URI,
     serverURL: process.env.SERVER_URL,
     cloud: "./dist/src/cloud-functions.js",
     allowClientClassCreation: false,
     enableAnonymousUsers: false,
     maxUploadSize: "20mb",
     // ... other configuration
   };</code></p>
<ol>
<li><strong>Deploy Parse Server</strong>:</li>
</ol>
<p>Using PM2:</p>
<p>```bash
   # Start Parse Server with PM2
   pm2 start app.js --name gemforce-server</p>
<p># Save PM2 configuration
   pm2 save</p>
<p># Set up PM2 to start on system boot
   pm2 startup
   ```</p>
<p>Using Docker:</p>
<p>```bash
   # Build Docker image
   docker build -t gemforce-server .</p>
<p># Run container
   docker run -d -p 1337:1337 \
     --env-file .env \
     --name gemforce-server \
     gemforce-server
   ```</p>
<ol>
<li><strong>Verify Parse Server deployment</strong>:</li>
</ol>
<p>```bash
   # Check server status
   curl https://your-server-url.com/parse/health</p>
<p># Expected response: {"status":"ok"}
   ```</p>
<h3 id="cloud-function-deployment">Cloud Function Deployment<a class="headerlink" href="#cloud-function-deployment" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Compile TypeScript files</strong>:</li>
</ol>
<p><code>bash
   # Build the project
   npm run build</code></p>
<ol>
<li><strong>Deploy cloud functions</strong>:</li>
</ol>
<p>If using PM2:</p>
<p><code>bash
   # Restart the server to apply changes
   pm2 restart gemforce-server</code></p>
<p>If using Docker:</p>
<p><code>bash
   # Rebuild and redeploy
   docker build -t gemforce-server .
   docker stop gemforce-server
   docker rm gemforce-server
   docker run -d -p 1337:1337 \
     --env-file .env \
     --name gemforce-server \
     gemforce-server</code></p>
<ol>
<li><strong>Verify cloud function deployment</strong>:</li>
</ol>
<p><code>bash
   # Test a simple cloud function
   curl -X POST \
     -H "X-Parse-Application-Id: ${APP_ID}" \
     -H "Content-Type: application/json" \
     -d '{}' \
     https://your-server-url.com/parse/functions/loadAllBlockchains</code></p>
<h3 id="environment-configuration">Environment Configuration<a class="headerlink" href="#environment-configuration" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Set environment variables</strong>:</li>
</ol>
<p>```bash
   # Set environment variables in .env file
   cat &gt; .env &lt;&lt; EOL
   # Parse Server
   APP_ID=your_app_id
   MASTER_KEY=your_master_key
   DATABASE_URI=mongodb://username:password@host:port/database
   SERVER_URL=https://your-server-url.com/parse</p>
<p># Blockchain
   ETH_NODE_URI_BASESEP=https://sepolia.base.org
   CHAIN_ID=base-sepolia
   PRIVATE_KEY=your_private_key</p>
<p># External Services
   DFNS_APP_ID=your_dfns_app_id
   DFNS_API_URL=https://api.dfns.io
   DFNS_CRED_ID=your_dfns_credential_id</p>
<p># Additional Configuration
   METADATA_BASE_URI=https://metadata.gemforce.com/
   EOL
   ```</p>
<ol>
<li><strong>Configure database</strong>:</li>
<li>Set up MongoDB</li>
<li>Create database user</li>
<li>
<p>Configure connection string</p>
</li>
<li>
<p><strong>Set up web server</strong> (nginx example):</p>
</li>
</ol>
<p>```nginx
   # /etc/nginx/sites-available/gemforce
   server {
       listen 80;
       server_name api.gemforce.com;</p>
<div class="codehilite"><pre><span></span><code><span class="w">   </span><span class="nt">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="err">return</span><span class="w"> </span><span class="err">301</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="err">$</span><span class="n">host</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
</code></pre></div>

<p>}</p>
<p>server {
       listen 443 ssl;
       server_name api.gemforce.com;</p>
<div class="codehilite"><pre><span></span><code><span class="w">   </span><span class="nt">ssl_certificate</span><span class="w"> </span><span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">letsencrypt</span><span class="o">/</span><span class="nt">live</span><span class="o">/</span><span class="nt">api</span><span class="p">.</span><span class="nc">gemforce</span><span class="p">.</span><span class="nc">com</span><span class="o">/</span><span class="nt">fullchain</span><span class="p">.</span><span class="nc">pem</span><span class="o">;</span>
<span class="w">   </span><span class="nt">ssl_certificate_key</span><span class="w"> </span><span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">letsencrypt</span><span class="o">/</span><span class="nt">live</span><span class="o">/</span><span class="nt">api</span><span class="p">.</span><span class="nc">gemforce</span><span class="p">.</span><span class="nc">com</span><span class="o">/</span><span class="nt">privkey</span><span class="p">.</span><span class="nc">pem</span><span class="o">;</span>

<span class="w">   </span><span class="nt">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="err">proxy_pass</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="o">:</span><span class="mi">1337</span><span class="p">;</span>
<span class="w">       </span><span class="err">proxy_http_version</span><span class="w"> </span><span class="err">1.1</span><span class="p">;</span>
<span class="w">       </span><span class="err">proxy_set_header</span><span class="w"> </span><span class="err">Upgrade</span><span class="w"> </span><span class="err">$http_upgrade</span><span class="p">;</span>
<span class="w">       </span><span class="err">proxy_set_header</span><span class="w"> </span><span class="err">Connection</span><span class="w"> </span><span class="err">&#39;upgrade&#39;</span><span class="p">;</span>
<span class="w">       </span><span class="err">proxy_set_header</span><span class="w"> </span><span class="err">Host</span><span class="w"> </span><span class="err">$host</span><span class="p">;</span>
<span class="w">       </span><span class="err">proxy_cache_bypass</span><span class="w"> </span><span class="err">$http_upgrade</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
</code></pre></div>

<p>}
   ```</p>
<h3 id="database-migration">Database Migration<a class="headerlink" href="#database-migration" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Create database migrations</strong>:</li>
</ol>
<p>```javascript
   // Example migration script (migrations/001_add_indexes.js)
   async function up(db) {
     await db.collection('User').createIndex({ walletAddress: 1 });
     await db.collection('Identity').createIndex({ walletAddress: 1 }, { unique: true });
     await db.collection('Transaction').createIndex({ hash: 1 }, { unique: true });
   }</p>
<p>async function down(db) {
     await db.collection('User').dropIndex({ walletAddress: 1 });
     await db.collection('Identity').dropIndex({ walletAddress: 1 });
     await db.collection('Transaction').dropIndex({ hash: 1 });
   }</p>
<p>module.exports = { up, down };
   ```</p>
<ol>
<li><strong>Run migrations</strong>:</li>
</ol>
<p><code>bash
   # Example using a simple migration tool
   npx migrate-mongo up</code></p>
<ol>
<li><strong>Verify migrations</strong>:</li>
</ol>
<p><code>javascript
   // Check indexes
   db.User.getIndexes()
   db.Identity.getIndexes()
   db.Transaction.getIndexes()</code></p>
<h3 id="websocket-setup">WebSocket Setup<a class="headerlink" href="#websocket-setup" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Configure WebSocket endpoints</strong>:</li>
</ol>
<p>```javascript
   // Example WebSocket server setup
   const wss = new WebSocketServer({ 
     server: httpServer,
     path: "/ws"
   });</p>
<p>wss.on('connection', (ws) =&gt; {
     // Handle connection
     ws.on('message', (message) =&gt; {
       // Handle message
     });</p>
<div class="codehilite"><pre><span></span><code> ws.on(&#39;close&#39;, () =&gt; {
   // Handle disconnection
 });
</code></pre></div>

<p>});
   ```</p>
<ol>
<li><strong>Set up blockchain event listeners</strong>:</li>
</ol>
<p>```javascript
   // Example blockchain event listener
   function setupEventListeners(provider, diamondAddress) {
     const diamond = new ethers.Contract(
       diamondAddress,
       DiamondABI,
       provider
     );</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="nt">diamond</span><span class="p">.</span><span class="nc">on</span><span class="o">(</span><span class="s2">&quot;Transfer&quot;</span><span class="o">,</span><span class="w"> </span><span class="o">(</span><span class="nt">from</span><span class="o">,</span><span class="w"> </span><span class="nt">to</span><span class="o">,</span><span class="w"> </span><span class="nt">tokenId</span><span class="o">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="err">//</span><span class="w"> </span><span class="err">Handle</span><span class="w"> </span><span class="err">transfer</span><span class="w"> </span><span class="err">event</span>
<span class="w">   </span><span class="err">//</span><span class="w"> </span><span class="err">Broadcast</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">connected</span><span class="w"> </span><span class="err">WebSocket</span><span class="w"> </span><span class="err">clients</span>
<span class="w">   </span><span class="err">wss.clients.forEach((client)</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">     </span><span class="err">if</span><span class="w"> </span><span class="err">(client.readyState</span><span class="w"> </span><span class="err">===</span><span class="w"> </span><span class="err">WebSocket.OPEN)</span><span class="w"> </span><span class="err">{</span>
<span class="w">       </span><span class="err">client.send(JSON.stringify({</span>
<span class="w">         </span><span class="n">event</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Transfer&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="n">data</span><span class="o">:</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="kc">to</span><span class="p">,</span><span class="w"> </span><span class="n">tokenId</span><span class="o">:</span><span class="w"> </span><span class="n">tokenId</span><span class="o">.</span><span class="nf">toString</span><span class="p">()</span><span class="w"> </span><span class="p">}</span>
<span class="w">       </span><span class="err">}</span><span class="o">));</span>
<span class="w">     </span><span class="err">}</span>
<span class="w">   </span><span class="err">}</span><span class="o">);</span>
<span class="w"> </span><span class="err">}</span><span class="o">);</span>
</code></pre></div>

<p>}
   ```</p>
<h2 id="environment-configuration_1">Environment Configuration<a class="headerlink" href="#environment-configuration_1" title="Permanent link">&para;</a></h2>
<h3 id="development-environment">Development Environment<a class="headerlink" href="#development-environment" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Local environment setup</strong>:</li>
</ol>
<p>```bash
   # Start local hardhat node
   npx hardhat node</p>
<p># Deploy contracts to local node
   npx hardhat deploy --network localhost</p>
<p># Start Parse Server locally
   npm run dev
   ```</p>
<ol>
<li><strong>Environment configuration file for development</strong>:</li>
</ol>
<p>```
   # .env.development
   APP_ID=gemforce_dev
   MASTER_KEY=your_dev_master_key
   DATABASE_URI=mongodb://localhost:27017/gemforce_dev
   SERVER_URL=http://localhost:1337/parse</p>
<p># Use local hardhat node
   ETH_NODE_URI_LOCAL=http://localhost:8545
   CHAIN_ID=31337</p>
<p># Development keys
   PRIVATE_KEY=your_dev_private_key
   ```</p>
<ol>
<li><strong>Development database setup</strong>:</li>
</ol>
<p>```bash
   # Start MongoDB locally
   mongod --dbpath ./data</p>
<p># Create database and user
   mongo</p>
<blockquote>
<p>use gemforce_dev
db.createUser({
       user: "gemforce_user",
       pwd: "password",
       roles: [{ role: "readWrite", db: "gemforce_dev" }]
     })
   ```</p>
</blockquote>
<h3 id="testing-environment">Testing Environment<a class="headerlink" href="#testing-environment" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Testing environment configuration</strong>:</li>
</ol>
<p>```
   # .env.test
   APP_ID=gemforce_test
   MASTER_KEY=your_test_master_key
   DATABASE_URI=mongodb://localhost:27017/gemforce_test
   SERVER_URL=http://localhost:1337/parse</p>
<p># Use BaseSepolia for testing
   ETH_NODE_URI_BASESEP=https://sepolia.base.org
   CHAIN_ID=84532</p>
<p># Test keys
   PRIVATE_KEY=your_test_private_key
   ```</p>
<ol>
<li><strong>Automated testing setup</strong>:</li>
</ol>
<p>```bash
   # Run tests
   npm test</p>
<p># Run specific tests
   npx mocha test/specific-test.js
   ```</p>
<ol>
<li><strong>Test database initialization</strong>:</li>
</ol>
<p><code>javascript
   // Initialize test database
   before(async () =&gt; {
     const client = await MongoClient.connect(process.env.DATABASE_URI);
     const db = client.db();
     await db.collection('User').deleteMany({});
     await db.collection('Identity').deleteMany({});
     // Seed with test data
     await db.collection('User').insertMany(testUsers);
   });</code></p>
<h3 id="staging-environment">Staging Environment<a class="headerlink" href="#staging-environment" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Staging environment configuration</strong>:</li>
</ol>
<p>```
   # .env.staging
   APP_ID=gemforce_staging
   MASTER_KEY=your_staging_master_key
   DATABASE_URI=mongodb://user:password@staging-db:27017/gemforce_staging
   SERVER_URL=https://staging-api.gemforce.com/parse</p>
<p># Use BaseSepolia for staging
   ETH_NODE_URI_BASESEP=https://sepolia.base.org
   CHAIN_ID=84532</p>
<p># Staging keys
   PRIVATE_KEY=your_staging_private_key
   ```</p>
<ol>
<li><strong>Staging deployment</strong>:</li>
</ol>
<p>```bash
   # Deploy to staging
   npm run deploy:staging</p>
<p># Run database migrations
   npm run migrate:staging
   ```</p>
<ol>
<li><strong>Staging verification</strong>:</li>
</ol>
<p><code>bash
   # Verify staging deployment
   curl https://staging-api.gemforce.com/parse/health</code></p>
<h3 id="production-environment">Production Environment<a class="headerlink" href="#production-environment" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Production environment configuration</strong>:</li>
</ol>
<p>```
   # .env.production
   APP_ID=gemforce_prod
   MASTER_KEY=your_production_master_key
   DATABASE_URI=mongodb://user:password@production-db:27017/gemforce_production
   SERVER_URL=https://api.gemforce.com/parse</p>
<p># Use production endpoints
   ETH_NODE_URI_MAINNET=https://mainnet.infura.io/v3/your_infura_key
   CHAIN_ID=1</p>
<p># Production keys stored securely
   # PRIVATE_KEY should be handled with extra security
   ```</p>
<ol>
<li><strong>Production deployment steps</strong>:</li>
</ol>
<p>```bash
   # Deploy to production
   npm run deploy:production</p>
<p># Run database migrations
   npm run migrate:production
   ```</p>
<ol>
<li><strong>Production verification</strong>:</li>
</ol>
<p>```bash
   # Verify production deployment
   curl https://api.gemforce.com/parse/health</p>
<p># Monitor logs
   pm2 logs gemforce-server
   ```</p>
<h3 id="environment-specific-settings">Environment-Specific Settings<a class="headerlink" href="#environment-specific-settings" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Configuration management</strong>:</li>
</ol>
<p><code>``javascript
   // Load environment-specific configuration
   const envConfig = require(</code>./config/${process.env.NODE_ENV || 'development'}`);</p>
<p>module.exports = {
     // Base configuration
     appName: 'Gemforce',</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="c1">// Merge with environment-specific config</span>
<span class="w"> </span><span class="p">...</span><span class="n">envConfig</span>
</code></pre></div>

<p>};
   ```</p>
<ol>
<li><strong>Feature flags</strong>:</li>
</ol>
<p>```javascript
   // Example feature flags configuration
   const featureFlags = {
     development: {
       enableNewMarketplace: true,
       enableCarbonCredits: true
     },
     staging: {
       enableNewMarketplace: true,
       enableCarbonCredits: false
     },
     production: {
       enableNewMarketplace: false,
       enableCarbonCredits: false
     }
   };</p>
<p>// Usage
   if (featureFlags[process.env.NODE_ENV].enableNewMarketplace) {
     // Initialize new marketplace
   }
   ```</p>
<h2 id="deployment-automation">Deployment Automation<a class="headerlink" href="#deployment-automation" title="Permanent link">&para;</a></h2>
<h3 id="cicd-pipeline-setup">CI/CD Pipeline Setup<a class="headerlink" href="#cicd-pipeline-setup" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>GitHub Actions workflow</strong>:</li>
</ol>
<p>```yaml
   # .github/workflows/deploy.yml
   name: Deploy Gemforce</p>
<p>on:
     push:
       branches: [ main, staging ]</p>
<p>jobs:
     test:
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v2
         - name: Setup Node.js
           uses: actions/setup-node@v2
           with:
             node-version: '16'
         - name: Install dependencies
           run: npm ci
         - name: Run tests
           run: npm test</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="n">build</span><span class="p">:</span>
<span class="w">   </span><span class="n">needs</span><span class="p">:</span><span class="w"> </span><span class="n">test</span>
<span class="w">   </span><span class="n">runs</span><span class="o">-</span><span class="n">on</span><span class="p">:</span><span class="w"> </span><span class="n">ubuntu</span><span class="o">-</span><span class="n">latest</span>
<span class="w">   </span><span class="n">steps</span><span class="p">:</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">uses</span><span class="p">:</span><span class="w"> </span><span class="n">actions</span><span class="o">/</span><span class="n">checkout</span><span class="err">@</span><span class="n">v2</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">Setup</span><span class="w"> </span><span class="n">Node</span><span class="o">.</span><span class="n">js</span>
<span class="w">       </span><span class="n">uses</span><span class="p">:</span><span class="w"> </span><span class="n">actions</span><span class="o">/</span><span class="n">setup</span><span class="o">-</span><span class="n">node</span><span class="err">@</span><span class="n">v2</span>
<span class="w">       </span><span class="n">with</span><span class="p">:</span>
<span class="w">         </span><span class="n">node</span><span class="o">-</span><span class="n">version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;16&#39;</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">Install</span><span class="w"> </span><span class="n">dependencies</span>
<span class="w">       </span><span class="n">run</span><span class="p">:</span><span class="w"> </span><span class="n">npm</span><span class="w"> </span><span class="n">ci</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="n">project</span>
<span class="w">       </span><span class="n">run</span><span class="p">:</span><span class="w"> </span><span class="n">npm</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">build</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">Upload</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="n">artifacts</span>
<span class="w">       </span><span class="n">uses</span><span class="p">:</span><span class="w"> </span><span class="n">actions</span><span class="o">/</span><span class="n">upload</span><span class="o">-</span><span class="n">artifact</span><span class="err">@</span><span class="n">v2</span>
<span class="w">       </span><span class="n">with</span><span class="p">:</span>
<span class="w">         </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">build</span>
<span class="w">         </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="n">dist</span><span class="o">/</span>

<span class="w"> </span><span class="n">deploy</span><span class="p">:</span>
<span class="w">   </span><span class="n">needs</span><span class="p">:</span><span class="w"> </span><span class="n">build</span>
<span class="w">   </span><span class="n">runs</span><span class="o">-</span><span class="n">on</span><span class="p">:</span><span class="w"> </span><span class="n">ubuntu</span><span class="o">-</span><span class="n">latest</span>
<span class="w">   </span><span class="n">steps</span><span class="p">:</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">uses</span><span class="p">:</span><span class="w"> </span><span class="n">actions</span><span class="o">/</span><span class="n">checkout</span><span class="err">@</span><span class="n">v2</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">Download</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="n">artifacts</span>
<span class="w">       </span><span class="n">uses</span><span class="p">:</span><span class="w"> </span><span class="n">actions</span><span class="o">/</span><span class="n">download</span><span class="o">-</span><span class="n">artifact</span><span class="err">@</span><span class="n">v2</span>
<span class="w">       </span><span class="n">with</span><span class="p">:</span>
<span class="w">         </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">build</span>
<span class="w">         </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="n">dist</span><span class="o">/</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">Deploy</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">server</span>
<span class="w">       </span><span class="n">uses</span><span class="p">:</span><span class="w"> </span><span class="n">appleboy</span><span class="o">/</span><span class="n">ssh</span><span class="o">-</span><span class="n">action</span><span class="err">@</span><span class="k">master</span>
<span class="w">       </span><span class="n">with</span><span class="p">:</span>
<span class="w">         </span><span class="n">host</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="n">secrets</span><span class="o">.</span><span class="n">SERVER_HOST</span><span class="w"> </span><span class="p">}}</span>
<span class="w">         </span><span class="n">username</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="n">secrets</span><span class="o">.</span><span class="n">SERVER_USERNAME</span><span class="w"> </span><span class="p">}}</span>
<span class="w">         </span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="n">secrets</span><span class="o">.</span><span class="n">SSH_PRIVATE_KEY</span><span class="w"> </span><span class="p">}}</span>
<span class="w">         </span><span class="n">script</span><span class="p">:</span><span class="w"> </span><span class="o">|</span>
<span class="w">           </span><span class="n">cd</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">gemforce</span>
<span class="w">           </span><span class="n">git</span><span class="w"> </span><span class="n">pull</span>
<span class="w">           </span><span class="n">npm</span><span class="w"> </span><span class="n">ci</span>
<span class="w">           </span><span class="n">cp</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="n">github</span><span class="o">.</span><span class="n">workspace</span><span class="w"> </span><span class="p">}}</span><span class="o">/</span><span class="n">dist</span><span class="o">/*</span><span class="w"> </span><span class="o">./</span><span class="n">dist</span><span class="o">/</span>
<span class="w">           </span><span class="n">pm2</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">gemforce</span><span class="o">-</span><span class="n">server</span>
</code></pre></div>

<p>```</p>
<ol>
<li><strong>Automatic testing</strong>:</li>
</ol>
<p>```yaml
   # .github/workflows/test.yml
   name: Test Gemforce</p>
<p>on:
     pull_request:
       branches: [ main, staging ]</p>
<p>jobs:
     test:
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v2
         - name: Setup Node.js
           uses: actions/setup-node@v2
           with:
             node-version: '16'
         - name: Install dependencies
           run: npm ci
         - name: Run linting
           run: npm run lint
         - name: Run tests
           run: npm test
   ```</p>
<h3 id="automated-testing">Automated Testing<a class="headerlink" href="#automated-testing" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Unit tests for smart contracts</strong>:</li>
</ol>
<p>```javascript
   // test/GemforceMinter.test.ts
   describe("GemforceMinter", function() {
     let owner, user;
     let diamond, gemforceMinter;</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="n">beforeEach</span><span class="p">(</span><span class="n">async</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="p">[</span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ethers</span><span class="o">.</span><span class="n">getSigners</span><span class="p">();</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Deploy</span><span class="w"> </span><span class="n">diamond</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">GemforceMinterFacet</span>
<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="o">...</span><span class="n">deployment</span><span class="w"> </span><span class="n">code</span>

<span class="w">   </span><span class="n">gemforceMinter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ethers</span><span class="o">.</span><span class="n">getContractAt</span><span class="p">(</span><span class="s2">&quot;GemforceMinterFacet&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">diamond</span><span class="o">.</span><span class="n">address</span><span class="p">);</span>
<span class="w"> </span><span class="p">});</span>

<span class="w"> </span><span class="n">it</span><span class="p">(</span><span class="s2">&quot;should mint a token with metadata&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">     </span><span class="p">{</span><span class="w"> </span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">attributeType</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Carbon Credit&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">     </span><span class="p">{</span><span class="w"> </span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;amount&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">attributeType</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;100&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="w">   </span><span class="p">];</span>

<span class="w">   </span><span class="n">await</span><span class="w"> </span><span class="n">expect</span><span class="p">(</span><span class="n">gemforceMinter</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span><span class="o">.</span><span class="n">gemforceMint</span><span class="p">(</span><span class="n">metadata</span><span class="p">))</span>
<span class="w">     </span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">gemforceMinter</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;GemforceMinted&quot;</span><span class="p">)</span>
<span class="w">     </span><span class="o">.</span><span class="n">withArgs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">owner</span><span class="o">.</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">metadata</span><span class="p">);</span>
<span class="w"> </span><span class="p">});</span>
</code></pre></div>

<p>});
   ```</p>
<ol>
<li><strong>API endpoint tests</strong>:</li>
</ol>
<p>```javascript
   // test/cloud-functions.test.js
   describe("Cloud Functions", function() {
     before(async function() {
       // Initialize Parse Server for testing
       Parse.initialize("test_app_id", "test_js_key", "test_master_key");
       Parse.serverURL = "http://localhost:1337/parse";
     });</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="n">it</span><span class="p">(</span><span class="s2">&quot;should retrieve blockchain data&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">Parse</span><span class="o">.</span><span class="n">Cloud</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;loadAllBlockchains&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">expect</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">be</span><span class="o">.</span><span class="n">an</span><span class="p">(</span><span class="s2">&quot;array&quot;</span><span class="p">);</span>
<span class="w"> </span><span class="p">});</span>
</code></pre></div>

<p>});
   ```</p>
<ol>
<li><strong>End-to-end tests</strong>:</li>
</ol>
<p>```javascript
   // test/e2e/user-flow.test.js
   describe("User Flow", function() {
     it("should register, create identity, and mint token", async function() {
       // Register user
       const user = await registerUser("test@example.com", "password");</p>
<div class="codehilite"><pre><span></span><code><span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="n">DFNS</span><span class="w"> </span><span class="n">wallet</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">walletId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">createDFNSWallet</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="n">identity</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">identityAddress</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">createIdentity</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">walletId</span><span class="p">);</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Mint</span><span class="w"> </span><span class="n">token</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">tokenId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">mintToken</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">walletId</span><span class="p">);</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Verify</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="n">ownership</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">getTokenOwner</span><span class="p">(</span><span class="n">tokenId</span><span class="p">);</span>
<span class="w">   </span><span class="n">expect</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;walletAddress&quot;</span><span class="p">));</span>
<span class="w"> </span><span class="p">});</span>
</code></pre></div>

<p>});
   ```</p>
<h3 id="deployment-scripts">Deployment Scripts<a class="headerlink" href="#deployment-scripts" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Smart contract deployment script</strong>:</li>
</ol>
<p>```javascript
   // scripts/deploy-contracts.js
   async function main() {
     // Get deployer
     const [deployer] = await ethers.getSigners();
     console.log("Deploying contracts with account:", deployer.address);</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="c1">// Deploy libraries</span>
<span class="w"> </span><span class="nx">const</span><span class="w"> </span><span class="nx">LibraryA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">await</span><span class="w"> </span><span class="nx">ethers</span><span class="p">.</span><span class="nx">getContractFactory</span><span class="p">(</span><span class="s">&quot;LibraryA&quot;</span><span class="p">);</span>
<span class="w"> </span><span class="nx">const</span><span class="w"> </span><span class="nx">libraryA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">await</span><span class="w"> </span><span class="nx">LibraryA</span><span class="p">.</span><span class="nx">deploy</span><span class="p">();</span>
<span class="w"> </span><span class="nx">await</span><span class="w"> </span><span class="nx">libraryA</span><span class="p">.</span><span class="nx">deployed</span><span class="p">();</span>
<span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&quot;LibraryA deployed to:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryA</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>

<span class="w"> </span><span class="c1">// Deploy facets with libraries</span>
<span class="w"> </span><span class="nx">const</span><span class="w"> </span><span class="nx">FacetA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">await</span><span class="w"> </span><span class="nx">ethers</span><span class="p">.</span><span class="nx">getContractFactory</span><span class="p">(</span><span class="s">&quot;FacetA&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nx">libraries</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="nx">LibraryA</span><span class="p">:</span><span class="w"> </span><span class="nx">libraryA</span><span class="p">.</span><span class="nx">address</span>
<span class="w">   </span><span class="p">}</span>
<span class="w"> </span><span class="p">});</span>
<span class="w"> </span><span class="nx">const</span><span class="w"> </span><span class="nx">facetA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">await</span><span class="w"> </span><span class="nx">FacetA</span><span class="p">.</span><span class="nx">deploy</span><span class="p">();</span>
<span class="w"> </span><span class="nx">await</span><span class="w"> </span><span class="nx">facetA</span><span class="p">.</span><span class="nx">deployed</span><span class="p">();</span>
<span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&quot;FacetA deployed to:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">facetA</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>

<span class="w"> </span><span class="c1">// More deployments...</span>
</code></pre></div>

<p>}</p>
<p>main()
     .then(() =&gt; process.exit(0))
     .catch(error =&gt; {
       console.error(error);
       process.exit(1);
     });
   ```</p>
<ol>
<li><strong>Parse Server deployment script</strong>:</li>
</ol>
<p>```bash
   #!/bin/bash
   # scripts/deploy-parse.sh</p>
<p># Load environment variables
   source .env.${NODE_ENV:-production}</p>
<p># Build the project
   echo "Building project..."
   npm run build</p>
<p># Deploy to server
   echo "Deploying to server..."
   rsync -avz --exclude node_modules --exclude .git . user@server:/var/www/gemforce/</p>
<p># SSH into server and restart
   ssh user@server &lt;&lt; EOF
     cd /var/www/gemforce
     npm ci --production
     pm2 restart gemforce-server
   EOF</p>
<p>echo "Deployment complete!"
   ```</p>
<h3 id="infrastructure-as-code">Infrastructure as Code<a class="headerlink" href="#infrastructure-as-code" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Terraform configuration</strong>:</li>
</ol>
<p>```hcl
   # main.tf
   provider "aws" {
     region = "us-east-1"
   }</p>
<p>resource "aws_instance" "gemforce_server" {
     ami           = "ami-0c55b159cbfafe1f0"
     instance_type = "t2.medium"
     key_name      = "gemforce-key"</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="n">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;gemforce-server&quot;</span>
<span class="w">   </span><span class="n">Environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">var</span><span class="o">.</span><span class="n">environment</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="n">root_block_device</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">volume_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span>
<span class="w">   </span><span class="n">volume_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;gp2&quot;</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="n">vpc_security_group_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">aws_security_group</span><span class="o">.</span><span class="n">gemforce_sg</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
</code></pre></div>

<p>}</p>
<p>resource "aws_security_group" "gemforce_sg" {
     name        = "gemforce-sg"
     description = "Allow web and SSH traffic"</p>
<div class="codehilite"><pre><span></span><code> ingress {
   from_port   = 80
   to_port     = 80
   protocol    = &quot;tcp&quot;
   cidr_blocks = [&quot;0.0.0.0/0&quot;]
 }

 ingress {
   from_port   = 443
   to_port     = 443
   protocol    = &quot;tcp&quot;
   cidr_blocks = [&quot;0.0.0.0/0&quot;]
 }

 ingress {
   from_port   = 22
   to_port     = 22
   protocol    = &quot;tcp&quot;
   cidr_blocks = [&quot;0.0.0.0/0&quot;]
 }

 egress {
   from_port   = 0
   to_port     = 0
   protocol    = &quot;-1&quot;
   cidr_blocks = [&quot;0.0.0.0/0&quot;]
 }
</code></pre></div>

<p>}</p>
<p>output "server_ip" {
     value = aws_instance.gemforce_server.public_ip
   }
   ```</p>
<ol>
<li><strong>Docker Compose setup</strong>:</li>
</ol>
<p>```yaml
   # docker-compose.yml
   version: '3'</p>
<p>services:
     mongodb:
       image: mongo:4.4
       ports:
         - "27017:27017"
       volumes:
         - mongo-data:/data/db
       environment:
         MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME}
         MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
       restart: always</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="n">parse</span><span class="o">-</span><span class="n">server</span><span class="p">:</span>
<span class="w">   </span><span class="n">build</span><span class="p">:</span><span class="w"> </span><span class="o">.</span>
<span class="w">   </span><span class="n">ports</span><span class="p">:</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="s2">&quot;1337:1337&quot;</span>
<span class="w">   </span><span class="n">environment</span><span class="p">:</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">APP_ID</span><span class="o">=$</span><span class="p">{</span><span class="n">APP_ID</span><span class="p">}</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">MASTER_KEY</span><span class="o">=$</span><span class="p">{</span><span class="n">MASTER_KEY</span><span class="p">}</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">DATABASE_URI</span><span class="o">=</span><span class="n">mongodb</span><span class="p">:</span><span class="o">//$</span><span class="p">{</span><span class="n">MONGO_USERNAME</span><span class="p">}:</span><span class="o">$</span><span class="p">{</span><span class="n">MONGO_PASSWORD</span><span class="p">}</span><span class="err">@</span><span class="n">mongodb</span><span class="p">:</span><span class="mi">27017</span><span class="o">/$</span><span class="p">{</span><span class="n">DATABASE_NAME</span><span class="p">}</span><span class="err">?</span><span class="n">authSource</span><span class="o">=</span><span class="n">admin</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">SERVER_URL</span><span class="o">=$</span><span class="p">{</span><span class="n">SERVER_URL</span><span class="p">}</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">CLOUD_PATH</span><span class="o">=/</span><span class="n">parse</span><span class="o">-</span><span class="n">server</span><span class="o">/</span><span class="n">cloud</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">js</span>
<span class="w">   </span><span class="n">volumes</span><span class="p">:</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="o">./</span><span class="n">cloud</span><span class="p">:</span><span class="o">/</span><span class="n">parse</span><span class="o">-</span><span class="n">server</span><span class="o">/</span><span class="n">cloud</span>
<span class="w">   </span><span class="n">depends_on</span><span class="p">:</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">mongodb</span>
<span class="w">   </span><span class="n">restart</span><span class="p">:</span><span class="w"> </span><span class="n">always</span>

<span class="w"> </span><span class="n">nginx</span><span class="p">:</span>
<span class="w">   </span><span class="n">image</span><span class="p">:</span><span class="w"> </span><span class="n">nginx</span><span class="p">:</span><span class="n">latest</span>
<span class="w">   </span><span class="n">ports</span><span class="p">:</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="s2">&quot;80:80&quot;</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="s2">&quot;443:443&quot;</span>
<span class="w">   </span><span class="n">volumes</span><span class="p">:</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="o">./</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="o">./</span><span class="n">nginx</span><span class="o">/</span><span class="n">ssl</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">ssl</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="o">./</span><span class="n">nginx</span><span class="o">/</span><span class="n">www</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span>
<span class="w">   </span><span class="n">depends_on</span><span class="p">:</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">parse</span><span class="o">-</span><span class="n">server</span>
<span class="w">   </span><span class="n">restart</span><span class="p">:</span><span class="w"> </span><span class="n">always</span>
</code></pre></div>

<p>volumes:
     mongo-data:
   ```</p>
<h3 id="continuous-monitoring">Continuous Monitoring<a class="headerlink" href="#continuous-monitoring" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Setup monitoring tools</strong>:</li>
</ol>
<p>```javascript
   // Monitoring setup in app.js
   const prometheus = require('prom-client');
   const collectDefaultMetrics = prometheus.collectDefaultMetrics;</p>
<p>// Enable default metrics
   collectDefaultMetrics({ timeout: 5000 });</p>
<p>// Custom metrics
   const httpRequestDurationMicroseconds = new prometheus.Histogram({
     name: 'http_request_duration_ms',
     help: 'Duration of HTTP requests in ms',
     labelNames: ['method', 'route', 'status_code'],
     buckets: [0.1, 5, 15, 50, 100, 500]
   });</p>
<p>// Endpoint for metrics
   app.get('/metrics', (req, res) =&gt; {
     res.set('Content-Type', prometheus.register.contentType);
     res.end(prometheus.register.metrics());
   });
   ```</p>
<ol>
<li><strong>Logging configuration</strong>:</li>
</ol>
<p>```javascript
   // Logging setup in app.js
   const winston = require('winston');</p>
<p>const logger = winston.createLogger({
     level: process.env.LOG_LEVEL || 'info',
     format: winston.format.combine(
       winston.format.timestamp(),
       winston.format.json()
     ),
     transports: [
       new winston.transports.Console(),
       new winston.transports.File({ filename: 'error.log', level: 'error' }),
       new winston.transports.File({ filename: 'combined.log' })
     ]
   });</p>
<p>// Use in application
   logger.info('Server started', { port: 1337 });
   ```</p>
<h2 id="upgrade-procedures">Upgrade Procedures<a class="headerlink" href="#upgrade-procedures" title="Permanent link">&para;</a></h2>
<h3 id="smart-contract-upgrades">Smart Contract Upgrades<a class="headerlink" href="#smart-contract-upgrades" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Upgrading a facet</strong>:</li>
</ol>
<p>```javascript
   // scripts/upgrade-facet.js
   async function main() {
     // Get signer
     const [signer] = await ethers.getSigners();</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Deploy</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">facet</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">NewFacet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ethers</span><span class="p">.</span><span class="n">getContractFactory</span><span class="p">(</span><span class="ss">&quot;NewFacetV2&quot;</span><span class="p">);</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">newFacet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">NewFacet</span><span class="p">.</span><span class="n">deploy</span><span class="p">();</span>
<span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">newFacet</span><span class="p">.</span><span class="n">deployed</span><span class="p">();</span>
<span class="w"> </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="ss">&quot;New facet deployed to:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">newFacet</span><span class="p">.</span><span class="n">address</span><span class="p">);</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">Get</span><span class="w"> </span><span class="n">diamond</span><span class="w"> </span><span class="n">contract</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">diamond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ethers</span><span class="p">.</span><span class="n">getContractAt</span><span class="p">(</span><span class="ss">&quot;Diamond&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DIAMOND_ADDRESS</span><span class="p">);</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">Get</span><span class="w"> </span><span class="n">selectors</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">facet</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">selectors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getSelectors</span><span class="p">(</span><span class="n">newFacet</span><span class="p">);</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">Create</span><span class="w"> </span><span class="n">facet</span><span class="w"> </span><span class="n">cut</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">facetCut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="nl">facetAddress</span><span class="p">:</span><span class="w"> </span><span class="n">newFacet</span><span class="p">.</span><span class="n">address</span><span class="p">,</span>
<span class="w">   </span><span class="k">action</span><span class="err">:</span><span class="w"> </span><span class="n">FacetCutAction</span><span class="p">.</span><span class="nf">Replace</span><span class="p">,</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nf">Replace</span><span class="w"> </span><span class="n">existing</span><span class="w"> </span><span class="n">facet</span>
<span class="w">   </span><span class="nl">functionSelectors</span><span class="p">:</span><span class="w"> </span><span class="n">selectors</span>
<span class="w"> </span><span class="err">}</span><span class="p">;</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Perform</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">upgrade</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">diamond</span><span class="p">.</span><span class="n">diamondCut</span><span class="p">(</span>
<span class="w">   </span><span class="o">[</span><span class="n">facetCut</span><span class="o">]</span><span class="p">,</span>
<span class="w">   </span><span class="n">ethers</span><span class="p">.</span><span class="n">constants</span><span class="p">.</span><span class="n">AddressZero</span><span class="p">,</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">No</span><span class="w"> </span><span class="n">initialization</span>
<span class="w">   </span><span class="ss">&quot;0x&quot;</span>
<span class="w"> </span><span class="p">);</span>
<span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>

<span class="w"> </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="ss">&quot;Facet upgraded successfully&quot;</span><span class="p">);</span>
</code></pre></div>

<p>}</p>
<p>main()
     .then(() =&gt; process.exit(0))
     .catch(error =&gt; {
       console.error(error);
       process.exit(1);
     });
   ```</p>
<ol>
<li><strong>Adding a new facet</strong>:</li>
</ol>
<p>```javascript
   // scripts/add-facet.js
   async function main() {
     // Get signer
     const [signer] = await ethers.getSigners();</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Deploy</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">facet</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">NewFacet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ethers</span><span class="p">.</span><span class="n">getContractFactory</span><span class="p">(</span><span class="ss">&quot;NewFacet&quot;</span><span class="p">);</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">newFacet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">NewFacet</span><span class="p">.</span><span class="n">deploy</span><span class="p">();</span>
<span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">newFacet</span><span class="p">.</span><span class="n">deployed</span><span class="p">();</span>
<span class="w"> </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="ss">&quot;New facet deployed to:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">newFacet</span><span class="p">.</span><span class="n">address</span><span class="p">);</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">Get</span><span class="w"> </span><span class="n">diamond</span><span class="w"> </span><span class="n">contract</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">diamond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ethers</span><span class="p">.</span><span class="n">getContractAt</span><span class="p">(</span><span class="ss">&quot;Diamond&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DIAMOND_ADDRESS</span><span class="p">);</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">Get</span><span class="w"> </span><span class="n">selectors</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">facet</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">selectors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getSelectors</span><span class="p">(</span><span class="n">newFacet</span><span class="p">);</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">Create</span><span class="w"> </span><span class="n">facet</span><span class="w"> </span><span class="n">cut</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">facetCut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="nl">facetAddress</span><span class="p">:</span><span class="w"> </span><span class="n">newFacet</span><span class="p">.</span><span class="n">address</span><span class="p">,</span>
<span class="w">   </span><span class="k">action</span><span class="err">:</span><span class="w"> </span><span class="n">FacetCutAction</span><span class="p">.</span><span class="k">Add</span><span class="p">,</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">Add</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">facet</span>
<span class="w">   </span><span class="nl">functionSelectors</span><span class="p">:</span><span class="w"> </span><span class="n">selectors</span>
<span class="w"> </span><span class="err">}</span><span class="p">;</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Perform</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">upgrade</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">diamond</span><span class="p">.</span><span class="n">diamondCut</span><span class="p">(</span>
<span class="w">   </span><span class="o">[</span><span class="n">facetCut</span><span class="o">]</span><span class="p">,</span>
<span class="w">   </span><span class="n">ethers</span><span class="p">.</span><span class="n">constants</span><span class="p">.</span><span class="n">AddressZero</span><span class="p">,</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">No</span><span class="w"> </span><span class="n">initialization</span>
<span class="w">   </span><span class="ss">&quot;0x&quot;</span>
<span class="w"> </span><span class="p">);</span>
<span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>

<span class="w"> </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="ss">&quot;Facet added successfully&quot;</span><span class="p">);</span>
</code></pre></div>

<p>}
   ```</p>
<ol>
<li><strong>Upgrading Diamond implementation</strong>:</li>
</ol>
<p>```javascript
   // scripts/upgrade-diamond.js
   async function main() {
     // Get diamond factory
     const diamondFactory = await ethers.getContractAt("DiamondFactory", FACTORY_ADDRESS);</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">existing</span><span class="w"> </span><span class="n">diamond</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">diamond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ethers</span><span class="o">.</span><span class="n">getContractAt</span><span class="p">(</span><span class="s2">&quot;Diamond&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DIAMOND_ADDRESS</span><span class="p">);</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Deploy</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">facets</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">newFacets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">deployNewFacets</span><span class="p">();</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="n">facet</span><span class="w"> </span><span class="n">cuts</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">facetCuts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createFacetCuts</span><span class="p">(</span><span class="n">newFacets</span><span class="p">);</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">facet</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">factory</span>
<span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">diamondFactory</span><span class="o">.</span><span class="n">setFacets</span><span class="p">(</span><span class="s2">&quot;newFacetSet&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">facetCuts</span><span class="p">);</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Deploy</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">diamond</span><span class="w"> </span><span class="n">initializer</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">needed</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">diamondInit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">deployDiamondInit</span><span class="p">();</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Prepare</span><span class="w"> </span><span class="n">initialization</span><span class="w"> </span><span class="n">data</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">initData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diamondInit</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">encodeFunctionData</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">   </span><span class="o">/*</span><span class="w"> </span><span class="n">initialization</span><span class="w"> </span><span class="n">parameters</span><span class="w"> </span><span class="o">*/</span>
<span class="w"> </span><span class="p">]);</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Upgrade</span><span class="w"> </span><span class="n">diamond</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">diamond</span><span class="o">.</span><span class="n">diamondCut</span><span class="p">(</span>
<span class="w">   </span><span class="n">facetCuts</span><span class="p">,</span>
<span class="w">   </span><span class="n">diamondInit</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
<span class="w">   </span><span class="n">initData</span>
<span class="w"> </span><span class="p">);</span>
<span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">tx</span><span class="o">.</span><span class="n">wait</span><span class="p">();</span>

<span class="w"> </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Diamond upgraded successfully&quot;</span><span class="p">);</span>
</code></pre></div>

<p>}
   ```</p>
<h3 id="cloud-function-updates">Cloud Function Updates<a class="headerlink" href="#cloud-function-updates" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Updating cloud functions</strong>:</li>
</ol>
<p>```bash
   # Update cloud functions
   git pull origin main
   npm install
   npm run build</p>
<p># Restart Parse Server
   pm2 restart gemforce-server
   ```</p>
<ol>
<li><strong>Testing cloud function updates</strong>:</li>
</ol>
<p><code>javascript
   // test/cloud-functions/updated-function.test.js
   describe("Updated Cloud Function", function() {
     it("should handle new functionality", async function() {
       const result = await Parse.Cloud.run("updatedFunction", { param: "value" });
       expect(result).to.have.property("newProperty");
     });
   });</code></p>
<ol>
<li><strong>Deploying specific cloud function changes</strong>:</li>
</ol>
<p>```bash
   # Deploy specific cloud function changes
   scp dist/src/cloud-functions/specific-function.js user@server:/var/www/gemforce/dist/src/cloud-functions/</p>
<p># Restart Parse Server
   ssh user@server "cd /var/www/gemforce &amp;&amp; pm2 restart gemforce-server"
   ```</p>
<h3 id="database-schema-migrations">Database Schema Migrations<a class="headerlink" href="#database-schema-migrations" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Creating a migration</strong>:</li>
</ol>
<p>```javascript
   // migrations/1625000000000_add_new_field.js
   exports.up = async (db) =&gt; {
     // Add new field to all documents in a collection
     await db.collection('User').updateMany(
       { newField: { $exists: false } }, 
       { $set: { newField: "" } }
     );</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="c1">// Create new index</span>
<span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">collection</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">).</span><span class="n">createIndex</span><span class="p">({</span><span class="w"> </span><span class="n">newField</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">});</span>
</code></pre></div>

<p>};</p>
<p>exports.down = async (db) =&gt; {
     // Remove the field
     await db.collection('User').updateMany(
       {}, 
       { $unset: { newField: "" } }
     );</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="c1">// Remove the index</span>
<span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">collection</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">).</span><span class="n">dropIndex</span><span class="p">({</span><span class="w"> </span><span class="n">newField</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">});</span>
</code></pre></div>

<p>};
   ```</p>
<ol>
<li><strong>Running migrations</strong>:</li>
</ol>
<p>```bash
   # Run migrations
   npx migrate-mongo up</p>
<p># Check migration status
   npx migrate-mongo status
   ```</p>
<ol>
<li><strong>Rolling back migrations</strong>:</li>
</ol>
<p>```bash
   # Roll back last migration
   npx migrate-mongo down</p>
<p># Roll back to specific migration
   npx migrate-mongo down 1625000000000
   ```</p>
<h3 id="backward-compatibility-considerations">Backward Compatibility Considerations<a class="headerlink" href="#backward-compatibility-considerations" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>API versioning</strong>:</li>
</ol>
<p>```javascript
   // Example API versioning
   app.use('/api/v1', v1Routes);
   app.use('/api/v2', v2Routes);</p>
<p>// Redirect old routes
   app.use('/api/legacy/:resource', (req, res) =&gt; {
     res.redirect(<code>/api/v1/${req.params.resource}</code>);
   });
   ```</p>
<ol>
<li>
<p><strong>Smart contract compatibility</strong>:</p>
</li>
<li>
<p>Never remove storage variables</p>
</li>
<li>Add new functions rather than changing existing ones</li>
<li>Use new facets for significant changes</li>
<li>
<p>Use feature flags to control access to new features</p>
</li>
<li>
<p><strong>Client compatibility</strong>:</p>
</li>
</ol>
<p>```javascript
   // Check client version and provide appropriate response
   Parse.Cloud.define("getFeatures", async (request) =&gt; {
     const clientVersion = request.params.clientVersion;</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">semver</span>.<span class="nv">lt</span><span class="ss">(</span><span class="nv">clientVersion</span>,<span class="w"> </span><span class="s2">&quot;2.0.0&quot;</span><span class="ss">))</span><span class="w"> </span>{
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nv">legacyFeatureList</span><span class="c1">;</span>
<span class="w"> </span>}<span class="w"> </span><span class="k">else</span><span class="w"> </span>{
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nv">newFeatureList</span><span class="c1">;</span>
<span class="w"> </span>}
</code></pre></div>

<p>});
   ```</p>
<h3 id="feature-flagging">Feature Flagging<a class="headerlink" href="#feature-flagging" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Implementing feature flags</strong>:</li>
</ol>
<p>```javascript
   // Feature flag configuration
   const featureFlags = {
     newMarketplace: process.env.ENABLE_NEW_MARKETPLACE === "true",
     carbonCredits: process.env.ENABLE_CARBON_CREDITS === "true",
     nftFractionalization: process.env.ENABLE_NFT_FRACTIONALIZATION === "true"
   };</p>
<p>// Using feature flags
   Parse.Cloud.define("getMarketplace", async (request) =&gt; {
     if (featureFlags.newMarketplace) {
       return getNewMarketplace();
     } else {
       return getLegacyMarketplace();
     }
   });
   ```</p>
<ol>
<li><strong>Controlling access to new features</strong>:</li>
</ol>
<p>```javascript
   // Progressive rollout
   Parse.Cloud.define("checkFeatureAccess", async (request) =&gt; {
     const { feature, userId } = request.params;</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">enabled</span><span class="w"> </span><span class="n">globally</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">featureFlags</span><span class="o">[</span><span class="n">feature</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="nl">hasAccess</span><span class="p">:</span><span class="w"> </span><span class="k">false</span><span class="w"> </span><span class="err">}</span><span class="p">;</span>
<span class="w"> </span><span class="err">}</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">beta</span><span class="w"> </span><span class="k">group</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">Parse</span><span class="p">.</span><span class="n">Query</span><span class="p">(</span><span class="nf">Parse</span><span class="p">.</span><span class="k">User</span><span class="p">)</span>
<span class="w">   </span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="nl">useMasterKey</span><span class="p">:</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="err">}</span><span class="p">);</span>

<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">isBetaTester</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">user</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="ss">&quot;betaTester&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Calculate</span><span class="w"> </span><span class="n">percentage</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">rollout</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">rolloutPercentage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">25</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">25</span><span class="o">%</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">users</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">userIdNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseInt</span><span class="p">(</span><span class="n">userId</span><span class="p">.</span><span class="nf">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">userPercentile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userIdNumber</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="nl">hasAccess</span><span class="p">:</span><span class="w"> </span><span class="n">isBetaTester</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">userPercentile</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">rolloutPercentage</span>
<span class="w"> </span><span class="err">}</span><span class="p">;</span>
</code></pre></div>

<p>});
   ```</p>
<h2 id="rollback-procedures">Rollback Procedures<a class="headerlink" href="#rollback-procedures" title="Permanent link">&para;</a></h2>
<h3 id="smart-contract-rollbacks">Smart Contract Rollbacks<a class="headerlink" href="#smart-contract-rollbacks" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Rollback strategy for facets</strong>:</li>
</ol>
<p>```javascript
   // scripts/rollback-facet.js
   async function main() {
     // Get diamond contract
     const diamond = await ethers.getContractAt("Diamond", DIAMOND_ADDRESS);</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">Get</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">facet</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">previousFacetAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PREVIOUS_FACET_ADDRESS</span><span class="p">;</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">Get</span><span class="w"> </span><span class="n">selectors</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">facet</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">selectors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SELECTORS</span><span class="p">;</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">Create</span><span class="w"> </span><span class="n">facet</span><span class="w"> </span><span class="n">cut</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">rollback</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">facetCut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="nl">facetAddress</span><span class="p">:</span><span class="w"> </span><span class="n">previousFacetAddress</span><span class="p">,</span>
<span class="w">   </span><span class="k">action</span><span class="err">:</span><span class="w"> </span><span class="n">FacetCutAction</span><span class="p">.</span><span class="nf">Replace</span><span class="p">,</span>
<span class="w">   </span><span class="nl">functionSelectors</span><span class="p">:</span><span class="w"> </span><span class="n">selectors</span>
<span class="w"> </span><span class="err">}</span><span class="p">;</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Perform</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">rollback</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">diamond</span><span class="p">.</span><span class="n">diamondCut</span><span class="p">(</span>
<span class="w">   </span><span class="o">[</span><span class="n">facetCut</span><span class="o">]</span><span class="p">,</span>
<span class="w">   </span><span class="n">ethers</span><span class="p">.</span><span class="n">constants</span><span class="p">.</span><span class="n">AddressZero</span><span class="p">,</span>
<span class="w">   </span><span class="ss">&quot;0x&quot;</span>
<span class="w"> </span><span class="p">);</span>
<span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>

<span class="w"> </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="ss">&quot;Facet rolled back successfully&quot;</span><span class="p">);</span>
</code></pre></div>

<p>}
   ```</p>
<ol>
<li><strong>Diamond upgrade rollback</strong>:</li>
</ol>
<p>```javascript
   // scripts/rollback-diamond.js
   async function main() {
     // Get diamond factory
     const diamondFactory = await ethers.getContractAt("DiamondFactory", FACTORY_ADDRESS);</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">diamond</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">rollback</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">diamond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ethers</span><span class="o">.</span><span class="n">getContractAt</span><span class="p">(</span><span class="s2">&quot;Diamond&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DIAMOND_ADDRESS</span><span class="p">);</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="n">facet</span><span class="w"> </span><span class="n">set</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">previousFacetSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;previousFacetSet&quot;</span><span class="p">;</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">facets</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">set</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">facets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">diamondFactory</span><span class="o">.</span><span class="n">getFacets</span><span class="p">(</span><span class="n">previousFacetSet</span><span class="p">);</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Rollback</span><span class="w"> </span><span class="n">diamond</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">diamond</span><span class="o">.</span><span class="n">diamondCut</span><span class="p">(</span>
<span class="w">   </span><span class="n">facets</span><span class="p">,</span>
<span class="w">   </span><span class="n">ethers</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">AddressZero</span><span class="p">,</span>
<span class="w">   </span><span class="s2">&quot;0x&quot;</span>
<span class="w"> </span><span class="p">);</span>
<span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">tx</span><span class="o">.</span><span class="n">wait</span><span class="p">();</span>

<span class="w"> </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Diamond rolled back successfully&quot;</span><span class="p">);</span>
</code></pre></div>

<p>}
   ```</p>
<ol>
<li><strong>Emergency pause</strong>:</li>
</ol>
<p>```javascript
   // scripts/emergency-pause.js
   async function main() {
     // Get contract
     const contract = await ethers.getContractAt("PausableFacet", DIAMOND_ADDRESS);</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Pause</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">contract</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">contract</span><span class="o">.</span><span class="n">pause</span><span class="p">();</span>
<span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">tx</span><span class="o">.</span><span class="n">wait</span><span class="p">();</span>

<span class="w"> </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Contract paused successfully&quot;</span><span class="p">);</span>
</code></pre></div>

<p>}
   ```</p>
<h3 id="cloud-function-rollbacks">Cloud Function Rollbacks<a class="headerlink" href="#cloud-function-rollbacks" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Rolling back with Git</strong>:</li>
</ol>
<p>```bash
   # Rollback to previous commit
   git reset --hard HEAD~1
   npm install
   npm run build</p>
<p># Restart server
   pm2 restart gemforce-server
   ```</p>
<ol>
<li><strong>Using deployment tags</strong>:</li>
</ol>
<p>```bash
   # List tags
   git tag -l</p>
<p># Checkout specific version
   git checkout v1.2.3
   npm install
   npm run build</p>
<p># Restart server
   pm2 restart gemforce-server
   ```</p>
<ol>
<li><strong>Specific file rollback</strong>:</li>
</ol>
<p>```bash
   # Revert specific file
   git checkout HEAD~1 -- src/cloud-functions/specific-file.ts
   npm run build</p>
<p># Restart server
   pm2 restart gemforce-server
   ```</p>
<h3 id="database-rollbacks">Database Rollbacks<a class="headerlink" href="#database-rollbacks" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Restoring from backup</strong>:</li>
</ol>
<p><code>bash
   # Restore MongoDB from backup
   mongorestore --uri="mongodb://username:password@host:port/database" --drop /backup/path/YYYY-MM-DD</code></p>
<ol>
<li><strong>Rolling back a migration</strong>:</li>
</ol>
<p><code>bash
   # Roll back the last migration
   npx migrate-mongo down</code></p>
<ol>
<li><strong>Manual data correction script</strong>:</li>
</ol>
<p>```javascript
   // scripts/correct-data.js
   async function main() {
     const MongoClient = require('mongodb').MongoClient;
     const client = await MongoClient.connect(process.env.DATABASE_URI);
     const db = client.db();</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="nt">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="err">//</span><span class="w"> </span><span class="err">Correct</span><span class="w"> </span><span class="err">data</span><span class="w"> </span><span class="err">issues</span>
<span class="w">   </span><span class="err">await</span><span class="w"> </span><span class="err">db.collection(&#39;User&#39;).updateMany(</span>
<span class="w">     </span><span class="err">{</span><span class="w"> </span><span class="n">incorrectField</span><span class="p">:</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="err">$</span><span class="n">exists</span><span class="o">:</span><span class="w"> </span><span class="n">true</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="err">}</span><span class="o">,</span>
<span class="w">     </span><span class="p">{</span><span class="w"> </span><span class="err">$</span><span class="n">rename</span><span class="p">:</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="s2">&quot;incorrectField&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;correctField&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="err">}</span>
<span class="w">   </span><span class="o">);</span>

<span class="w">   </span><span class="nt">console</span><span class="p">.</span><span class="nc">log</span><span class="o">(</span><span class="s2">&quot;Data correction complete&quot;</span><span class="o">);</span>
<span class="w"> </span><span class="err">}</span><span class="w"> </span><span class="nt">catch</span><span class="w"> </span><span class="o">(</span><span class="nt">error</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="err">console.error(&quot;Error</span><span class="w"> </span><span class="err">correcting</span><span class="w"> </span><span class="n">data</span><span class="p">:</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">);</span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nt">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="err">await</span><span class="w"> </span><span class="err">client.close()</span><span class="p">;</span>
<span class="w"> </span><span class="p">}</span>
</code></pre></div>

<p>}</p>
<p>main().catch(console.error);
   ```</p>
<h3 id="emergency-procedures">Emergency Procedures<a class="headerlink" href="#emergency-procedures" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Complete service rollback</strong>:</li>
</ol>
<p>```bash
   # Emergency rollback script
   #!/bin/bash
   # scripts/emergency-rollback.sh</p>
<p># Stop the current service
   pm2 stop gemforce-server</p>
<p># Restore code from known good state
   git checkout v1.2.3
   npm install
   npm run build</p>
<p># Restore database
   mongorestore --uri="$DATABASE_URI" --drop /backups/latest</p>
<p># Restart the service
   pm2 start gemforce-server</p>
<p># Notify team
   curl -X POST -H "Content-Type: application/json" \
     -d '{"text":"Emergency rollback performed to v1.2.3"}' \
     $SLACK_WEBHOOK_URL
   ```</p>
<ol>
<li><strong>Read-only mode</strong>:</li>
</ol>
<p>```javascript
   // Enable read-only mode
   Parse.Cloud.beforeSave("*", async () =&gt; {
     if (process.env.READONLY_MODE === "true") {
       throw new Parse.Error(
         Parse.Error.OPERATION_FORBIDDEN,
         "System is currently in read-only mode for maintenance."
       );
     }
   });</p>
<p>Parse.Cloud.beforeDelete("*", async () =&gt; {
     if (process.env.READONLY_MODE === "true") {
       throw new Parse.Error(
         Parse.Error.OPERATION_FORBIDDEN,
         "System is currently in read-only mode for maintenance."
       );
     }
   });
   ```</p>
<h3 id="data-integrity-verification">Data Integrity Verification<a class="headerlink" href="#data-integrity-verification" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Verifying contract state</strong>:</li>
</ol>
<p>```javascript
   // scripts/verify-contract-state.js
   async function main() {
     // Get contract
     const contract = await ethers.getContractAt("DiamondLoupe", DIAMOND_ADDRESS);</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">facets</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">facets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">contract</span><span class="o">.</span><span class="n">facets</span><span class="p">();</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Verify</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="n">facet</span>
<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">facet</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">facets</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="err">`</span><span class="n">Verifying</span><span class="w"> </span><span class="n">facet</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">facet</span><span class="o">.</span><span class="n">facetAddress</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">facet</span><span class="w"> </span><span class="n">code</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ethers</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">getCode</span><span class="p">(</span><span class="n">facet</span><span class="o">.</span><span class="n">facetAddress</span><span class="p">);</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">empty</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">code</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;0x&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;0x0&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Error</span><span class="p">(</span><span class="err">`</span><span class="n">Facet</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">facet</span><span class="o">.</span><span class="n">facetAddress</span><span class="p">}</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">code</span><span class="o">!</span><span class="err">`</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Verify</span><span class="w"> </span><span class="n">selectors</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">facet</span><span class="o">.</span><span class="n">functionSelectors</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="k">const</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">contract</span><span class="o">.</span><span class="n">facetAddress</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="n">facet</span><span class="o">.</span><span class="n">facetAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Error</span><span class="p">(</span><span class="err">`</span><span class="n">Selector</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">selector</span><span class="p">}</span><span class="w"> </span><span class="n">points</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">wrong</span><span class="w"> </span><span class="n">facet</span><span class="o">!</span><span class="err">`</span><span class="p">);</span>
<span class="w">     </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Contract state verification successful&quot;</span><span class="p">);</span>
</code></pre></div>

<p>}</p>
<p>main().catch(console.error);
   ```</p>
<ol>
<li><strong>Database integrity check</strong>:</li>
</ol>
<p>```javascript
   // scripts/verify-database.js
   async function main() {
     const MongoClient = require('mongodb').MongoClient;
     const client = await MongoClient.connect(process.env.DATABASE_URI);
     const db = client.db();</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="n">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">collection</span><span class="w"> </span><span class="n">integrity</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">userCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">countDocuments</span><span class="p">();</span>
<span class="w">   </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="err">`</span><span class="n">User</span><span class="w"> </span><span class="n">count</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">userCount</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">duplicate</span><span class="w"> </span><span class="n">emails</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">duplicateEmails</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">([</span>
<span class="w">     </span><span class="p">{</span><span class="w"> </span><span class="o">$</span><span class="n">group</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">_id</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$email&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">$</span><span class="n">sum</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">     </span><span class="p">{</span><span class="w"> </span><span class="o">$</span><span class="k">match</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">count</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">$</span><span class="n">gt</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">   </span><span class="p">])</span><span class="o">.</span><span class="n">toArray</span><span class="p">();</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">duplicateEmails</span><span class="o">.</span><span class="n">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="err">`</span><span class="n">Found</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">duplicateEmails</span><span class="o">.</span><span class="n">length</span><span class="p">}</span><span class="w"> </span><span class="n">duplicate</span><span class="w"> </span><span class="n">emails</span><span class="o">!</span><span class="err">`</span><span class="p">);</span>
<span class="w">     </span><span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">duplicateEmails</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Verify</span><span class="w"> </span><span class="n">indexes</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">indexes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">indexes</span><span class="p">();</span>
<span class="w">   </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Indexes:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">indexes</span><span class="p">);</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">More</span><span class="w"> </span><span class="n">integrity</span><span class="w"> </span><span class="n">checks</span><span class="o">...</span>

<span class="w">   </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Database integrity check complete&quot;</span><span class="p">);</span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
<span class="w"> </span><span class="p">}</span>
</code></pre></div>

<p>}</p>
<p>main().catch(console.error);
   ```</p>
<h2 id="testing-and-verification">Testing and Verification<a class="headerlink" href="#testing-and-verification" title="Permanent link">&para;</a></h2>
<h3 id="unit-testing">Unit Testing<a class="headerlink" href="#unit-testing" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Smart contract unit tests</strong>:</li>
</ol>
<p>```javascript
   // test/unit/GemforceMinter.test.ts
   describe("GemforceMinter", function() {
     let owner, user1, user2;
     let diamond, gemforceMinter;</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="n">beforeEach</span><span class="p">(</span><span class="n">async</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="p">[</span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">user1</span><span class="p">,</span><span class="w"> </span><span class="n">user2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ethers</span><span class="o">.</span><span class="n">getSigners</span><span class="p">();</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Deploy</span><span class="w"> </span><span class="n">diamond</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">facets</span>
<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="o">...</span><span class="n">deployment</span><span class="w"> </span><span class="n">code</span>

<span class="w">   </span><span class="n">gemforceMinter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ethers</span><span class="o">.</span><span class="n">getContractAt</span><span class="p">(</span><span class="s2">&quot;GemforceMinterFacet&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">diamond</span><span class="o">.</span><span class="n">address</span><span class="p">);</span>
<span class="w"> </span><span class="p">});</span>

<span class="w"> </span><span class="n">it</span><span class="p">(</span><span class="s2">&quot;should allow owner to mint&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">     </span><span class="p">{</span><span class="w"> </span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">attributeType</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Carbon Credit&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="w">   </span><span class="p">];</span>

<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">gemforceMinter</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span><span class="o">.</span><span class="n">gemforceMint</span><span class="p">(</span><span class="n">metadata</span><span class="p">);</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">receipt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">tx</span><span class="o">.</span><span class="n">wait</span><span class="p">();</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">events</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receipt</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="n">event</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;GemforceMinted&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">expect</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">exist</span><span class="p">;</span>
<span class="w">   </span><span class="n">expect</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">tokenId</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">   </span><span class="n">expect</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">minter</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">owner</span><span class="o">.</span><span class="n">address</span><span class="p">);</span>
<span class="w"> </span><span class="p">});</span>

<span class="w"> </span><span class="n">it</span><span class="p">(</span><span class="s2">&quot;should revert when non-owner tries to mint&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">     </span><span class="p">{</span><span class="w"> </span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">attributeType</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Carbon Credit&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="w">   </span><span class="p">];</span>

<span class="w">   </span><span class="n">await</span><span class="w"> </span><span class="n">expect</span><span class="p">(</span>
<span class="w">     </span><span class="n">gemforceMinter</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">gemforceMint</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
<span class="w">   </span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">be</span><span class="o">.</span><span class="n">revertedWith</span><span class="p">(</span><span class="s2">&quot;Only contract owner&quot;</span><span class="p">);</span>
<span class="w"> </span><span class="p">});</span>
</code></pre></div>

<p>});
   ```</p>
<ol>
<li><strong>Cloud function unit tests</strong>:</li>
</ol>
<p>```javascript
   // test/unit/cloud-functions.test.js
   describe("Cloud Functions Unit Tests", function() {
     before(function() {
       // Mock Parse
       this.originalParse = global.Parse;
       global.Parse = {
         Cloud: {
           define: (name, handler) =&gt; {
             this.cloudFunctions[name] = handler;
           }
         },
         Error: {
           INVALID_PARAMS: 141
         }
       };</p>
<div class="codehilite"><pre><span></span><code><span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Load</span><span class="w"> </span><span class="n">cloud</span><span class="w"> </span><span class="n">functions</span>
<span class="w">   </span><span class="n">this</span><span class="o">.</span><span class="n">cloudFunctions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">   </span><span class="n">require</span><span class="p">(</span><span class="s2">&quot;../../src/cloud-functions/contracts&quot;</span><span class="p">);</span>
<span class="w"> </span><span class="p">});</span>

<span class="w"> </span><span class="n">after</span><span class="p">(</span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">global</span><span class="o">.</span><span class="n">Parse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">originalParse</span><span class="p">;</span>
<span class="w"> </span><span class="p">});</span>

<span class="w"> </span><span class="n">it</span><span class="p">(</span><span class="s2">&quot;should validate parameters in addDiamondFacet&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">cloudFunctions</span><span class="o">.</span><span class="n">addDiamondFacet</span><span class="p">;</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Missing</span><span class="w"> </span><span class="n">parameters</span>
<span class="w">   </span><span class="n">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">await</span><span class="w"> </span><span class="n">handler</span><span class="p">({</span><span class="w"> </span><span class="n">params</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="p">});</span>
<span class="w">     </span><span class="nb">assert</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Should have thrown an error&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">expect</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">Parse</span><span class="o">.</span><span class="n">Error</span><span class="o">.</span><span class="n">INVALID_PARAMS</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">With</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="n">parameters</span><span class="w"> </span><span class="p">(</span><span class="n">mocked</span><span class="p">)</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">mockResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">success</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span><span class="w"> </span><span class="p">};</span>
<span class="w">   </span><span class="n">this</span><span class="o">.</span><span class="n">addDiamondFacet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sinon</span><span class="o">.</span><span class="n">stub</span><span class="p">()</span><span class="o">.</span><span class="n">resolves</span><span class="p">(</span><span class="n">mockResult</span><span class="p">);</span>

<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">handler</span><span class="p">({</span>
<span class="w">     </span><span class="n">params</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="n">networkId</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
<span class="w">       </span><span class="n">diamondAddress</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0x123&quot;</span><span class="p">,</span>
<span class="w">       </span><span class="n">facetName</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;TestFacet&quot;</span>
<span class="w">     </span><span class="p">}</span>
<span class="w">   </span><span class="p">});</span>

<span class="w">   </span><span class="n">expect</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">deep</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">mockResult</span><span class="p">);</span>
<span class="w"> </span><span class="p">});</span>
</code></pre></div>

<p>});
   ```</p>
<h3 id="integration-testing">Integration Testing<a class="headerlink" href="#integration-testing" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Smart contract integration tests</strong>:</li>
</ol>
<p>```javascript
   // test/integration/marketplace-flow.test.ts
   describe("Marketplace Integration", function() {
     let owner, seller, buyer;
     let diamond, marketplace, gem, treasury;</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="n">before</span><span class="p">(</span><span class="n">async</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="p">[</span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">seller</span><span class="p">,</span><span class="w"> </span><span class="n">buyer</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ethers</span><span class="o">.</span><span class="n">getSigners</span><span class="p">();</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Deploy</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">contracts</span>
<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="o">...</span><span class="n">deployment</span><span class="w"> </span><span class="n">code</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">contract</span><span class="w"> </span><span class="n">instances</span>
<span class="w">   </span><span class="n">diamond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ethers</span><span class="o">.</span><span class="n">getContractAt</span><span class="p">(</span><span class="s2">&quot;Diamond&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">diamondAddress</span><span class="p">);</span>
<span class="w">   </span><span class="n">marketplace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ethers</span><span class="o">.</span><span class="n">getContractAt</span><span class="p">(</span><span class="s2">&quot;MarketplaceFacet&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">diamondAddress</span><span class="p">);</span>
<span class="w">   </span><span class="n">gem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ethers</span><span class="o">.</span><span class="n">getContractAt</span><span class="p">(</span><span class="s2">&quot;GemforceMinterFacet&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">diamondAddress</span><span class="p">);</span>
<span class="w">   </span><span class="n">treasury</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ethers</span><span class="o">.</span><span class="n">getContractAt</span><span class="p">(</span><span class="s2">&quot;Treasury&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">treasuryAddress</span><span class="p">);</span>
<span class="w"> </span><span class="p">});</span>

<span class="w"> </span><span class="n">it</span><span class="p">(</span><span class="s2">&quot;should support full marketplace flow&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Mint</span><span class="w"> </span><span class="n">token</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;test&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">attributeType</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value&quot;</span><span class="w"> </span><span class="p">}];</span>
<span class="w">   </span><span class="n">await</span><span class="w"> </span><span class="n">gem</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span><span class="o">.</span><span class="n">gemforceMint</span><span class="p">(</span><span class="n">metadata</span><span class="p">);</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">List</span><span class="w"> </span><span class="n">token</span>
<span class="w">   </span><span class="n">await</span><span class="w"> </span><span class="n">marketplace</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span><span class="o">.</span><span class="n">listItem</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ethers</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parseEther</span><span class="p">(</span><span class="s2">&quot;1.0&quot;</span><span class="p">));</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">listing</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">listing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">marketplace</span><span class="o">.</span><span class="n">getListing</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">   </span><span class="n">expect</span><span class="p">(</span><span class="n">listing</span><span class="o">.</span><span class="n">price</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">ethers</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parseEther</span><span class="p">(</span><span class="s2">&quot;1.0&quot;</span><span class="p">));</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Purchase</span><span class="w"> </span><span class="n">token</span>
<span class="w">   </span><span class="n">await</span><span class="w"> </span><span class="n">marketplace</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">buyer</span><span class="p">)</span><span class="o">.</span><span class="n">purchaseItem</span><span class="p">(</span><span class="n">diamondAddress</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="n">ethers</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parseEther</span><span class="p">(</span><span class="s2">&quot;1.0&quot;</span><span class="p">)</span>
<span class="w">   </span><span class="p">});</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">ownership</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">newOwner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">diamond</span><span class="o">.</span><span class="n">ownerOf</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">   </span><span class="n">expect</span><span class="p">(</span><span class="n">newOwner</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">buyer</span><span class="o">.</span><span class="n">address</span><span class="p">);</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">treasury</span><span class="w"> </span><span class="n">balance</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">treasury</span><span class="o">.</span><span class="n">getBalance</span><span class="p">();</span>
<span class="w">   </span><span class="n">expect</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">be</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w"> </span><span class="p">});</span>
</code></pre></div>

<p>});
   ```</p>
<ol>
<li><strong>API integration tests</strong>:</li>
</ol>
<p>```javascript
   // test/integration/api-flow.test.js
   describe("API Integration", function() {
     let user;</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="n">before</span><span class="p">(</span><span class="n">async</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Initialize</span><span class="w"> </span><span class="n">Parse</span>
<span class="w">   </span><span class="n">Parse</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="s2">&quot;test_app_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;test_js_key&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;test_master_key&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">Parse</span><span class="o">.</span><span class="n">serverURL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;http://localhost:1337/parse&quot;</span><span class="p">;</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">user</span>
<span class="w">   </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Parse</span><span class="o">.</span><span class="n">User</span><span class="p">();</span>
<span class="w">   </span><span class="n">user</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;test@example.com&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">user</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;password&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">user</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;test@example.com&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">await</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">signUp</span><span class="p">();</span>
<span class="w"> </span><span class="p">});</span>

<span class="w"> </span><span class="n">it</span><span class="p">(</span><span class="s2">&quot;should handle user blockchain operations&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">blockchains</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">blockchains</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">Parse</span><span class="o">.</span><span class="n">Cloud</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;loadAllBlockchains&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">expect</span><span class="p">(</span><span class="n">blockchains</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">be</span><span class="o">.</span><span class="n">an</span><span class="p">(</span><span class="s2">&quot;array&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="n">DFNS</span><span class="w"> </span><span class="n">wallet</span><span class="w"> </span><span class="p">(</span><span class="n">mocked</span><span class="p">)</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">walletResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">Parse</span><span class="o">.</span><span class="n">Cloud</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;registerInit&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">username</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">)</span>
<span class="w">   </span><span class="p">});</span>
<span class="w">   </span><span class="n">expect</span><span class="p">(</span><span class="n">walletResult</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">have</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s2">&quot;challenge&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Complete</span><span class="w"> </span><span class="n">registration</span><span class="w"> </span><span class="p">(</span><span class="n">mocked</span><span class="p">)</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">registrationResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">Parse</span><span class="o">.</span><span class="n">Cloud</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;registerComplete&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">signedChallenge</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;mocked_challenge&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="n">temporaryAuthenticationToken</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;mocked_token&quot;</span>
<span class="w">   </span><span class="p">});</span>
<span class="w">   </span><span class="n">expect</span><span class="p">(</span><span class="n">registrationResult</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">have</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s2">&quot;token&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">List</span><span class="w"> </span><span class="n">wallets</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">wallets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">Parse</span><span class="o">.</span><span class="n">Cloud</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;listWallets&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">authToken</span><span class="p">:</span><span class="w"> </span><span class="n">registrationResult</span><span class="o">.</span><span class="n">token</span>
<span class="w">   </span><span class="p">});</span>
<span class="w">   </span><span class="n">expect</span><span class="p">(</span><span class="n">wallets</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">have</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s2">&quot;wallets&quot;</span><span class="p">);</span>
<span class="w"> </span><span class="p">});</span>
</code></pre></div>

<p>});
   ```</p>
<h3 id="contract-verification_1">Contract Verification<a class="headerlink" href="#contract-verification_1" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Verifying contracts on block explorer</strong>:</li>
</ol>
<p>```bash
   # Verify contract on Etherscan or Basescan
   npx hardhat verify --network baseSepolia <CONTRACT_ADDRESS> <CONSTRUCTOR_ARGS></p>
<p># Verify contract with libraries
   npx hardhat verify --network baseSepolia <CONTRACT_ADDRESS> <CONSTRUCTOR_ARGS> \
     --libraries Library1=0x123... Library2=0x456...
   ```</p>
<ol>
<li><strong>Automated verification script</strong>:</li>
</ol>
<p>```javascript
   // scripts/verify-contracts.js
   async function main() {
     // Get deployment data
     const deployments = require('../deployments.json');
     const network = process.env.NETWORK || 'baseSepolia';
     const networkId = hre.config.networks[network].chainId;</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Verify</span><span class="w"> </span><span class="n">Diamond</span><span class="w"> </span><span class="n">contract</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">diamondAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deployments</span><span class="o">[</span><span class="n">networkId</span><span class="o">]</span><span class="p">.</span><span class="n">diamondAddress</span><span class="p">;</span>
<span class="w"> </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="err">`</span><span class="n">Verifying</span><span class="w"> </span><span class="n">Diamond</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="err">${</span><span class="n">diamondAddress</span><span class="err">}`</span><span class="p">);</span>

<span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="n">await</span><span class="w"> </span><span class="n">hre</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="ss">&quot;verify:verify&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">{</span>
<span class="w">     </span><span class="nl">address</span><span class="p">:</span><span class="w"> </span><span class="n">diamondAddress</span><span class="p">,</span>
<span class="w">     </span><span class="nl">constructorArguments</span><span class="p">:</span><span class="w"> </span><span class="err">[]</span>
<span class="w">   </span><span class="err">}</span><span class="p">);</span>
<span class="w"> </span><span class="err">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="err">`</span><span class="n">Error</span><span class="w"> </span><span class="n">verifying</span><span class="w"> </span><span class="nl">Diamond</span><span class="p">:</span><span class="w"> </span><span class="err">${</span><span class="n">e</span><span class="p">.</span><span class="n">message</span><span class="err">}`</span><span class="p">);</span>
<span class="w"> </span><span class="err">}</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Verify</span><span class="w"> </span><span class="n">Facets</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">facets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deployments</span><span class="o">[</span><span class="n">networkId</span><span class="o">]</span><span class="p">.</span><span class="n">facets</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="err">[]</span><span class="p">;</span>
<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">const</span><span class="w"> </span><span class="n">facet</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">facets</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="err">`</span><span class="n">Verifying</span><span class="w"> </span><span class="n">facet</span><span class="w"> </span><span class="err">${</span><span class="n">facet</span><span class="p">.</span><span class="n">name</span><span class="err">}</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="err">${</span><span class="n">facet</span><span class="p">.</span><span class="n">address</span><span class="err">}`</span><span class="p">);</span>

<span class="w">   </span><span class="k">try</span><span class="w"> </span><span class="err">{</span>
<span class="w">     </span><span class="n">await</span><span class="w"> </span><span class="n">hre</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="ss">&quot;verify:verify&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">{</span>
<span class="w">       </span><span class="nl">address</span><span class="p">:</span><span class="w"> </span><span class="n">facet</span><span class="p">.</span><span class="n">address</span><span class="p">,</span>
<span class="w">       </span><span class="nl">constructorArguments</span><span class="p">:</span><span class="w"> </span><span class="err">[]</span>
<span class="w">     </span><span class="err">}</span><span class="p">);</span>
<span class="w">   </span><span class="err">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">     </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="err">`</span><span class="n">Error</span><span class="w"> </span><span class="n">verifying</span><span class="w"> </span><span class="err">${</span><span class="n">facet</span><span class="p">.</span><span class="n">name</span><span class="err">}:</span><span class="w"> </span><span class="err">${</span><span class="n">e</span><span class="p">.</span><span class="n">message</span><span class="err">}`</span><span class="p">);</span>
<span class="w">   </span><span class="err">}</span>
<span class="w"> </span><span class="err">}</span>
</code></pre></div>

<p>}</p>
<p>main().catch(console.error);
   ```</p>
<h3 id="load-testing">Load Testing<a class="headerlink" href="#load-testing" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Smart contract load testing</strong>:</li>
</ol>
<p>```javascript
   // test/load/contract-load.test.js
   describe("Contract Load Test", function() {
     // Increase timeout for load tests
     this.timeout(300000);</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="n">let</span><span class="w"> </span><span class="n">diamond</span><span class="p">,</span><span class="w"> </span><span class="n">minter</span><span class="p">;</span>
<span class="w"> </span><span class="n">let</span><span class="w"> </span><span class="n">signers</span><span class="p">;</span>

<span class="w"> </span><span class="n">before</span><span class="p">(</span><span class="n">async</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">signers</span>
<span class="w">   </span><span class="n">signers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ethers</span><span class="o">.</span><span class="n">getSigners</span><span class="p">();</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Deploy</span><span class="w"> </span><span class="n">contracts</span>
<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="o">...</span><span class="n">deployment</span><span class="w"> </span><span class="n">code</span>

<span class="w">   </span><span class="n">diamond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ethers</span><span class="o">.</span><span class="n">getContractAt</span><span class="p">(</span><span class="s2">&quot;Diamond&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">diamondAddress</span><span class="p">);</span>
<span class="w">   </span><span class="n">minter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ethers</span><span class="o">.</span><span class="n">getContractAt</span><span class="p">(</span><span class="s2">&quot;GemforceMinterFacet&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">diamondAddress</span><span class="p">);</span>
<span class="w"> </span><span class="p">});</span>

<span class="w"> </span><span class="n">it</span><span class="p">(</span><span class="s2">&quot;should handle concurrent minting&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">concurrentMints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">mintPromises</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="n">concurrent</span><span class="w"> </span><span class="n">mint</span><span class="w"> </span><span class="n">operations</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">concurrentMints</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="k">const</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">attributeType</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="err">`</span><span class="n">Token</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">i</span><span class="p">}</span><span class="err">`</span><span class="w"> </span><span class="p">},</span>
<span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">attributeType</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="n">i</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span><span class="w"> </span><span class="p">}</span>
<span class="w">     </span><span class="p">];</span>

<span class="w">     </span><span class="n">mintPromises</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">minter</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">signers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">gemforceMint</span><span class="p">(</span><span class="n">metadata</span><span class="p">));</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Wait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">mints</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">complete</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">Promise</span><span class="o">.</span><span class="n">allSettled</span><span class="p">(</span><span class="n">mintPromises</span><span class="p">);</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Count</span><span class="w"> </span><span class="n">successful</span><span class="w"> </span><span class="n">mints</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">successfulMints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">results</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;fulfilled&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">length</span><span class="p">;</span>
<span class="w">   </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="err">`</span><span class="n">Successfully</span><span class="w"> </span><span class="n">minted</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">successfulMints</span><span class="p">}</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">concurrentMints</span><span class="p">}</span><span class="w"> </span><span class="n">tokens</span><span class="err">`</span><span class="p">);</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Analyze</span><span class="w"> </span><span class="n">failures</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">failures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">results</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;rejected&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">failure</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">failures</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="err">`</span><span class="n">Failure</span><span class="w"> </span><span class="n">reason</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">failure</span><span class="o">.</span><span class="n">reason</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">expect</span><span class="p">(</span><span class="n">successfulMints</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">be</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w"> </span><span class="p">});</span>
</code></pre></div>

<p>});
   ```</p>
<ol>
<li><strong>API load testing with Artillery</strong>:</li>
</ol>
<p>```yaml
   # load-tests/api-load.yml
   config:
     target: "https://api.gemforce.com"
     phases:
       - duration: 60
         arrivalRate: 5
         rampTo: 50
         name: "Warm up phase"
       - duration: 120
         arrivalRate: 50
         name: "Sustained load"
       - duration: 60
         arrivalRate: 50
         rampTo: 100
         name: "Peak load"
     defaults:
       headers:
         X-Parse-Application-Id: "{{APP_ID}}"
         Content-Type: "application/json"</p>
<p>scenarios:
     - name: "Load test API endpoints"
       flow:
         - post:
             url: "/parse/functions/loadAllBlockchains"
             json: {}
             expect:
               - statusCode: 200
         - post:
             url: "/parse/functions/loadProviderUrl"
             json:
               networkId: "84532"
             expect:
               - statusCode: 200
         - post:
             url: "/parse/functions/loadSmartContractsForNetwork"
             json:
               networkId: "84532"
             expect:
               - statusCode: 200
   ```</p>
<p>Run with:</p>
<p><code>bash
   npx artillery run load-tests/api-load.yml --environment production</code></p>
<h3 id="security-testing">Security Testing<a class="headerlink" href="#security-testing" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Smart contract security testing</strong>:</li>
</ol>
<p>```bash
   # Run Slither security analyzer
   slither contracts/</p>
<p># Run Mythril
   myth analyze contracts/Diamond.sol
   ```</p>
<ol>
<li><strong>Penetration testing for API</strong>:</li>
</ol>
<p><code>bash
   # Run OWASP ZAP scan
   zap-cli quick-scan -s xss,sqli -r report.html https://api.gemforce.com</code></p>
<ol>
<li><strong>Authentication security tests</strong>:</li>
</ol>
<p>```javascript
   // test/security/auth.test.js
   describe("Authentication Security", function() {
     it("should reject invalid authentication", async function() {
       // Try with invalid app ID
       try {
         Parse.initialize("invalid_app_id", "test_js_key");
         await Parse.Cloud.run("loadAllBlockchains");
         assert.fail("Should have thrown an error");
       } catch (e) {
         expect(e.code).to.equal(Parse.Error.INVALID_APP_ID);
       }</p>
<div class="codehilite"><pre><span></span><code><span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Try</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="k">master</span><span class="w"> </span><span class="n">key</span>
<span class="w">   </span><span class="n">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">Parse</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="s2">&quot;test_app_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;test_js_key&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;invalid_master_key&quot;</span><span class="p">);</span>
<span class="w">     </span><span class="k">const</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Parse</span><span class="o">.</span><span class="n">User</span><span class="p">();</span>
<span class="w">     </span><span class="n">await</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">fetch</span><span class="p">({</span><span class="w"> </span><span class="n">useMasterKey</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span><span class="w"> </span><span class="p">});</span>
<span class="w">     </span><span class="nb">assert</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Should have thrown an error&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">expect</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">Parse</span><span class="o">.</span><span class="n">Error</span><span class="o">.</span><span class="n">INVALID_MASTER_KEY</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w"> </span><span class="p">});</span>
</code></pre></div>

<p>});
   ```</p>
<h2 id="network-management">Network Management<a class="headerlink" href="#network-management" title="Permanent link">&para;</a></h2>
<h3 id="blockchain-node-management">Blockchain Node Management<a class="headerlink" href="#blockchain-node-management" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Connecting to blockchain nodes</strong>:</li>
</ol>
<p>```javascript
   // src/lib/blockchain.js
   const { ethers } = require("ethers");</p>
<p>// Get provider for network
   function getProvider(networkId) {
     const networks = {
       "1": process.env.ETH_NODE_URI_MAINNET,
       "84532": process.env.ETH_NODE_URI_BASESEP
     };</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">nodeUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">networks</span><span class="o">[</span><span class="n">networkId</span><span class="o">]</span><span class="p">;</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">nodeUrl</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Error</span><span class="p">(</span><span class="err">`</span><span class="k">No</span><span class="w"> </span><span class="n">RPC</span><span class="w"> </span><span class="n">endpoint</span><span class="w"> </span><span class="n">configured</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="err">${</span><span class="n">networkId</span><span class="err">}`</span><span class="p">);</span>
<span class="w"> </span><span class="err">}</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ethers</span><span class="p">.</span><span class="n">providers</span><span class="p">.</span><span class="n">JsonRpcProvider</span><span class="p">(</span><span class="n">nodeUrl</span><span class="p">);</span>
</code></pre></div>

<p>}</p>
<p>// Get WebSocket provider for network
   function getWebSocketProvider(networkId) {
     const networks = {
       "1": process.env.ETH_WSS_URI_MAINNET,
       "84532": process.env.ETH_WSS_URI_BASESEP
     };</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">nodeUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">networks</span><span class="o">[</span><span class="n">networkId</span><span class="o">]</span><span class="p">;</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">nodeUrl</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Error</span><span class="p">(</span><span class="err">`</span><span class="k">No</span><span class="w"> </span><span class="n">WebSocket</span><span class="w"> </span><span class="n">endpoint</span><span class="w"> </span><span class="n">configured</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="err">${</span><span class="n">networkId</span><span class="err">}`</span><span class="p">);</span>
<span class="w"> </span><span class="err">}</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ethers</span><span class="p">.</span><span class="n">providers</span><span class="p">.</span><span class="n">WebSocketProvider</span><span class="p">(</span><span class="n">nodeUrl</span><span class="p">);</span>
</code></pre></div>

<p>}</p>
<p>module.exports = {
     getProvider,
     getWebSocketProvider
   };
   ```</p>
<ol>
<li><strong>Monitoring node health</strong>:</li>
</ol>
<p>```javascript
   // src/lib/node-monitor.js
   const { getProvider } = require("./blockchain");</p>
<p>async function checkNodeHealth(networkId) {
     try {
       const provider = getProvider(networkId);</p>
<div class="codehilite"><pre><span></span><code><span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">responding</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">blockNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">provider</span><span class="o">.</span><span class="n">getBlockNumber</span><span class="p">();</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">synced</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">syncStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">provider</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;eth_syncing&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[]);</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">isSynced</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">syncStatus</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="n">ID</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">chainId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">provider</span><span class="o">.</span><span class="n">getNetwork</span><span class="p">()</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">net</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">net</span><span class="o">.</span><span class="n">chainId</span><span class="p">);</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">isCorrectChain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chainId</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">networkId</span><span class="p">;</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">peers</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">peerCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">provider</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;net_peerCount&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[]);</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">peers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseInt</span><span class="p">(</span><span class="n">peerCount</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">hasPeers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">peers</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">isHealthy</span><span class="p">:</span><span class="w"> </span><span class="n">isSynced</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isCorrectChain</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">hasPeers</span><span class="p">,</span>
<span class="w">     </span><span class="n">blockNumber</span><span class="p">,</span>
<span class="w">     </span><span class="n">isSynced</span><span class="p">,</span>
<span class="w">     </span><span class="n">isCorrectChain</span><span class="p">,</span>
<span class="w">     </span><span class="n">peers</span>
<span class="w">   </span><span class="p">};</span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">isHealthy</span><span class="p">:</span><span class="w"> </span><span class="bp">false</span><span class="p">,</span>
<span class="w">     </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="n">error</span><span class="o">.</span><span class="n">message</span>
<span class="w">   </span><span class="p">};</span>
<span class="w"> </span><span class="p">}</span>
</code></pre></div>

<p>}
   ```</p>
<ol>
<li><strong>Node failover</strong>:</li>
</ol>
<p>```javascript
   // src/lib/node-failover.js
   const { ethers } = require("ethers");</p>
<p>class FailoverProvider extends ethers.providers.StaticJsonRpcProvider {
     constructor(urls, network) {
       super(urls[0], network);
       this.urls = urls;
       this.currentUrlIndex = 0;
     }</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span>async<span class="w"> </span>send(method,<span class="w"> </span>params)<span class="w"> </span>{
<span class="w">   </span>try<span class="w"> </span>{
<span class="w">     </span>return<span class="w"> </span>await<span class="w"> </span>super.send(method,<span class="w"> </span>params);
<span class="w">   </span>}<span class="w"> </span>catch<span class="w"> </span>(error)<span class="w"> </span>{
<span class="w">     </span>//<span class="w"> </span>Try<span class="w"> </span>failover
<span class="w">     </span>if<span class="w"> </span>(this.urls.length<span class="w"> </span>&gt;<span class="w"> </span>1)<span class="w"> </span>{
<span class="w">       </span>this.currentUrlIndex<span class="w"> </span>=<span class="w"> </span>(this.currentUrlIndex<span class="w"> </span>+<span class="w"> </span>1)<span class="w"> </span>%<span class="w"> </span>this.urls.length;
<span class="w">       </span>this.connection.url<span class="w"> </span>=<span class="w"> </span>this.urls[this.currentUrlIndex];
<span class="w">       </span>console.log(`Failing<span class="w"> </span>over<span class="w"> </span>to<span class="w"> </span><span class="cp">${</span><span class="n">this</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">url</span><span class="cp">}</span>`);
<span class="w">       </span>return<span class="w"> </span>await<span class="w"> </span>super.send(method,<span class="w"> </span>params);
<span class="w">     </span>}
<span class="w">     </span>throw<span class="w"> </span>error;
<span class="w">   </span>}
<span class="w"> </span>}
</code></pre></div>

<p>}</p>
<p>function getFailoverProvider(networkId) {
     const networks = {
       "1": [
         process.env.ETH_NODE_URI_MAINNET_1,
         process.env.ETH_NODE_URI_MAINNET_2,
         process.env.ETH_NODE_URI_MAINNET_3
       ],
       "84532": [
         process.env.ETH_NODE_URI_BASESEP_1,
         process.env.ETH_NODE_URI_BASESEP_2
       ]
     };</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">urls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">networks</span><span class="o">[</span><span class="n">networkId</span><span class="o">]</span><span class="p">.</span><span class="k">filter</span><span class="p">(</span><span class="k">Boolean</span><span class="p">);</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">urls</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Error</span><span class="p">(</span><span class="err">`</span><span class="k">No</span><span class="w"> </span><span class="n">RPC</span><span class="w"> </span><span class="n">endpoints</span><span class="w"> </span><span class="n">configured</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="err">${</span><span class="n">networkId</span><span class="err">}`</span><span class="p">);</span>
<span class="w"> </span><span class="err">}</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FailoverProvider</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span><span class="w"> </span><span class="n">parseInt</span><span class="p">(</span><span class="n">networkId</span><span class="p">));</span>
</code></pre></div>

<p>}
   ```</p>
<h3 id="rpc-endpoint-configuration">RPC Endpoint Configuration<a class="headerlink" href="#rpc-endpoint-configuration" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Configuration file for RPC endpoints</strong>:</li>
</ol>
<p><code>javascript
   // config/networks.js
   module.exports = {
     mainnet: {
       chainId: 1,
       name: "Ethereum Mainnet",
       rpcEndpoints: [
         {
           url: process.env.ETH_NODE_URI_MAINNET_1,
           provider: "Infura",
           weight: 10
         },
         {
           url: process.env.ETH_NODE_URI_MAINNET_2,
           provider: "Alchemy",
           weight: 5
         },
         {
           url: process.env.ETH_NODE_URI_MAINNET_3,
           provider: "Custom",
           weight: 1
         }
       ],
       wsEndpoints: [
         {
           url: process.env.ETH_WSS_URI_MAINNET,
           provider: "Infura"
         }
       ],
       explorerUrl: "https://etherscan.io"
     },
     baseSepolia: {
       chainId: 84532,
       name: "Base Sepolia",
       rpcEndpoints: [
         {
           url: process.env.ETH_NODE_URI_BASESEP_1,
           provider: "Base",
           weight: 10
         },
         {
           url: process.env.ETH_NODE_URI_BASESEP_2,
           provider: "Alchemy",
           weight: 5
         }
       ],
       wsEndpoints: [
         {
           url: process.env.ETH_WSS_URI_BASESEP,
           provider: "Base"
         }
       ],
       explorerUrl: "https://sepolia.basescan.org"
     }
   };</code></p>
<ol>
<li><strong>RPC endpoint selection logic</strong>:</li>
</ol>
<p>```javascript
   // src/lib/rpc-manager.js
   const networks = require("../../config/networks");</p>
<p>function selectRpcEndpoint(networkId) {
     const network = Object.values(networks).find(n =&gt; n.chainId === parseInt(networkId));
     if (!network) {
       throw new Error(<code>Network ${networkId} not found in configuration</code>);
     }</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">weighted</span><span class="w"> </span><span class="n">selection</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">endpoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">network</span><span class="o">.</span><span class="n">rpcEndpoints</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="n">url</span><span class="p">);</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">endpoints</span><span class="o">.</span><span class="n">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Error</span><span class="p">(</span><span class="err">`</span><span class="n">No</span><span class="w"> </span><span class="n">RPC</span><span class="w"> </span><span class="n">endpoints</span><span class="w"> </span><span class="n">configured</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">networkId</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Simple</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">selection</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">now</span>
<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Could</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">expanded</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">performance</span><span class="w"> </span><span class="n">metrics</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">complex</span><span class="w"> </span><span class="n">selection</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">totalWeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">endpoints</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">sum</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w"> </span><span class="n">let</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">totalWeight</span><span class="p">;</span>

<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">endpoint</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">endpoints</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">random</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">endpoint</span><span class="o">.</span><span class="n">weight</span><span class="p">;</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">random</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="n">endpoint</span><span class="o">.</span><span class="n">url</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Fallback</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="n">endpoint</span>
<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">url</span><span class="p">;</span>
</code></pre></div>

<p>}
   ```</p>
<ol>
<li><strong>Environment-specific configuration</strong>:</li>
</ol>
<p>```javascript
   // src/lib/network-config.js
   const networks = require("../../config/networks");</p>
<p>function getNetworkConfig(networkId, environment = process.env.NODE_ENV) {
     const network = Object.values(networks).find(n =&gt; n.chainId === parseInt(networkId));
     if (!network) {
       throw new Error(<code>Network ${networkId} not found in configuration</code>);
     }</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Apply</span><span class="w"> </span><span class="n">environment</span><span class="o">-</span><span class="k">specific</span><span class="w"> </span><span class="n">overrides</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">envOverrides</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="nl">development</span><span class="p">:</span><span class="w"> </span><span class="err">{</span>
<span class="w">     </span><span class="nl">rpcEndpoints</span><span class="p">:</span><span class="w"> </span><span class="o">[</span>
<span class="n">       { url: &quot;http://localhost:8545&quot;, provider: &quot;Local&quot;, weight: 100 }</span>
<span class="n">     </span><span class="o">]</span>
<span class="w">   </span><span class="err">}</span><span class="p">,</span>
<span class="w">   </span><span class="nl">test</span><span class="p">:</span><span class="w"> </span><span class="err">{</span>
<span class="w">     </span><span class="o">//</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">might</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">special</span><span class="w"> </span><span class="n">endpoints</span>
<span class="w">   </span><span class="err">}</span><span class="p">,</span>
<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">production</span><span class="w"> </span><span class="n">uses</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">configuration</span>
<span class="w"> </span><span class="err">}</span><span class="p">;</span>

<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">envOverrides</span><span class="o">[</span><span class="n">environment</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="err">{</span>
<span class="w">     </span><span class="p">...</span><span class="n">network</span><span class="p">,</span>
<span class="w">     </span><span class="p">...</span><span class="n">envOverrides</span><span class="o">[</span><span class="n">environment</span><span class="o">]</span>
<span class="w">   </span><span class="err">}</span><span class="p">;</span>
<span class="w"> </span><span class="err">}</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">network</span><span class="p">;</span>
</code></pre></div>

<p>}
   ```</p>
<h3 id="transaction-monitoring">Transaction Monitoring<a class="headerlink" href="#transaction-monitoring" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Monitoring transaction status</strong>:</li>
</ol>
<p>```javascript
   // src/lib/transaction-monitor.js
   const { getProvider } = require("./blockchain");
   const db = require("./db");</p>
<p>async function monitorTransaction(txHash, networkId) {
     const provider = getProvider(networkId);</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="c1">// Store the transaction in the database</span>
<span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">collection</span><span class="p">(</span><span class="s">&quot;Transaction&quot;</span><span class="p">).</span><span class="n">insertOne</span><span class="p">({</span>
<span class="w">   </span><span class="n">hash</span><span class="p">:</span><span class="w"> </span><span class="n">txHash</span><span class="p">,</span>
<span class="w">   </span><span class="n">networkId</span><span class="p">,</span>
<span class="w">   </span><span class="n">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;pending&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="n">createdAt</span><span class="p">:</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Date</span><span class="p">(),</span>
<span class="w">   </span><span class="n">attempts</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w"> </span><span class="p">});</span>

<span class="w"> </span><span class="c1">// Get initial transaction receipt</span>
<span class="w"> </span><span class="n">let</span><span class="w"> </span><span class="n">receipt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">provider</span><span class="p">.</span><span class="n">getTransactionReceipt</span><span class="p">(</span><span class="n">txHash</span><span class="p">);</span>

<span class="w"> </span><span class="c1">// Transaction is still pending</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>!<span class="n">receipt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="c1">// Schedule check for later</span>
<span class="w">   </span><span class="n">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">checkTransaction</span><span class="p">(</span><span class="n">txHash</span><span class="p">,</span><span class="w"> </span><span class="n">networkId</span><span class="p">),</span><span class="w"> </span><span class="mi">15000</span><span class="p">);</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;pending&quot;</span><span class="w"> </span><span class="p">};</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="c1">// Transaction is mined</span>
<span class="w"> </span><span class="n">updateTransactionStatus</span><span class="p">(</span><span class="n">txHash</span><span class="p">,</span><span class="w"> </span><span class="n">receipt</span><span class="p">);</span>
<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">status</span><span class="p">:</span><span class="w"> </span><span class="n">receipt</span><span class="p">.</span><span class="n">status</span><span class="w"> </span>?<span class="w"> </span><span class="s">&quot;confirmed&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;failed&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="n">receipt</span>
<span class="w"> </span><span class="p">};</span>
</code></pre></div>

<p>}</p>
<p>async function checkTransaction(txHash, networkId) {
     try {
       const provider = getProvider(networkId);
       const receipt = await provider.getTransactionReceipt(txHash);</p>
<div class="codehilite"><pre><span></span><code><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">receipt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="o">//</span><span class="w"> </span><span class="n">Still</span><span class="w"> </span><span class="n">pending</span><span class="p">,</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">it</span><span class="s1">&#39;s been too long</span>
<span class="w">     </span><span class="k">const</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s2">&quot;Transaction&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">findOne</span><span class="p">({</span><span class="w"> </span><span class="nb">hash</span><span class="p">:</span><span class="w"> </span><span class="n">txHash</span><span class="w"> </span><span class="p">});</span>
<span class="w">     </span><span class="k">const</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tx</span><span class="o">.</span><span class="n">createdAt</span><span class="o">.</span><span class="n">getTime</span><span class="p">();</span>
<span class="w">     </span><span class="k">const</span><span class="w"> </span><span class="n">attempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tx</span><span class="o">.</span><span class="n">attempts</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">     </span><span class="n">await</span><span class="w"> </span><span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s2">&quot;Transaction&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">updateOne</span><span class="p">(</span>
<span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="nb">hash</span><span class="p">:</span><span class="w"> </span><span class="n">txHash</span><span class="w"> </span><span class="p">},</span>
<span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="o">$</span><span class="n">set</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">attempts</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="o">$</span><span class="n">currentDate</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">lastChecked</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">     </span><span class="p">);</span>

<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">age</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">3600000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">hour</span>
<span class="w">       </span><span class="o">//</span><span class="w"> </span><span class="n">Transaction</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">pending</span><span class="w"> </span><span class="n">too</span><span class="w"> </span><span class="n">long</span>
<span class="w">       </span><span class="n">await</span><span class="w"> </span><span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s2">&quot;Transaction&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">updateOne</span><span class="p">(</span>
<span class="w">         </span><span class="p">{</span><span class="w"> </span><span class="nb">hash</span><span class="p">:</span><span class="w"> </span><span class="n">txHash</span><span class="w"> </span><span class="p">},</span>
<span class="w">         </span><span class="p">{</span><span class="w"> </span><span class="o">$</span><span class="n">set</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;stalled&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">       </span><span class="p">);</span>
<span class="w">       </span><span class="o">//</span><span class="w"> </span><span class="n">Could</span><span class="w"> </span><span class="n">notify</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">admin</span><span class="w"> </span><span class="n">here</span>
<span class="w">     </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="o">//</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">again</span><span class="w"> </span><span class="n">later</span>
<span class="w">       </span><span class="n">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">checkTransaction</span><span class="p">(</span><span class="n">txHash</span><span class="p">,</span><span class="w"> </span><span class="n">networkId</span><span class="p">),</span><span class="w"> </span><span class="mi">30000</span><span class="p">);</span>
<span class="w">     </span><span class="p">}</span>
<span class="w">     </span><span class="k">return</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Transaction</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">mined</span><span class="p">,</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="n">status</span>
<span class="w">   </span><span class="n">updateTransactionStatus</span><span class="p">(</span><span class="n">txHash</span><span class="p">,</span><span class="w"> </span><span class="n">receipt</span><span class="p">);</span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="err">`</span><span class="n">Error</span><span class="w"> </span><span class="n">checking</span><span class="w"> </span><span class="n">transaction</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">txHash</span><span class="p">}:</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">);</span>
<span class="w"> </span><span class="p">}</span>
</code></pre></div>

<p>}</p>
<p>async function updateTransactionStatus(txHash, receipt) {
     const status = receipt.status ? "confirmed" : "failed";</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="nt">await</span><span class="w"> </span><span class="nt">db</span><span class="p">.</span><span class="nc">collection</span><span class="o">(</span><span class="s2">&quot;Transaction&quot;</span><span class="o">)</span><span class="p">.</span><span class="nc">updateOne</span><span class="o">(</span>
<span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="n">hash</span><span class="p">:</span><span class="w"> </span><span class="n">txHash</span><span class="w"> </span><span class="p">}</span><span class="o">,</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">     </span><span class="err">$</span><span class="n">set</span><span class="p">:</span><span class="w"> </span><span class="err">{</span>
<span class="w">       </span><span class="n">status</span><span class="p">,</span>
<span class="w">       </span><span class="n">blockNumber</span><span class="o">:</span><span class="w"> </span><span class="n">receipt</span><span class="o">.</span><span class="n">blockNumber</span><span class="p">,</span>
<span class="w">       </span><span class="n">gasUsed</span><span class="o">:</span><span class="w"> </span><span class="n">receipt</span><span class="o">.</span><span class="n">gasUsed</span><span class="o">.</span><span class="nf">toString</span><span class="p">(),</span>
<span class="w">       </span><span class="n">effectiveGasPrice</span><span class="o">:</span><span class="w"> </span><span class="n">receipt</span><span class="o">.</span><span class="n">effectiveGasPrice</span><span class="o">.</span><span class="nf">toString</span><span class="p">()</span>
<span class="w">     </span><span class="p">}</span>
<span class="w">   </span><span class="err">}</span>
<span class="w"> </span><span class="o">);</span>
</code></pre></div>

<p>}
   ```</p>
<ol>
<li><strong>Transaction event listener</strong>:</li>
</ol>
<p>```javascript
   // src/lib/event-listener.js
   const { getWebSocketProvider } = require("./blockchain");
   const db = require("./db");</p>
<p>class TransactionEventListener {
     constructor(networkId) {
       this.networkId = networkId;
       this.provider = getWebSocketProvider(networkId);
       this.contracts = new Map();
     }</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="n">addContract</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">abi</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">contract</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">ethers</span><span class="o">.</span><span class="n">Contract</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">abi</span><span class="p">,</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">provider</span><span class="p">);</span>
<span class="w">   </span><span class="n">this</span><span class="o">.</span><span class="n">contracts</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">contract</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="p">});</span>

<span class="w">   </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="err">`</span><span class="n">Added</span><span class="w"> </span><span class="n">contract</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">name</span><span class="p">}</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">address</span><span class="p">}</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="n">monitoring</span><span class="err">`</span><span class="p">);</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">contract</span><span class="p">;</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="n">startListening</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Listen</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">blocks</span>
<span class="w">   </span><span class="n">this</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;block&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">handleNewBlock</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">this</span><span class="p">));</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Listen</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">specific</span><span class="w"> </span><span class="n">events</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="n">contract</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="p">[</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">contract</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="p">}]</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">contracts</span><span class="o">.</span><span class="n">entries</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">contract</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">...</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">       </span><span class="n">this</span><span class="o">.</span><span class="n">handleContractEvent</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">);</span>
<span class="w">     </span><span class="p">});</span>
<span class="w">   </span><span class="p">}</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">handleNewBlock</span><span class="p">(</span><span class="n">blockNumber</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="err">`</span><span class="n">New</span><span class="w"> </span><span class="n">block</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">blockNumber</span><span class="p">}</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">this</span><span class="o">.</span><span class="n">networkId</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">pending</span><span class="w"> </span><span class="n">transactions</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">pendingTxs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s2">&quot;Transaction&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">({</span>
<span class="w">     </span><span class="n">networkId</span><span class="p">:</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">networkId</span><span class="p">,</span>
<span class="w">     </span><span class="n">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pending&quot;</span>
<span class="w">   </span><span class="p">})</span><span class="o">.</span><span class="n">toArray</span><span class="p">();</span>

<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">pendingTxs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">receipt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">getTransactionReceipt</span><span class="p">(</span><span class="n">tx</span><span class="o">.</span><span class="n">hash</span><span class="p">);</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receipt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">const</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receipt</span><span class="o">.</span><span class="n">status</span><span class="w"> </span><span class="err">?</span><span class="w"> </span><span class="s2">&quot;confirmed&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;failed&quot;</span><span class="p">;</span>

<span class="w">         </span><span class="n">await</span><span class="w"> </span><span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s2">&quot;Transaction&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">updateOne</span><span class="p">(</span>
<span class="w">           </span><span class="p">{</span><span class="w"> </span><span class="nb">hash</span><span class="p">:</span><span class="w"> </span><span class="n">tx</span><span class="o">.</span><span class="n">hash</span><span class="w"> </span><span class="p">},</span>
<span class="w">           </span><span class="p">{</span>
<span class="w">             </span><span class="o">$</span><span class="n">set</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="n">status</span><span class="p">,</span>
<span class="w">               </span><span class="n">blockNumber</span><span class="p">:</span><span class="w"> </span><span class="n">receipt</span><span class="o">.</span><span class="n">blockNumber</span><span class="p">,</span>
<span class="w">               </span><span class="n">gasUsed</span><span class="p">:</span><span class="w"> </span><span class="n">receipt</span><span class="o">.</span><span class="n">gasUsed</span><span class="o">.</span><span class="n">toString</span><span class="p">(),</span>
<span class="w">               </span><span class="n">effectiveGasPrice</span><span class="p">:</span><span class="w"> </span><span class="n">receipt</span><span class="o">.</span><span class="n">effectiveGasPrice</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
<span class="w">             </span><span class="p">}</span>
<span class="w">           </span><span class="p">}</span>
<span class="w">         </span><span class="p">);</span>

<span class="w">         </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="err">`</span><span class="n">Transaction</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">tx</span><span class="o">.</span><span class="n">hash</span><span class="p">}</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">status</span><span class="p">}</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">receipt</span><span class="o">.</span><span class="n">blockNumber</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">     </span><span class="p">}</span><span class="w"> </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="err">`</span><span class="n">Error</span><span class="w"> </span><span class="n">checking</span><span class="w"> </span><span class="n">transaction</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">tx</span><span class="o">.</span><span class="n">hash</span><span class="p">}:</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">);</span>
<span class="w">     </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">handleContractEvent</span><span class="p">(</span><span class="n">contractName</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="err">`</span><span class="n">Event</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">contractName</span><span class="p">}:</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">event</span><span class="o">.</span><span class="n">event</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">database</span>
<span class="w">   </span><span class="n">await</span><span class="w"> </span><span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s2">&quot;ContractEvent&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">insertOne</span><span class="p">({</span>
<span class="w">     </span><span class="n">contractName</span><span class="p">,</span>
<span class="w">     </span><span class="n">eventName</span><span class="p">:</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">event</span><span class="p">,</span>
<span class="w">     </span><span class="n">transactionHash</span><span class="p">:</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">transactionHash</span><span class="p">,</span>
<span class="w">     </span><span class="n">blockNumber</span><span class="p">:</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">blockNumber</span><span class="p">,</span>
<span class="w">     </span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="n">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">args</span><span class="p">)),</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Convert</span><span class="w"> </span><span class="n">BigNumber</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">string</span>
<span class="w">     </span><span class="n">timestamp</span><span class="p">:</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Date</span><span class="p">()</span>
<span class="w">   </span><span class="p">});</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Emit</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">WebSocket</span><span class="w"> </span><span class="n">clients</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">needed</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="n">stop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">this</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">removeAllListeners</span><span class="p">();</span>

<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="p">[</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">contract</span><span class="w"> </span><span class="p">}]</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">contracts</span><span class="o">.</span><span class="n">entries</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">contract</span><span class="o">.</span><span class="n">removeAllListeners</span><span class="p">();</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="err">`</span><span class="n">Stopped</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="n">listener</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">this</span><span class="o">.</span><span class="n">networkId</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
<span class="w"> </span><span class="p">}</span>
</code></pre></div>

<p>}
   ```</p>
<h3 id="gas-price-management">Gas Price Management<a class="headerlink" href="#gas-price-management" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Gas price estimation</strong>:</li>
</ol>
<p>```javascript
   // src/lib/gas-price.js
   const { ethers } = require("ethers");
   const { getProvider } = require("./blockchain");</p>
<p>async function estimateGasPrice(networkId, priority = "medium") {
     try {
       const provider = getProvider(networkId);</p>
<div class="codehilite"><pre><span></span><code><span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="k">Get</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="n">gas</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">provider</span>
<span class="w">   </span><span class="n">const</span><span class="w"> </span><span class="n">gasPrice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">provider</span><span class="p">.</span><span class="n">getGasPrice</span><span class="p">();</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Apply</span><span class="w"> </span><span class="n">multipliers</span><span class="w"> </span><span class="n">based</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">priority</span>
<span class="w">   </span><span class="n">const</span><span class="w"> </span><span class="n">multipliers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span>
<span class="w">     </span><span class="nl">low</span><span class="p">:</span><span class="w"> </span><span class="mf">0.8</span><span class="p">,</span>
<span class="w">     </span><span class="nl">medium</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span>
<span class="w">     </span><span class="nl">high</span><span class="p">:</span><span class="w"> </span><span class="mf">1.5</span><span class="p">,</span>
<span class="w">     </span><span class="nl">urgent</span><span class="p">:</span><span class="w"> </span><span class="mf">2.0</span>
<span class="w">   </span><span class="err">}</span><span class="p">;</span>

<span class="w">   </span><span class="n">const</span><span class="w"> </span><span class="n">multiplier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">multipliers</span><span class="o">[</span><span class="n">priority</span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">gasPrice</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="n">multiplier</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)).</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="w"> </span><span class="err">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="n">console</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="err">`</span><span class="n">Error</span><span class="w"> </span><span class="n">estimating</span><span class="w"> </span><span class="n">gas</span><span class="w"> </span><span class="nl">price</span><span class="p">:</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Fallback</span><span class="w"> </span><span class="n">gas</span><span class="w"> </span><span class="n">prices</span><span class="w"> </span><span class="p">(</span><span class="ow">in</span><span class="w"> </span><span class="n">gwei</span><span class="p">)</span>
<span class="w">   </span><span class="n">const</span><span class="w"> </span><span class="n">fallbackPrices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span>
<span class="w">     </span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="nl">low</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="nl">medium</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="nl">high</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="nl">urgent</span><span class="p">:</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="err">}</span><span class="p">,</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Mainnet</span>
<span class="w">     </span><span class="mi">84532</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="nl">low</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nl">medium</span><span class="p">:</span><span class="w"> </span><span class="mf">1.5</span><span class="p">,</span><span class="w"> </span><span class="nl">high</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nl">urgent</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="err">}</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">BaseSepolia</span>
<span class="w">   </span><span class="err">}</span><span class="p">;</span>

<span class="w">   </span><span class="n">const</span><span class="w"> </span><span class="n">gweiPrice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fallbackPrices</span><span class="o">[</span><span class="n">networkId</span><span class="o">]</span><span class="vm">?</span><span class="p">.</span><span class="o">[</span><span class="n">priority</span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">ethers</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">parseUnits</span><span class="p">(</span><span class="n">gweiPrice</span><span class="p">.</span><span class="n">toString</span><span class="p">(),</span><span class="w"> </span><span class="ss">&quot;gwei&quot;</span><span class="p">);</span>
<span class="w"> </span><span class="err">}</span>
</code></pre></div>

<p>}</p>
<p>async function getGasSettings(networkId, priority = "medium") {
     const gasPrice = await estimateGasPrice(networkId, priority);</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">For</span><span class="w"> </span><span class="n">EIP</span><span class="o">-</span><span class="mi">1559</span><span class="w"> </span><span class="n">compatible</span><span class="w"> </span><span class="n">networks</span><span class="p">,</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">maxFeePerGas</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">maxPriorityFeePerGas</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getProvider</span><span class="p">(</span><span class="n">networkId</span><span class="p">);</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">provider</span><span class="p">.</span><span class="n">getNetwork</span><span class="p">();</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="n">supports</span><span class="w"> </span><span class="n">EIP</span><span class="o">-</span><span class="mi">1559</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">provider</span><span class="p">.</span><span class="n">getBlock</span><span class="p">(</span><span class="ss">&quot;latest&quot;</span><span class="p">);</span>
<span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">eip1559Support</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">baseFeePerGas</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="n">undefined</span><span class="p">;</span>

<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">eip1559Support</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="n">const</span><span class="w"> </span><span class="n">baseFeePerGas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">baseFeePerGas</span><span class="p">;</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Priority</span><span class="w"> </span><span class="n">fee</span><span class="w"> </span><span class="n">multipliers</span>
<span class="w">   </span><span class="n">const</span><span class="w"> </span><span class="n">priorityFeeMultipliers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span>
<span class="w">     </span><span class="nl">low</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span>
<span class="w">     </span><span class="nl">medium</span><span class="p">:</span><span class="w"> </span><span class="mf">1.5</span><span class="p">,</span>
<span class="w">     </span><span class="nl">high</span><span class="p">:</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span>
<span class="w">     </span><span class="nl">urgent</span><span class="p">:</span><span class="w"> </span><span class="mf">3.0</span>
<span class="w">   </span><span class="err">}</span><span class="p">;</span>

<span class="w">   </span><span class="n">const</span><span class="w"> </span><span class="n">multiplier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">priorityFeeMultipliers</span><span class="o">[</span><span class="n">priority</span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">1.5</span><span class="p">;</span>
<span class="w">   </span><span class="n">const</span><span class="w"> </span><span class="n">maxPriorityFeePerGas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ethers</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">parseUnits</span><span class="p">(</span><span class="ss">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;gwei&quot;</span><span class="p">).</span><span class="n">mul</span><span class="p">(</span><span class="n">multiplier</span><span class="p">);</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">maxFeePerGas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">baseFeePerGas</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">maxPriorityFeePerGas</span>
<span class="w">   </span><span class="n">const</span><span class="w"> </span><span class="n">maxFeePerGas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">baseFeePerGas</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="k">add</span><span class="p">(</span><span class="n">maxPriorityFeePerGas</span><span class="p">);</span>

<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">maxFeePerGas</span><span class="p">,</span><span class="w"> </span><span class="n">maxPriorityFeePerGas</span><span class="w"> </span><span class="err">}</span><span class="p">;</span>
<span class="w"> </span><span class="err">}</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Fallback</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">regular</span><span class="w"> </span><span class="n">gasPrice</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">EIP</span><span class="o">-</span><span class="mi">1559</span><span class="w"> </span><span class="n">networks</span>
<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">gasPrice</span><span class="w"> </span><span class="err">}</span><span class="p">;</span>
</code></pre></div>

<p>}
   ```</p>
<ol>
<li><strong>Transaction submission with gas management</strong>:</li>
</ol>
<p>```javascript
   // src/lib/transaction.js
   const { getProvider } = require("./blockchain");
   const { getGasSettings } = require("./gas-price");</p>
<p>async function sendTransaction(networkId, txData, priority = "medium") {
     const provider = getProvider(networkId);
     const signer = new ethers.Wallet(process.env.PRIVATE_KEY, provider);</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">gas</span><span class="w"> </span><span class="n">settings</span><span class="w"> </span><span class="n">based</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">priority</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">gasSettings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">getGasSettings</span><span class="p">(</span><span class="n">networkId</span><span class="p">,</span><span class="w"> </span><span class="n">priority</span><span class="p">);</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Estimate</span><span class="w"> </span><span class="n">gas</span><span class="w"> </span><span class="n">limit</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">gasLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">provider</span><span class="o">.</span><span class="n">estimateGas</span><span class="p">({</span>
<span class="w">   </span><span class="n">from</span><span class="p">:</span><span class="w"> </span><span class="n">signer</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
<span class="w">   </span><span class="n">to</span><span class="p">:</span><span class="w"> </span><span class="n">txData</span><span class="o">.</span><span class="n">to</span><span class="p">,</span>
<span class="w">   </span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="n">txData</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
<span class="w">   </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="n">txData</span><span class="o">.</span><span class="n">value</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mi">0</span>
<span class="w"> </span><span class="p">});</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">gas</span><span class="w"> </span><span class="n">limit</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">gasLimitWithBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gasLimit</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">20</span><span class="o">%</span><span class="w"> </span><span class="n">buffer</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Construct</span><span class="w"> </span><span class="n">transaction</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">transaction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">from</span><span class="p">:</span><span class="w"> </span><span class="n">signer</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
<span class="w">   </span><span class="n">to</span><span class="p">:</span><span class="w"> </span><span class="n">txData</span><span class="o">.</span><span class="n">to</span><span class="p">,</span>
<span class="w">   </span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="n">txData</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
<span class="w">   </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="n">txData</span><span class="o">.</span><span class="n">value</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">   </span><span class="n">gasLimit</span><span class="p">:</span><span class="w"> </span><span class="n">gasLimitWithBuffer</span><span class="p">,</span>
<span class="w">   </span><span class="o">...</span><span class="n">gasSettings</span>
<span class="w"> </span><span class="p">};</span>

<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Send</span><span class="w"> </span><span class="n">transaction</span>
<span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">signer</span><span class="o">.</span><span class="n">sendTransaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">);</span>
<span class="w"> </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="err">`</span><span class="n">Transaction</span><span class="w"> </span><span class="n">sent</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">tx</span><span class="o">.</span><span class="n">hash</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">tx</span><span class="p">;</span>
</code></pre></div>

<p>}
   ```</p>
<h3 id="network-upgrades-handling">Network Upgrades Handling<a class="headerlink" href="#network-upgrades-handling" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Network upgrade detector</strong>:</li>
</ol>
<p>```javascript
   // src/lib/network-upgrade.js
   const { getProvider } = require("./blockchain");</p>
<p>async function checkNetworkUpgrade(networkId) {
     try {
       const provider = getProvider(networkId);</p>
<div class="codehilite"><pre><span></span><code><span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="k">Get</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="n">block</span>
<span class="w">   </span><span class="n">const</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">provider</span><span class="p">.</span><span class="n">getBlock</span><span class="p">(</span><span class="ss">&quot;latest&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="k">Check</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">fork</span><span class="w"> </span><span class="n">identifier</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">upgrade</span><span class="w"> </span><span class="n">indicators</span>
<span class="w">   </span><span class="n">const</span><span class="w"> </span><span class="n">isEIP1559</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">baseFeePerGas</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="n">undefined</span><span class="p">;</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="k">Check</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">upcoming</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="n">upgrades</span>
<span class="w">   </span><span class="n">const</span><span class="w"> </span><span class="n">upgrades</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span>
<span class="w">     </span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n"> // Ethereum Mainnet</span>
<span class="n">       { name: &quot;Cancun&quot;, block: 19000000, active: block.number &gt;= 19000000 }</span>
<span class="n">     </span><span class="o">]</span><span class="p">,</span>
<span class="w">     </span><span class="mi">84532</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n"> // BaseSepolia</span>
<span class="n">       { name: &quot;Future Upgrade&quot;, block: 5000000, active: block.number &gt;= 5000000 }</span>
<span class="n">     </span><span class="o">]</span>
<span class="w">   </span><span class="err">}</span><span class="p">;</span>

<span class="w">   </span><span class="n">const</span><span class="w"> </span><span class="n">networkUpgrades</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upgrades</span><span class="o">[</span><span class="n">networkId</span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="err">[]</span><span class="p">;</span>
<span class="w">   </span><span class="n">const</span><span class="w"> </span><span class="n">upcomingUpgrades</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">networkUpgrades</span><span class="p">.</span><span class="k">filter</span><span class="p">(</span><span class="n">u</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">!</span><span class="n">u</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>
<span class="w">   </span><span class="n">const</span><span class="w"> </span><span class="n">activeUpgrades</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">networkUpgrades</span><span class="p">.</span><span class="k">filter</span><span class="p">(</span><span class="n">u</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>

<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="err">{</span>
<span class="w">     </span><span class="nl">currentBlock</span><span class="p">:</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">number</span><span class="p">,</span>
<span class="w">     </span><span class="nl">features</span><span class="p">:</span><span class="w"> </span><span class="err">{</span>
<span class="w">       </span><span class="nl">eip1559</span><span class="p">:</span><span class="w"> </span><span class="n">isEIP1559</span>
<span class="w">     </span><span class="err">}</span><span class="p">,</span>
<span class="w">     </span><span class="n">activeUpgrades</span><span class="p">,</span>
<span class="w">     </span><span class="n">upcomingUpgrades</span>
<span class="w">   </span><span class="err">}</span><span class="p">;</span>
<span class="w"> </span><span class="err">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="n">console</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="err">`</span><span class="n">Error</span><span class="w"> </span><span class="n">checking</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="nl">upgrade</span><span class="p">:</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="nl">error</span><span class="p">:</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="w"> </span><span class="err">}</span><span class="p">;</span>
<span class="w"> </span><span class="err">}</span>
</code></pre></div>

<p>}
   ```</p>
<ol>
<li><strong>Handling network forks</strong>:</li>
</ol>
<p>```javascript
   // src/lib/fork-handler.js
   const { getProvider } = require("./blockchain");</p>
<p>class ForkHandler {
     constructor(networkId) {
       this.networkId = networkId;
       this.provider = getProvider(networkId);
       this.forkBlocks = {
         1: { // Ethereum Mainnet
           "Cancun": 19000000
         },
         84532: { // BaseSepolia
           "FutureUpgrade": 5000000
         }
       };
     }</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">detectFork</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">currentBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">getBlockNumber</span><span class="p">();</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">networkForks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">forkBlocks</span><span class="p">[</span><span class="n">this</span><span class="o">.</span><span class="n">networkId</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{};</span>

<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">activeForks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">pendingForks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="p">[</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">blockNumber</span><span class="p">]</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="nb nb-Type">Object</span><span class="o">.</span><span class="n">entries</span><span class="p">(</span><span class="n">networkForks</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">currentBlock</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">blockNumber</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="n">activeForks</span><span class="o">.</span><span class="n">push</span><span class="p">({</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">blockNumber</span><span class="w"> </span><span class="p">});</span>
<span class="w">     </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="n">pendingForks</span><span class="o">.</span><span class="n">push</span><span class="p">({</span>
<span class="w">         </span><span class="n">name</span><span class="p">,</span>
<span class="w">         </span><span class="n">blockNumber</span><span class="p">,</span>
<span class="w">         </span><span class="n">blocksRemaining</span><span class="p">:</span><span class="w"> </span><span class="n">blockNumber</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">currentBlock</span>
<span class="w">       </span><span class="p">});</span>
<span class="w">     </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">currentBlock</span><span class="p">,</span><span class="w"> </span><span class="n">activeForks</span><span class="p">,</span><span class="w"> </span><span class="n">pendingForks</span><span class="w"> </span><span class="p">};</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">adjustForFork</span><span class="p">(</span><span class="n">txParams</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">forkStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">detectFork</span><span class="p">();</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="n">newParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">...</span><span class="n">txParams</span><span class="w"> </span><span class="p">};</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Adjust</span><span class="w"> </span><span class="n">transaction</span><span class="w"> </span><span class="n">parameters</span><span class="w"> </span><span class="n">based</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="n">forks</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">fork</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">forkStatus</span><span class="o">.</span><span class="n">activeForks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fork</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;Cancun&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">fork</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;London&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="o">//</span><span class="w"> </span><span class="n">EIP</span><span class="o">-</span><span class="mi">1559</span><span class="w"> </span><span class="n">transaction</span><span class="w"> </span><span class="n">type</span>
<span class="w">       </span><span class="n">delete</span><span class="w"> </span><span class="n">newParams</span><span class="o">.</span><span class="n">gasPrice</span><span class="p">;</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">newParams</span><span class="o">.</span><span class="n">maxFeePerGas</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">const</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">getBlock</span><span class="p">(</span><span class="s2">&quot;latest&quot;</span><span class="p">);</span>
<span class="w">         </span><span class="k">const</span><span class="w"> </span><span class="n">baseFeePerGas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block</span><span class="o">.</span><span class="n">baseFeePerGas</span><span class="p">;</span>

<span class="w">         </span><span class="n">newParams</span><span class="o">.</span><span class="n">maxPriorityFeePerGas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ethers</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parseUnits</span><span class="p">(</span><span class="s2">&quot;1.5&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;gwei&quot;</span><span class="p">);</span>
<span class="w">         </span><span class="n">newParams</span><span class="o">.</span><span class="n">maxFeePerGas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">baseFeePerGas</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">newParams</span><span class="o">.</span><span class="n">maxPriorityFeePerGas</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">       </span><span class="o">//</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">transaction</span><span class="w"> </span><span class="p">(</span><span class="n">EIP</span><span class="o">-</span><span class="mi">1559</span><span class="p">)</span>
<span class="w">       </span><span class="n">newParams</span><span class="o">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">     </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">newParams</span><span class="p">;</span>
<span class="w"> </span><span class="p">}</span>
</code></pre></div>

<p>}
   ```</p>
<h2 id="version-control">Version Control<a class="headerlink" href="#version-control" title="Permanent link">&para;</a></h2>
<h3 id="repository-structure">Repository Structure<a class="headerlink" href="#repository-structure" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Recommended repository structure</strong>:</li>
</ol>
<p><code>gemforce/
   ├── .github/                  # GitHub workflows and templates
   ├── contracts/                # Smart contracts
   │   ├── facets/               # Diamond facets
   │   ├── interfaces/           # Contract interfaces
   │   ├── libraries/            # Contract libraries
   │   ├── upgradeInitializers/  # Initializers for upgrades
   ├── deploy/                   # Deployment scripts
   ├── deployments/              # Deployment artifacts
   ├── docs/                     # Documentation
   ├── scripts/                  # Utility scripts
   ├── src/                      # Source code
   │   ├── cloud-functions/      # Parse cloud functions
   │   ├── lib/                  # Shared libraries
   │   ├── indexer/              # Blockchain indexer
   │   ├── triggers/             # Parse triggers
   ├── test/                     # Tests
   │   ├── unit/                 # Unit tests
   │   ├── integration/          # Integration tests
   │   ├── fixtures/             # Test fixtures
   ├── .env.example              # Example environment variables
   ├── hardhat.config.ts         # Hardhat configuration
   ├── package.json              # Project metadata and dependencies
   ├── tsconfig.json             # TypeScript configuration
   └── README.md                 # Project documentation</code></p>
<ol>
<li>
<p><strong>Repository organization best practices</strong>:</p>
</li>
<li>
<p>Separate smart contracts from off-chain code</p>
</li>
<li>Organize contracts by functionality</li>
<li>Use descriptive folder names</li>
<li>Keep tests close to the code they test</li>
<li>Include documentation for each component</li>
</ol>
<h3 id="branching-strategy">Branching Strategy<a class="headerlink" href="#branching-strategy" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Git Flow branching model</strong>:</li>
</ol>
<p><code>main          ●───────●─────●──────●───── (production releases)
                 │       │     │      │
                 │       │     │      │
   staging       │       ●─────●──────●───── (pre-production testing)
                 │       │            │
                 │       │            │
   develop       ●───────●────────────●───── (integration branch)
                 │       │      │     │
                 │       │      │     │
   feature/xyz   ●───────●      │     │      (feature branches)
                         │      │     │
   feature/abc           ●──────●     │      (feature branches)
                                      │
   hotfix/123                         ●───── (hotfix branches)</code></p>
<ul>
<li><strong>main</strong>: Production code, tagged with version numbers</li>
<li><strong>staging</strong>: Pre-production testing</li>
<li><strong>develop</strong>: Integration branch for feature development</li>
<li><strong>feature/</strong>*:  Feature branches for new development</li>
<li>
<p><strong>hotfix/</strong>*:  Urgent fixes for production issues</p>
</li>
<li>
<p><strong>Branching guidelines</strong>:</p>
</li>
</ul>
<p>```bash
   # Create a new feature branch from develop
   git checkout develop
   git pull
   git checkout -b feature/new-feature</p>
<p># Work on the feature, committing changes
   git add .
   git commit -m "Implement new feature"</p>
<p># Push feature branch to remote
   git push -u origin feature/new-feature</p>
<p># When feature is complete, merge to develop
   git checkout develop
   git pull
   git merge --no-ff feature/new-feature
   git push origin develop</p>
<p># Create a hotfix branch from main
   git checkout main
   git pull
   git checkout -b hotfix/critical-fix</p>
<p># Fix the issue, commit changes
   git add .
   git commit -m "Fix critical issue"</p>
<p># Push hotfix branch
   git push -u origin hotfix/critical-fix</p>
<p># When hotfix is complete, merge to main and develop
   git checkout main
   git pull
   git merge --no-ff hotfix/critical-fix
   git push origin main</p>
<p>git checkout develop
   git pull
   git merge --no-ff hotfix/critical-fix
   git push origin develop
   ```</p>
<h3 id="release-management">Release Management<a class="headerlink" href="#release-management" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Semantic versioning</strong>:</li>
</ol>
<p><code>MAJOR.MINOR.PATCH</code></p>
<ul>
<li><strong>MAJOR</strong>: Breaking changes</li>
<li><strong>MINOR</strong>: New features, backwards compatible</li>
<li>
<p><strong>PATCH</strong>: Bug fixes, backwards compatible</p>
</li>
<li>
<p><strong>Release process</strong>:</p>
</li>
</ul>
<p>```bash
   # Prepare release from develop
   git checkout develop
   git pull
   git checkout -b release/1.2.0</p>
<p># Update version numbers
   npm version minor --no-git-tag-version</p>
<p># Make final adjustments
   git add .
   git commit -m "Prepare release 1.2.0"</p>
<p># Merge to staging for testing
   git checkout staging
   git pull
   git merge --no-ff release/1.2.0
   git push origin staging</p>
<p># Deploy to staging environment
   npm run deploy:staging</p>
<p># After testing, merge to main
   git checkout main
   git pull
   git merge --no-ff release/1.2.0
   git tag -a v1.2.0 -m "Release 1.2.0"
   git push origin main --tags</p>
<p># Update develop with any changes
   git checkout develop
   git pull
   git merge --no-ff release/1.2.0
   git push origin develop</p>
<p># Delete release branch
   git branch -d release/1.2.0
   ```</p>
<ol>
<li><strong>Changelog management</strong>:</li>
</ol>
<p>```markdown
   # Changelog</p>
<p>All notable changes to this project will be documented in this file.</p>
<p>## [1.2.0] - 2025-02-25</p>
<p>### Added
   - New carbon credit retirement feature
   - Support for multiple wallet providers</p>
<p>### Changed
   - Improved marketplace performance
   - Updated identity verification flow</p>
<p>### Fixed
   - Fixed issue with token minting
   - Resolved WebSocket connection stability</p>
<p>## [1.1.0] - 2025-01-15</p>
<p>### Added
   - Identity management system
   - DFNS wallet integration</p>
<p>### Changed
   - Upgraded Parse Server to latest version
   - Improved error handling</p>
<p>### Deprecated
   - Legacy API endpoints (to be removed in 2.0)
   ```</p>
<h3 id="tagging-conventions">Tagging Conventions<a class="headerlink" href="#tagging-conventions" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Version tags</strong>:</li>
</ol>
<p>```bash
   # Create an annotated version tag
   git tag -a v1.2.0 -m "Release 1.2.0"</p>
<p># Push tags to remote
   git push origin --tags
   ```</p>
<ol>
<li><strong>Environment tags</strong>:</li>
</ol>
<p>```bash
   # Create a tag for production deployment
   git tag -a prod-2025-02-25 -m "Production deployment on Feb 25, 2025"</p>
<p># Create a tag for staging deployment
   git tag -a staging-2025-02-20 -m "Staging deployment on Feb 20, 2025"
   ```</p>
<ol>
<li><strong>Contract deployment tags</strong>:</li>
</ol>
<p>```bash
   # Create a tag for contract deployment
   git tag -a deploy-mainnet-1.2.0 -m "Mainnet contract deployment v1.2.0"</p>
<p># Create a tag for facet upgrade
   git tag -a upgrade-marketplace-1.2.1 -m "Marketplace facet upgrade to v1.2.1"
   ```</p>
<h3 id="documentation-versioning">Documentation Versioning<a class="headerlink" href="#documentation-versioning" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Documentation directory structure</strong>:</li>
</ol>
<p><code>docs/
   ├── latest/                  # Latest documentation (symlink to current version)
   ├── v1.2.0/                  # Documentation for v1.2.0
   │   ├── admin-guide.md       # Administrator guide
   │   ├── api-reference.md     # API reference
   │   └── ...
   ├── v1.1.0/                  # Documentation for v1.1.0
   │   ├── admin-guide.md       # Administrator guide
   │   ├── api-reference.md     # API reference
   │   └── ...
   └── ...</code></p>
<ol>
<li><strong>Version-specific documentation</strong>:</li>
</ol>
<p>```bash
   # Create a new documentation version
   mkdir -p docs/v1.2.0
   cp -r docs/v1.1.0/* docs/v1.2.0/</p>
<p># Update documentation for new version
   # Edit files in docs/v1.2.0/</p>
<p># Update the latest symlink
   rm docs/latest
   ln -s v1.2.0 docs/latest
   ```</p>
<ol>
<li><strong>Documentation in the codebase</strong>:</li>
</ol>
<p>```solidity
   // contracts/facets/MarketplaceFacet.sol</p>
<p>/*<em>
    * @title MarketplaceFacet
    * @dev Implements marketplace functionality for the Diamond
    * @notice This facet handles listing, buying, and selling tokens
    * @version 1.2.0
    </em>/
   contract MarketplaceFacet is Modifiers {
       // ...
   ```</p>
<p>```javascript
   // src/cloud-functions/marketplace.js</p>
<p>/*<em>
    * @api {post} /parse/functions/listItem List an item for sale
    * @apiVersion 1.2.0
    * @apiName ListItem
    * @apiGroup Marketplace
    * @apiDescription Lists a token for sale in the marketplace
    *
    * @apiParam {String} tokenId The ID of the token to list
    * @apiParam {String} price The price in ETH
    *
    * @apiSuccess {Object} result The result of the operation
    * @apiSuccess {Boolean} result.success Whether the operation was successful
    * @apiSuccess {String} result.transactionHash The transaction hash
    </em>/
   Parse.Cloud.define("listItem", async (request) =&gt; {
       // ...
   });</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../gemforce-administrator-guide/" class="btn btn-neutral float-left" title="Administrator Guide"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../gemforce-integrator-guide/" class="btn btn-neutral float-right" title="Integrator Guide">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../gemforce-administrator-guide/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../gemforce-integrator-guide/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
