<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Gemforce Team" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Trade Deal Operations Facet - Gemforce Documentation</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Trade Deal Operations Facet";
        var mkdocs_page_input_path = "smart-contracts/facets/trade-deal-operations-facet.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> Gemforce Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../developer-setup-guide/">Developer Setup Guide</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../system-architecture/gemforce-system-architecture/">System Architecture</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Smart Contracts</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../../">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../diamond/">Diamond Contract</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >Facets</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../marketplace-facet/">Marketplace Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../trade-deal-management-facet/">Trade Deal Management Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../carbon-credit-facet/">Carbon Credit Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../identity-registry-facet/">Identity Registry Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../trusted-issuers-registry-facet/">Trusted Issuers Registry Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../fee-distributor-facet/">Fee Distributor Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../gemforce-minter-facet/">Gemforce Minter Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../multi-sale-facet/">Multi Sale Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../svg-templates-facet/">SVG Templates Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../trade-deal-admin-facet/">Trade Deal Admin Facet</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">Trade Deal Operations Facet</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#contract-details">Contract Details</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#key-features">Key Features</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#invoice-management">ðŸ”¹ Invoice Management</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#usdc-funding-operations">ðŸ”¹ USDC Funding Operations</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#funding-withdrawal-system">ðŸ”¹ Funding Withdrawal System</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#repayment-processing">ðŸ”¹ Repayment Processing</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#collateral-redemption">ðŸ”¹ Collateral Redemption</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#core-functions">Core Functions</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#invoice-management-functions">Invoice Management Functions</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#usdc-funding-functions">USDC Funding Functions</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#funding-withdrawal-functions">Funding Withdrawal Functions</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#repayment-functions">Repayment Functions</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#collateral-redemption-functions">Collateral Redemption Functions</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#integration-examples">Integration Examples</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#complete-trade-deal-lifecycle">Complete Trade Deal Lifecycle</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#automated-repayment-system">Automated Repayment System</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#collateral-management-system">Collateral Management System</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#invoice-collateral-tracker">Invoice Collateral Tracker</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#events">Events</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#invoice-management-events">Invoice Management Events</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#usdc-funding-events">USDC Funding Events</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#funding-withdrawal-events">Funding Withdrawal Events</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#repayment-events">Repayment Events</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#redemption-events">Redemption Events</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#security-considerations">Security Considerations</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#access-control">Access Control</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#financial-security">Financial Security</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#operational-security">Operational Security</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#gas-optimization">Gas Optimization</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#efficient-operations">Efficient Operations</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#storage-optimization">Storage Optimization</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#error-handling">Error Handling</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#common-errors">Common Errors</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#best-practices">Best Practices</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../collateral-token-factory-facet/">Collateral Token Factory Facet</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Interfaces</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../interfaces/idiamond/">IDiamond</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../interfaces/imarketplace/">IMarketplace</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../interfaces/itradedeal/">ITradeDeal</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../interfaces/icarbon-credit/">ICarbonCredit</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../interfaces/ierc1155-mint/">IERC1155Mint</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../interfaces/ierc734/">IERC734</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../interfaces/ierc735/">IERC735</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Libraries</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/carbon-credit-lib/">Carbon Credit Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/trade-deal-lib/">Trade Deal Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/multi-sale-lib/">Multi Sale Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/diamond-factory-lib/">Diamond Factory Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/svg-templates-lib/">SVG Templates Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/attribute-lib/">Attribute Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/variable-price-lib/">Variable Price Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/merkle-prover/">Merkle Prover</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/fee-distributor-lib/">Fee Distributor Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/lib-diamond/">LibDiamond</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/diamond-lib/">DiamondLib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/erc721a-lib/">ERC721A Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/erc721a-enumeration-lib/">ERC721A Enumeration Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/strings-lib/">Strings Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/metadata-lib/">Metadata Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/trusted-issuer-lib/">Trusted Issuer Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/set-libraries/">Set Libraries</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Cloud Functions</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/blockchain/">Blockchain Functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/dfns/">DFNS Functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/contracts/">Contract Functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/authentication/">Authentication Functions</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API Documentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api-documentation/gemforce-api-documentation/">Full API Reference</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api-documentation/gemforce-api-quick-reference/">Quick Reference</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">EIPs (Ethereum Improvement Proposals)</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../eips/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../eips/EIP-DRAFT-Diamond-Enhanced-Marketplace/">Diamond-Enhanced Marketplace</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../eips/EIP-DRAFT-Multi-Token-Sale-Standard/">Multi-Token Sale Standard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../eips/EIP-DRAFT-Collateralized-Trade-Deal-Standard/">Collateralized Trade Deal Standard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../eips/EIP-DRAFT-Enhanced-Identity-System/">Enhanced Identity System</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../eips/EIP-DRAFT-Diamond-Factory-Standard/">Diamond Factory Standard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../eips/EIP-DRAFT-Carbon-Credit-Standard/">Carbon Credit Standard</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">User Guides</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../gemforce-administrator-guide/">Administrator Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../gemforce-deployer-guide/">Deployer Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../gemforce-integrator-guide/">Integrator Guide</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../external-services/gemforce-external-services/">External Services</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../gemforce-documentation-gap-analysis/">Documentation Gap Analysis</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../documentation-progress-summary/">Documentation Progress Summary</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../documentation-plan/">Documentation Plan</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">Gemforce Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Smart Contracts</li>
          <li class="breadcrumb-item">Facets</li>
      <li class="breadcrumb-item active">Trade Deal Operations Facet</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="tradedealoperationsfacet">TradeDealOperationsFacet<a class="headerlink" href="#tradedealoperationsfacet" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>The <a href="/Users/sschepis/Development/gem-base/contracts/facets/TradeDealOperationsFacet.sol"><code>TradeDealOperationsFacet.sol</code></a> provides core operational functionality for trade deals within the Gemforce diamond system. This facet handles the essential operations including invoice deposits/withdrawals, USDC funding, collateral management, repayments, and redemptions that form the backbone of the trade deal lifecycle.</p>
<h2 id="contract-details">Contract Details<a class="headerlink" href="#contract-details" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Contract Name</strong>: <code>TradeDealOperationsFacet</code></li>
<li><strong>Inheritance</strong>: <code>Modifiers</code></li>
<li><strong>License</strong>: MIT</li>
<li><strong>Solidity Version</strong>: ^0.8.0</li>
</ul>
<h2 id="key-features">Key Features<a class="headerlink" href="#key-features" title="Permanent link">&para;</a></h2>
<h3 id="invoice-management">ðŸ”¹ Invoice Management<a class="headerlink" href="#invoice-management" title="Permanent link">&para;</a></h3>
<ul>
<li>Deposit invoices as collateral backing</li>
<li>Withdraw invoices from trade deals</li>
<li>Participant validation for invoice operations</li>
<li>Invoice ownership and transfer tracking</li>
</ul>
<h3 id="usdc-funding-operations">ðŸ”¹ USDC Funding Operations<a class="headerlink" href="#usdc-funding-operations" title="Permanent link">&para;</a></h3>
<ul>
<li>Deposit USDC to fund trade deals</li>
<li>Withdraw USDC with proper authorization</li>
<li>Automatic collateral token distribution</li>
<li>Funding target tracking and completion</li>
</ul>
<h3 id="funding-withdrawal-system">ðŸ”¹ Funding Withdrawal System<a class="headerlink" href="#funding-withdrawal-system" title="Permanent link">&para;</a></h3>
<ul>
<li>Borrower funding withdrawal (admin-controlled)</li>
<li>Self-service funding withdrawal</li>
<li>Validation and authorization checks</li>
<li>Funding distribution tracking</li>
</ul>
<h3 id="repayment-processing">ðŸ”¹ Repayment Processing<a class="headerlink" href="#repayment-processing" title="Permanent link">&para;</a></h3>
<ul>
<li>Trade deal repayment by borrowers</li>
<li>Admin-assisted repayment processing</li>
<li>Partial and full repayment support</li>
<li>Repayment validation and tracking</li>
</ul>
<h3 id="collateral-redemption">ðŸ”¹ Collateral Redemption<a class="headerlink" href="#collateral-redemption" title="Permanent link">&para;</a></h3>
<ul>
<li>Redeem collateral tokens for USDC</li>
<li>Proportional redemption calculations</li>
<li>Participant validation for redemptions</li>
<li>Collateral-to-USDC conversion tracking</li>
</ul>
<h2 id="core-functions">Core Functions<a class="headerlink" href="#core-functions" title="Permanent link">&para;</a></h2>
<h3 id="invoice-management-functions">Invoice Management Functions<a class="headerlink" href="#invoice-management-functions" title="Permanent link">&para;</a></h3>
<h4 id="tddepositinvoice"><code>tdDepositInvoice()</code><a class="headerlink" href="#tddepositinvoice" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">tdDepositInvoice</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tokenId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span>
</code></pre></div>

<p><strong>Purpose</strong>: Deposits an invoice NFT as collateral backing for a trade deal.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal
- <code>tokenId</code> (uint256): ID of the invoice NFT to deposit</p>
<p><strong>Access Control</strong>: Public (with validation)</p>
<p><strong>Process</strong>:
1. Validates invoice deposit eligibility and ownership
2. Transfers invoice NFT to trade deal contract
3. Updates trade deal collateral backing
4. Records invoice in trade deal storage
5. Emits InvoiceDepositedToTradeDeal event</p>
<p><strong>Events</strong>: <code>InvoiceDepositedToTradeDeal(tradeDealId, tokenId)</code></p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Deposit invoice as collateral for trade deal</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">invoiceTokenId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">123</span><span class="p">;</span>

<span class="c1">// First approve the diamond to transfer the invoice</span>
IERC721<span class="p">(</span>invoiceContract<span class="p">).</span>approve<span class="p">(</span>diamond<span class="p">,</span><span class="w"> </span>invoiceTokenId<span class="p">);</span>

<span class="c1">// Deposit the invoice</span>
ITradeDealOperations<span class="p">(</span>diamond<span class="p">).</span>tdDepositInvoice<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>invoiceTokenId<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Invoice&quot;</span><span class="p">,</span><span class="w"> </span>invoiceTokenId<span class="p">,</span><span class="w"> </span><span class="s2">&quot;deposited to trade deal&quot;</span><span class="p">,</span><span class="w"> </span>tradeDealId<span class="p">);</span>
</code></pre></div>

<p><strong>Requirements</strong>:
- Caller must own the invoice NFT
- Invoice must be eligible for the trade deal
- Trade deal must be active and accepting deposits
- Invoice must not already be deposited</p>
<hr />
<h4 id="tdwithdrawinvoice"><code>tdWithdrawInvoice()</code><a class="headerlink" href="#tdwithdrawinvoice" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">tdWithdrawInvoice</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tokenId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span>
</code></pre></div>

<p><strong>Purpose</strong>: Withdraws an invoice NFT from a trade deal back to the participant.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal
- <code>tokenId</code> (uint256): ID of the invoice NFT to withdraw</p>
<p><strong>Access Control</strong>: Trade deal participants only</p>
<p><strong>Process</strong>:
1. Validates caller is a trade deal participant
2. Confirms invoice is deposited in the trade deal
3. Checks withdrawal eligibility (no outstanding obligations)
4. Transfers invoice NFT back to participant
5. Updates trade deal collateral records
6. Emits InvoiceWithdrawnFromTradeDeal event</p>
<p><strong>Events</strong>: <code>InvoiceWithdrawnFromTradeDeal(tradeDealId, tokenId)</code></p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Withdraw invoice from trade deal</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">invoiceTokenId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">123</span><span class="p">;</span>

ITradeDealOperations<span class="p">(</span>diamond<span class="p">).</span>tdWithdrawInvoice<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>invoiceTokenId<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Invoice&quot;</span><span class="p">,</span><span class="w"> </span>invoiceTokenId<span class="p">,</span><span class="w"> </span><span class="s2">&quot;withdrawn from trade deal&quot;</span><span class="p">,</span><span class="w"> </span>tradeDealId<span class="p">);</span>
</code></pre></div>

<p><strong>Requirements</strong>:
- Caller must be a trade deal participant
- Invoice must be deposited in the trade deal
- No outstanding obligations against the invoice
- Trade deal must allow withdrawals</p>
<h3 id="usdc-funding-functions">USDC Funding Functions<a class="headerlink" href="#usdc-funding-functions" title="Permanent link">&para;</a></h3>
<h4 id="tddepositusdc"><code>tdDepositUSDC()</code><a class="headerlink" href="#tddepositusdc" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">tdDepositUSDC</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span>
</code></pre></div>

<p><strong>Purpose</strong>: Deposits USDC to fund a trade deal and receives collateral tokens in return.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal to fund
- <code>amount</code> (uint256): Amount of USDC to deposit</p>
<p><strong>Access Control</strong>: Public (with validation)</p>
<p><strong>Process</strong>:
1. Validates trade deal is active and accepting funding
2. Transfers USDC from depositor to trade deal
3. Calculates and mints collateral tokens for depositor
4. Updates trade deal funding status
5. Checks if trade deal is fully funded
6. Emits multiple events for tracking</p>
<p><strong>Events</strong>: 
- <code>USDCDepositedToTradeDeal(tradeDealId, amount, depositor)</code>
- <code>CollateralTokensDistributed(tradeDealId, recipient, amount)</code>
- <code>TradeDealFullyFunded(tradeDealId, fundingTarget)</code> (if applicable)</p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Fund trade deal with USDC</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">10000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">10</span><span class="o">**</span><span class="m m-Decimal">6</span><span class="p">;</span><span class="w"> </span><span class="c1">// 10,000 USDC</span>

<span class="c1">// First approve USDC transfer</span>
IERC20<span class="p">(</span>usdcToken<span class="p">).</span>approve<span class="p">(</span>diamond<span class="p">,</span><span class="w"> </span>fundingAmount<span class="p">);</span>

<span class="c1">// Deposit USDC and receive collateral tokens</span>
ITradeDealOperations<span class="p">(</span>diamond<span class="p">).</span>tdDepositUSDC<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>fundingAmount<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Deposited&quot;</span><span class="p">,</span><span class="w"> </span>fundingAmount<span class="p">,</span><span class="w"> </span><span class="s2">&quot;USDC to trade deal&quot;</span><span class="p">,</span><span class="w"> </span>tradeDealId<span class="p">);</span>
</code></pre></div>

<p><strong>Collateral Token Calculation</strong>:
- Collateral tokens are minted based on the collateral-to-interest ratio
- Tokens represent proportional ownership in the trade deal
- Used for interest distribution and redemption rights</p>
<hr />
<h4 id="tdwithdrawusdc"><code>tdWithdrawUSDC()</code><a class="headerlink" href="#tdwithdrawusdc" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">tdWithdrawUSDC</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>onlyOwner
</code></pre></div>

<p><strong>Purpose</strong>: Withdraws USDC from a trade deal (admin function).</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal
- <code>amount</code> (uint256): Amount of USDC to withdraw</p>
<p><strong>Access Control</strong>: Owner only</p>
<p><strong>Process</strong>:
1. Validates withdrawal amount and availability
2. Transfers USDC from trade deal to owner
3. Updates trade deal funding records
4. Emits USDCWithdrawnFromTradeDeal event</p>
<p><strong>Events</strong>: <code>USDCWithdrawnFromTradeDeal(tradeDealId, amount)</code></p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Admin withdrawal of excess USDC</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">withdrawAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">5000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">10</span><span class="o">**</span><span class="m m-Decimal">6</span><span class="p">;</span><span class="w"> </span><span class="c1">// 5,000 USDC</span>

ITradeDealOperations<span class="p">(</span>diamond<span class="p">).</span>tdWithdrawUSDC<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>withdrawAmount<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Withdrew&quot;</span><span class="p">,</span><span class="w"> </span>withdrawAmount<span class="p">,</span><span class="w"> </span><span class="s2">&quot;USDC from trade deal&quot;</span><span class="p">,</span><span class="w"> </span>tradeDealId<span class="p">);</span>
</code></pre></div>

<h3 id="funding-withdrawal-functions">Funding Withdrawal Functions<a class="headerlink" href="#funding-withdrawal-functions" title="Permanent link">&para;</a></h3>
<h4 id="withdrawtradedealfundingforborrower"><code>withdrawTradeDealFundingForBorrower()</code><a class="headerlink" href="#withdrawtradedealfundingforborrower" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">withdrawTradeDealFundingForBorrower</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">borrowerAddress</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>onlyOwner
</code></pre></div>

<p><strong>Purpose</strong>: Allows admin to withdraw funding on behalf of a borrower.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal
- <code>borrowerAddress</code> (address): Address of the borrower receiving funds</p>
<p><strong>Access Control</strong>: Owner only</p>
<p><strong>Process</strong>:
1. Validates funding withdrawal eligibility
2. Confirms trade deal is fully funded
3. Transfers available funding to borrower
4. Updates trade deal status and records
5. Emits TradeDealFundingWithdrawn event</p>
<p><strong>Events</strong>: <code>TradeDealFundingWithdrawn(tradeDealId, recipient, amount)</code></p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Admin withdraws funding for borrower</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="kt">address</span><span class="w"> </span><span class="nv">borrower</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x742d35Cc6634C0532925a3b8D0C9e3e0C8b0e5e1</span><span class="p">;</span>

ITradeDealOperations<span class="p">(</span>diamond<span class="p">).</span>withdrawTradeDealFundingForBorrower<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>borrower<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Funding withdrawn for borrower:&quot;</span><span class="p">,</span><span class="w"> </span>borrower<span class="p">);</span>
</code></pre></div>

<hr />
<h4 id="withdrawtradedealfundingself"><code>withdrawTradeDealFundingSelf()</code><a class="headerlink" href="#withdrawtradedealfundingself" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">withdrawTradeDealFundingSelf</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span>
</code></pre></div>

<p><strong>Purpose</strong>: Allows eligible borrowers to withdraw funding themselves.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal</p>
<p><strong>Access Control</strong>: Validated borrowers only</p>
<p><strong>Process</strong>:
1. Validates caller is authorized borrower for the trade deal
2. Confirms self-service withdrawal is enabled
3. Checks trade deal funding status and eligibility
4. Transfers available funding to caller
5. Updates trade deal records
6. Emits TradeDealFundingWithdrawn event</p>
<p><strong>Events</strong>: <code>TradeDealFundingWithdrawn(tradeDealId, recipient, amount)</code></p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Borrower withdraws funding themselves</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>

ITradeDealOperations<span class="p">(</span>diamond<span class="p">).</span>withdrawTradeDealFundingSelf<span class="p">(</span>tradeDealId<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Self-service funding withdrawal completed&quot;</span><span class="p">);</span>
</code></pre></div>

<p><strong>Requirements</strong>:
- Caller must be authorized borrower
- Trade deal must be fully funded
- Self-service withdrawal must be enabled
- No outstanding compliance issues</p>
<h3 id="repayment-functions">Repayment Functions<a class="headerlink" href="#repayment-functions" title="Permanent link">&para;</a></h3>
<h4 id="repaytradedeal"><code>repayTradeDeal()</code><a class="headerlink" href="#repaytradedeal" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">repayTradeDeal</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span>
</code></pre></div>

<p><strong>Purpose</strong>: Allows borrowers to repay trade deal obligations.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal
- <code>amount</code> (uint256): Amount to repay (in USDC)</p>
<p><strong>Access Control</strong>: Authorized repayers only</p>
<p><strong>Process</strong>:
1. Validates repayment parameters and authorization
2. Transfers repayment amount from caller
3. Updates trade deal outstanding balance
4. Calculates interest and principal allocation
5. Updates repayment tracking and status
6. Emits TradeDealRepaid event</p>
<p><strong>Events</strong>: <code>TradeDealRepaid(tradeDealId, repayer, amount, fullyRepaid)</code></p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Borrower makes partial repayment</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">repaymentAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">5000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">10</span><span class="o">**</span><span class="m m-Decimal">6</span><span class="p">;</span><span class="w"> </span><span class="c1">// 5,000 USDC</span>

<span class="c1">// First approve USDC transfer</span>
IERC20<span class="p">(</span>usdcToken<span class="p">).</span>approve<span class="p">(</span>diamond<span class="p">,</span><span class="w"> </span>repaymentAmount<span class="p">);</span>

<span class="c1">// Make repayment</span>
ITradeDealOperations<span class="p">(</span>diamond<span class="p">).</span>repayTradeDeal<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>repaymentAmount<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Repaid&quot;</span><span class="p">,</span><span class="w"> </span>repaymentAmount<span class="p">,</span><span class="w"> </span><span class="s2">&quot;to trade deal&quot;</span><span class="p">,</span><span class="w"> </span>tradeDealId<span class="p">);</span>
</code></pre></div>

<p><strong>Repayment Allocation</strong>:
- Interest payments processed first
- Principal reduction after interest
- Full repayment triggers completion status
- Partial repayments update outstanding balance</p>
<hr />
<h4 id="repaytradedealforborrower"><code>repayTradeDealForBorrower()</code><a class="headerlink" href="#repaytradedealforborrower" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">repayTradeDealForBorrower</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">borrower</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>onlyOwner
</code></pre></div>

<p><strong>Purpose</strong>: Allows admin to make repayments on behalf of borrowers.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal
- <code>borrower</code> (address): Address of the borrower
- <code>amount</code> (uint256): Amount to repay</p>
<p><strong>Access Control</strong>: Owner only</p>
<p><strong>Process</strong>:
1. Validates repayment parameters
2. Processes repayment on behalf of borrower
3. Updates trade deal records and status
4. Handles interest and principal allocation
5. Emits TradeDealRepaid event</p>
<p><strong>Events</strong>: <code>TradeDealRepaid(tradeDealId, repayer, amount, fullyRepaid)</code></p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Admin makes repayment for borrower</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="kt">address</span><span class="w"> </span><span class="nv">borrower</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x742d35Cc6634C0532925a3b8D0C9e3e0C8b0e5e1</span><span class="p">;</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">repaymentAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">10000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">10</span><span class="o">**</span><span class="m m-Decimal">6</span><span class="p">;</span><span class="w"> </span><span class="c1">// 10,000 USDC</span>

ITradeDealOperations<span class="p">(</span>diamond<span class="p">).</span>repayTradeDealForBorrower<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>borrower<span class="p">,</span><span class="w"> </span>repaymentAmount<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Admin repayment made for borrower:&quot;</span><span class="p">,</span><span class="w"> </span>borrower<span class="p">);</span>
</code></pre></div>

<h3 id="collateral-redemption-functions">Collateral Redemption Functions<a class="headerlink" href="#collateral-redemption-functions" title="Permanent link">&para;</a></h3>
<h4 id="redeemcollateraltokens"><code>redeemCollateralTokens()</code><a class="headerlink" href="#redeemcollateraltokens" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">redeemCollateralTokens</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralAmount</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span>
</code></pre></div>

<p><strong>Purpose</strong>: Allows collateral token holders to redeem tokens for USDC.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal
- <code>collateralAmount</code> (uint256): Amount of collateral tokens to redeem</p>
<p><strong>Access Control</strong>: Collateral token holders only</p>
<p><strong>Process</strong>:
1. Validates collateral redemption eligibility
2. Calculates USDC amount based on current redemption rate
3. Burns collateral tokens from caller
4. Transfers proportional USDC to caller
5. Updates trade deal collateral tracking
6. Emits CollateralTokensRedeemed event</p>
<p><strong>Events</strong>: <code>CollateralTokensRedeemed(tradeDealId, redeemer, collateralAmount, usdcAmount)</code></p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Redeem collateral tokens for USDC</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralToRedeem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">10</span><span class="o">**</span><span class="m m-Decimal">18</span><span class="p">;</span><span class="w"> </span><span class="c1">// 1,000 collateral tokens</span>

ITradeDealOperations<span class="p">(</span>diamond<span class="p">).</span>redeemCollateralTokens<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>collateralToRedeem<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Redeemed&quot;</span><span class="p">,</span><span class="w"> </span>collateralToRedeem<span class="p">,</span><span class="w"> </span><span class="s2">&quot;collateral tokens&quot;</span><span class="p">);</span>
</code></pre></div>

<p><strong>Redemption Calculation</strong>:
- USDC amount = (collateral tokens Ã— current USDC pool) Ã· total collateral tokens
- Redemption rate varies based on trade deal performance
- Interest distributions affect redemption value
- Early redemption may have different rates than maturity</p>
<h2 id="integration-examples">Integration Examples<a class="headerlink" href="#integration-examples" title="Permanent link">&para;</a></h2>
<h3 id="complete-trade-deal-lifecycle">Complete Trade Deal Lifecycle<a class="headerlink" href="#complete-trade-deal-lifecycle" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Comprehensive trade deal operations workflow</span>
<span class="k">contract</span><span class="w"> </span><span class="ni">TradeDealWorkflow</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">struct</span><span class="w"> </span><span class="nv">TradeDealState</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingTarget</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">currentFunding</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">outstandingBalance</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">fullyFunded</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">repaid</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span>TradeDealState<span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>tradeDealStates<span class="p">;</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">participateInTradeDeal</span><span class="p">(</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">usdcAmount</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>invoiceTokenIds
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Deposit invoices as collateral</span>
<span class="w">        </span><span class="kt">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span><span class="w"> </span>i<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>invoiceTokenIds<span class="p">.</span>length<span class="p">;</span><span class="w"> </span>i<span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>ITradeDealOperations<span class="p">(</span>diamond<span class="p">).</span>tdDepositInvoice<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>invoiceTokenIds<span class="p">[</span>i<span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Fund with USDC</span>
<span class="w">        </span>ITradeDealOperations<span class="p">(</span>diamond<span class="p">).</span>tdDepositUSDC<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>usdcAmount<span class="p">);</span>

<span class="w">        </span><span class="c1">// Update state tracking</span>
<span class="w">        </span>TradeDealState<span class="w"> </span>storage<span class="w"> </span>state<span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDealStates<span class="p">[</span>tradeDealId<span class="p">];</span>
<span class="w">        </span>state<span class="p">.</span>currentFunding<span class="w"> </span><span class="o">+=</span><span class="w"> </span>usdcAmount<span class="p">;</span>

<span class="w">        </span>emit<span class="w"> </span>ParticipationCompleted<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="k">msg.sender</span><span class="p">,</span><span class="w"> </span>usdcAmount<span class="p">,</span><span class="w"> </span>invoiceTokenIds<span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">borrowerWithdrawFunding</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>tradeDealStates<span class="p">[</span>tradeDealId<span class="p">].</span>fullyFunded<span class="p">,</span><span class="w"> </span><span class="s2">&quot;Not fully funded&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Borrower withdraws funding</span>
<span class="w">        </span>ITradeDealOperations<span class="p">(</span>diamond<span class="p">).</span>withdrawTradeDealFundingSelf<span class="p">(</span>tradeDealId<span class="p">);</span>

<span class="w">        </span><span class="c1">// Update state</span>
<span class="w">        </span>tradeDealStates<span class="p">[</span>tradeDealId<span class="p">].</span>outstandingBalance<span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDealStates<span class="p">[</span>tradeDealId<span class="p">].</span>currentFunding<span class="p">;</span>

<span class="w">        </span>emit<span class="w"> </span>FundingWithdrawn<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="k">msg.sender</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">makeRepayment</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Make repayment</span>
<span class="w">        </span>ITradeDealOperations<span class="p">(</span>diamond<span class="p">).</span>repayTradeDeal<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>amount<span class="p">);</span>

<span class="w">        </span><span class="c1">// Update state</span>
<span class="w">        </span>TradeDealState<span class="w"> </span>storage<span class="w"> </span>state<span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDealStates<span class="p">[</span>tradeDealId<span class="p">];</span>
<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>amount<span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span>state<span class="p">.</span>outstandingBalance<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>state<span class="p">.</span>repaid<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">true</span><span class="p">;</span>
<span class="w">            </span>state<span class="p">.</span>outstandingBalance<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="kt">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>state<span class="p">.</span>outstandingBalance<span class="w"> </span><span class="o">-=</span><span class="w"> </span>amount<span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span>emit<span class="w"> </span>RepaymentMade<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="k">msg.sender</span><span class="p">,</span><span class="w"> </span>amount<span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">redeemInvestment</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralAmount</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>tradeDealStates<span class="p">[</span>tradeDealId<span class="p">].</span>repaid<span class="p">,</span><span class="w"> </span><span class="s2">&quot;Trade deal not repaid&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Redeem collateral tokens</span>
<span class="w">        </span>ITradeDealOperations<span class="p">(</span>diamond<span class="p">).</span>redeemCollateralTokens<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>collateralAmount<span class="p">);</span>

<span class="w">        </span>emit<span class="w"> </span>InvestmentRedeemed<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="k">msg.sender</span><span class="p">,</span><span class="w"> </span>collateralAmount<span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="automated-repayment-system">Automated Repayment System<a class="headerlink" href="#automated-repayment-system" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Automated repayment scheduling and processing</span>
<span class="k">contract</span><span class="w"> </span><span class="ni">AutomatedRepaymentSystem</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">struct</span><span class="w"> </span><span class="nv">RepaymentSchedule</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalAmount</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">installmentAmount</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">frequency</span><span class="p">;</span><span class="w"> </span><span class="c1">// in seconds</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">nextPaymentDue</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">remainingPayments</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">active</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span>RepaymentSchedule<span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>repaymentSchedules<span class="p">;</span>
<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">uint256</span><span class="p">[])</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>borrowerTradeDealIds<span class="p">;</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">setupRepaymentSchedule</span><span class="p">(</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalAmount</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">numberOfPayments</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">frequency</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>onlyAuthorizedBorrower<span class="p">(</span>tradeDealId<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">installmentAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>totalAmount<span class="w"> </span><span class="o">/</span><span class="w"> </span>numberOfPayments<span class="p">;</span>

<span class="w">        </span>repaymentSchedules<span class="p">[</span>tradeDealId<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>RepaymentSchedule<span class="p">({</span>
<span class="w">            </span>tradeDealId<span class="o">:</span><span class="w"> </span>tradeDealId<span class="p">,</span>
<span class="w">            </span>totalAmount<span class="o">:</span><span class="w"> </span>totalAmount<span class="p">,</span>
<span class="w">            </span>installmentAmount<span class="o">:</span><span class="w"> </span>installmentAmount<span class="p">,</span>
<span class="w">            </span>frequency<span class="o">:</span><span class="w"> </span>frequency<span class="p">,</span>
<span class="w">            </span>nextPaymentDue<span class="o">:</span><span class="w"> </span><span class="k">block.timestamp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>frequency<span class="p">,</span>
<span class="w">            </span>remainingPayments<span class="o">:</span><span class="w"> </span>numberOfPayments<span class="p">,</span>
<span class="w">            </span>active<span class="o">:</span><span class="w"> </span><span class="kt">true</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span>borrowerTradeDealIds<span class="p">[</span><span class="k">msg.sender</span><span class="p">].</span>push<span class="p">(</span>tradeDealId<span class="p">);</span>

<span class="w">        </span>emit<span class="w"> </span>RepaymentScheduleCreated<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>totalAmount<span class="p">,</span><span class="w"> </span>numberOfPayments<span class="p">,</span><span class="w"> </span>frequency<span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">executeScheduledRepayment</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>RepaymentSchedule<span class="w"> </span>storage<span class="w"> </span>schedule<span class="w"> </span><span class="o">=</span><span class="w"> </span>repaymentSchedules<span class="p">[</span>tradeDealId<span class="p">];</span>

<span class="w">        </span><span class="kt">require</span><span class="p">(</span>schedule<span class="p">.</span>active<span class="p">,</span><span class="w"> </span><span class="s2">&quot;Schedule not active&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span><span class="k">block.timestamp</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span>schedule<span class="p">.</span>nextPaymentDue<span class="p">,</span><span class="w"> </span><span class="s2">&quot;Payment not due yet&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>schedule<span class="p">.</span>remainingPayments<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;All payments completed&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Execute repayment</span>
<span class="w">        </span>ITradeDealOperations<span class="p">(</span>diamond<span class="p">).</span>repayTradeDeal<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>schedule<span class="p">.</span>installmentAmount<span class="p">);</span>

<span class="w">        </span><span class="c1">// Update schedule</span>
<span class="w">        </span>schedule<span class="p">.</span>remainingPayments<span class="o">--</span><span class="p">;</span>
<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>schedule<span class="p">.</span>remainingPayments<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>schedule<span class="p">.</span>nextPaymentDue<span class="w"> </span><span class="o">+=</span><span class="w"> </span>schedule<span class="p">.</span>frequency<span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="kt">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>schedule<span class="p">.</span>active<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span>emit<span class="w"> </span>ScheduledRepaymentExecuted<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>schedule<span class="p">.</span>installmentAmount<span class="p">,</span><span class="w"> </span>schedule<span class="p">.</span>remainingPayments<span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">getOverduePayments</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">borrower</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>tradeDealIds<span class="w"> </span><span class="o">=</span><span class="w"> </span>borrowerTradeDealIds<span class="p">[</span>borrower<span class="p">];</span>
<span class="w">        </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>overdueIds<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="kt">uint256</span><span class="p">[](</span>tradeDealIds<span class="p">.</span>length<span class="p">);</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">overdueCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>

<span class="w">        </span><span class="kt">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span><span class="w"> </span>i<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>tradeDealIds<span class="p">.</span>length<span class="p">;</span><span class="w"> </span>i<span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>RepaymentSchedule<span class="w"> </span><span class="kt">memory</span><span class="w"> </span>schedule<span class="w"> </span><span class="o">=</span><span class="w"> </span>repaymentSchedules<span class="p">[</span>tradeDealIds<span class="p">[</span>i<span class="p">]];</span>
<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>schedule<span class="p">.</span>active<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">block.timestamp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>schedule<span class="p">.</span>nextPaymentDue<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span>overdueIds<span class="p">[</span>overdueCount<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDealIds<span class="p">[</span>i<span class="p">];</span>
<span class="w">                </span>overdueCount<span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Resize array to actual count</span>
<span class="w">        </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>result<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="kt">uint256</span><span class="p">[](</span>overdueCount<span class="p">);</span>
<span class="w">        </span><span class="kt">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span><span class="w"> </span>i<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>overdueCount<span class="p">;</span><span class="w"> </span>i<span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>result<span class="p">[</span>i<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>overdueIds<span class="p">[</span>i<span class="p">];</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kt">return</span><span class="w"> </span>result<span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="collateral-management-system">Collateral Management System<a class="headerlink" href="#collateral-management-system" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Advanced collateral tracking and management</span>
<span class="k">contract</span><span class="w"> </span><span class="ni">CollateralManagementSystem</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">struct</span><span class="w"> </span><span class="nv">CollateralPosition</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralTokens</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">originalUSDCDeposit</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">accruedInterest</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">lastInterestUpdate</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span>CollateralPosition<span class="p">))</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>positions<span class="p">;</span>
<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>totalCollateralTokens<span class="p">;</span>
<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>totalUSDCPool<span class="p">;</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">trackCollateralDeposit</span><span class="p">(</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span>
<span class="w">        </span><span class="kt">address</span><span class="w"> </span><span class="nv">depositor</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">usdcAmount</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralTokens</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>onlyAuthorized<span class="w"> </span><span class="p">{</span>
<span class="w">        </span>CollateralPosition<span class="w"> </span>storage<span class="w"> </span>position<span class="w"> </span><span class="o">=</span><span class="w"> </span>positions<span class="p">[</span>depositor<span class="p">][</span>tradeDealId<span class="p">];</span>

<span class="w">        </span>position<span class="p">.</span>tradeDealId<span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDealId<span class="p">;</span>
<span class="w">        </span>position<span class="p">.</span>collateralTokens<span class="w"> </span><span class="o">+=</span><span class="w"> </span>collateralTokens<span class="p">;</span>
<span class="w">        </span>position<span class="p">.</span>originalUSDCDeposit<span class="w"> </span><span class="o">+=</span><span class="w"> </span>usdcAmount<span class="p">;</span>
<span class="w">        </span>position<span class="p">.</span>lastInterestUpdate<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">block.timestamp</span><span class="p">;</span>

<span class="w">        </span>totalCollateralTokens<span class="p">[</span>tradeDealId<span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>collateralTokens<span class="p">;</span>
<span class="w">        </span>totalUSDCPool<span class="p">[</span>tradeDealId<span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>usdcAmount<span class="p">;</span>

<span class="w">        </span>emit<span class="w"> </span>CollateralPositionUpdated<span class="p">(</span>depositor<span class="p">,</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span>position<span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">calculateRedemptionValue</span><span class="p">(</span>
<span class="w">        </span><span class="kt">address</span><span class="w"> </span><span class="nv">holder</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralAmount</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">usdcAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">interestAmount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>CollateralPosition<span class="w"> </span><span class="kt">memory</span><span class="w"> </span>position<span class="w"> </span><span class="o">=</span><span class="w"> </span>positions<span class="p">[</span>holder<span class="p">][</span>tradeDealId<span class="p">];</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>position<span class="p">.</span>collateralTokens<span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span>collateralAmount<span class="p">,</span><span class="w"> </span><span class="s2">&quot;Insufficient collateral&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Calculate proportional USDC</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalCollateral</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>totalCollateralTokens<span class="p">[</span>tradeDealId<span class="p">];</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalUSDC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>totalUSDCPool<span class="p">[</span>tradeDealId<span class="p">];</span>

<span class="w">        </span>usdcAmount<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>collateralAmount<span class="w"> </span><span class="o">*</span><span class="w"> </span>totalUSDC<span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span>totalCollateral<span class="p">;</span>

<span class="w">        </span><span class="c1">// Calculate accrued interest</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">proportionalInterest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>position<span class="p">.</span>accruedInterest<span class="w"> </span><span class="o">*</span><span class="w"> </span>collateralAmount<span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span>position<span class="p">.</span>collateralTokens<span class="p">;</span>
<span class="w">        </span>interestAmount<span class="w"> </span><span class="o">=</span><span class="w"> </span>proportionalInterest<span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">executeRedemption</span><span class="p">(</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralAmount</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">usdcAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">interestAmount</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>calculateRedemptionValue<span class="p">(</span>
<span class="w">            </span><span class="k">msg.sender</span><span class="p">,</span>
<span class="w">            </span>tradeDealId<span class="p">,</span>
<span class="w">            </span>collateralAmount
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Execute redemption through operations facet</span>
<span class="w">        </span>ITradeDealOperations<span class="p">(</span>diamond<span class="p">).</span>redeemCollateralTokens<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>collateralAmount<span class="p">);</span>

<span class="w">        </span><span class="c1">// Update position tracking</span>
<span class="w">        </span>CollateralPosition<span class="w"> </span>storage<span class="w"> </span>position<span class="w"> </span><span class="o">=</span><span class="w"> </span>positions<span class="p">[</span><span class="k">msg.sender</span><span class="p">][</span>tradeDealId<span class="p">];</span>
<span class="w">        </span>position<span class="p">.</span>collateralTokens<span class="w"> </span><span class="o">-=</span><span class="w"> </span>collateralAmount<span class="p">;</span>
<span class="w">        </span>position<span class="p">.</span>accruedInterest<span class="w"> </span><span class="o">-=</span><span class="w"> </span>interestAmount<span class="p">;</span>

<span class="w">        </span>totalCollateralTokens<span class="p">[</span>tradeDealId<span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span>collateralAmount<span class="p">;</span>
<span class="w">        </span>totalUSDCPool<span class="p">[</span>tradeDealId<span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span>usdcAmount<span class="p">;</span>

<span class="w">        </span>emit<span class="w"> </span>RedemptionExecuted<span class="p">(</span><span class="k">msg.sender</span><span class="p">,</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span>collateralAmount<span class="p">,</span><span class="w"> </span>usdcAmount<span class="p">,</span><span class="w"> </span>interestAmount<span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">getPositionSummary</span><span class="p">(</span>
<span class="w">        </span><span class="kt">address</span><span class="w"> </span><span class="nv">holder</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralTokens</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">currentValue</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">originalDeposit</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalReturn</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">returnPercentage</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>CollateralPosition<span class="w"> </span><span class="kt">memory</span><span class="w"> </span>position<span class="w"> </span><span class="o">=</span><span class="w"> </span>positions<span class="p">[</span>holder<span class="p">][</span>tradeDealId<span class="p">];</span>

<span class="w">        </span>collateralTokens<span class="w"> </span><span class="o">=</span><span class="w"> </span>position<span class="p">.</span>collateralTokens<span class="p">;</span>
<span class="w">        </span>originalDeposit<span class="w"> </span><span class="o">=</span><span class="w"> </span>position<span class="p">.</span>originalUSDCDeposit<span class="p">;</span>

<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>collateralTokens<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">(</span>currentValue<span class="p">,)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>calculateRedemptionValue<span class="p">(</span>holder<span class="p">,</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span>collateralTokens<span class="p">);</span>
<span class="w">            </span>totalReturn<span class="w"> </span><span class="o">=</span><span class="w"> </span>currentValue<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>originalDeposit<span class="w"> </span><span class="o">?</span><span class="w"> </span>currentValue<span class="w"> </span><span class="o">-</span><span class="w"> </span>originalDeposit<span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
<span class="w">            </span>returnPercentage<span class="w"> </span><span class="o">=</span><span class="w"> </span>originalDeposit<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span>totalReturn<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">10000</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span>originalDeposit<span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// basis points</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="invoice-collateral-tracker">Invoice Collateral Tracker<a class="headerlink" href="#invoice-collateral-tracker" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Track invoice collateral deposits and withdrawals</span>
<span class="k">contract</span><span class="w"> </span><span class="ni">InvoiceCollateralTracker</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">struct</span><span class="w"> </span><span class="nv">InvoiceCollateral</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tokenId</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">;</span>
<span class="w">        </span><span class="kt">address</span><span class="w"> </span><span class="nv">depositor</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">depositTime</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">invoiceValue</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">active</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span>InvoiceCollateral<span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>invoiceCollaterals<span class="p">;</span>
<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">uint256</span><span class="p">[])</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>tradeDealInvoices<span class="p">;</span>
<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">uint256</span><span class="p">[])</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>depositorInvoices<span class="p">;</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">trackInvoiceDeposit</span><span class="p">(</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tokenId</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span>
<span class="w">        </span><span class="kt">address</span><span class="w"> </span><span class="nv">depositor</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">invoiceValue</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>onlyAuthorized<span class="w"> </span><span class="p">{</span>
<span class="w">        </span>invoiceCollaterals<span class="p">[</span>tokenId<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>InvoiceCollateral<span class="p">({</span>
<span class="w">            </span>tokenId<span class="o">:</span><span class="w"> </span>tokenId<span class="p">,</span>
<span class="w">            </span>tradeDealId<span class="o">:</span><span class="w"> </span>tradeDealId<span class="p">,</span>
<span class="w">            </span>depositor<span class="o">:</span><span class="w"> </span>depositor<span class="p">,</span>
<span class="w">            </span>depositTime<span class="o">:</span><span class="w"> </span><span class="k">block.timestamp</span><span class="p">,</span>
<span class="w">            </span>invoiceValue<span class="o">:</span><span class="w"> </span>invoiceValue<span class="p">,</span>
<span class="w">            </span>active<span class="o">:</span><span class="w"> </span><span class="kt">true</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span>tradeDealInvoices<span class="p">[</span>tradeDealId<span class="p">].</span>push<span class="p">(</span>tokenId<span class="p">);</span>
<span class="w">        </span>depositorInvoices<span class="p">[</span>depositor<span class="p">].</span>push<span class="p">(</span>tokenId<span class="p">);</span>

<span class="w">        </span>emit<span class="w"> </span>InvoiceCollateralTracked<span class="p">(</span>tokenId<span class="p">,</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span>depositor<span class="p">,</span><span class="w"> </span>invoiceValue<span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">executeInvoiceDeposit</span><span class="p">(</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tokenId</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">invoiceValue</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Execute deposit through operations facet</span>
<span class="w">        </span>ITradeDealOperations<span class="p">(</span>diamond<span class="p">).</span>tdDepositInvoice<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>tokenId<span class="p">);</span>

<span class="w">        </span><span class="c1">// Track the deposit</span>
<span class="w">        </span>trackInvoiceDeposit<span class="p">(</span>tokenId<span class="p">,</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="k">msg.sender</span><span class="p">,</span><span class="w"> </span>invoiceValue<span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">executeInvoiceWithdrawal</span><span class="p">(</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tokenId</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>invoiceCollaterals<span class="p">[</span>tokenId<span class="p">].</span>depositor<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">msg.sender</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Not depositor&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>invoiceCollaterals<span class="p">[</span>tokenId<span class="p">].</span>active<span class="p">,</span><span class="w"> </span><span class="s2">&quot;Invoice not active&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Execute withdrawal through operations facet</span>
<span class="w">        </span>ITradeDealOperations<span class="p">(</span>diamond<span class="p">).</span>tdWithdrawInvoice<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>tokenId<span class="p">);</span>

<span class="w">        </span><span class="c1">// Update tracking</span>
<span class="w">        </span>invoiceCollaterals<span class="p">[</span>tokenId<span class="p">].</span>active<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">false</span><span class="p">;</span>

<span class="w">        </span>emit<span class="w"> </span>InvoiceWithdrawn<span class="p">(</span>tokenId<span class="p">,</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="k">msg.sender</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">getTradeDealCollateralValue</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>invoiceIds<span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDealInvoices<span class="p">[</span>tradeDealId<span class="p">];</span>

<span class="w">        </span><span class="kt">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span><span class="w"> </span>i<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>invoiceIds<span class="p">.</span>length<span class="p">;</span><span class="w"> </span>i<span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>InvoiceCollateral<span class="w"> </span><span class="kt">memory</span><span class="w"> </span>collateral<span class="w"> </span><span class="o">=</span><span class="w"> </span>invoiceCollaterals<span class="p">[</span>invoiceIds<span class="p">[</span>i<span class="p">]];</span>
<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>collateral<span class="p">.</span>active<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span>totalValue<span class="w"> </span><span class="o">+=</span><span class="w"> </span>collateral<span class="p">.</span>invoiceValue<span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">getDepositorCollateral</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">depositor</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>tokenIds<span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>tradeDealIds<span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>values<span class="p">,</span>
<span class="w">        </span><span class="kt">bool</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>activeStatus
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>depositorTokenIds<span class="w"> </span><span class="o">=</span><span class="w"> </span>depositorInvoices<span class="p">[</span>depositor<span class="p">];</span>

<span class="w">        </span>tokenIds<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="kt">uint256</span><span class="p">[](</span>depositorTokenIds<span class="p">.</span>length<span class="p">);</span>
<span class="w">        </span>tradeDealIds<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="kt">uint256</span><span class="p">[](</span>depositorTokenIds<span class="p">.</span>length<span class="p">);</span>
<span class="w">        </span>values<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="kt">uint256</span><span class="p">[](</span>depositorTokenIds<span class="p">.</span>length<span class="p">);</span>
<span class="w">        </span>activeStatus<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="kt">bool</span><span class="p">[](</span>depositorTokenIds<span class="p">.</span>length<span class="p">);</span>

<span class="w">        </span><span class="kt">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span><span class="w"> </span>i<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>depositorTokenIds<span class="p">.</span>length<span class="p">;</span><span class="w"> </span>i<span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>InvoiceCollateral<span class="w"> </span><span class="kt">memory</span><span class="w"> </span>collateral<span class="w"> </span><span class="o">=</span><span class="w"> </span>invoiceCollaterals<span class="p">[</span>depositorTokenIds<span class="p">[</span>i<span class="p">]];</span>
<span class="w">            </span>tokenIds<span class="p">[</span>i<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>collateral<span class="p">.</span>tokenId<span class="p">;</span>
<span class="w">            </span>tradeDealIds<span class="p">[</span>i<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>collateral<span class="p">.</span>tradeDealId<span class="p">;</span>
<span class="w">            </span>values<span class="p">[</span>i<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>collateral<span class="p">.</span>invoiceValue<span class="p">;</span>
<span class="w">            </span>activeStatus<span class="p">[</span>i<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>collateral<span class="p">.</span>active<span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="events">Events<a class="headerlink" href="#events" title="Permanent link">&para;</a></h2>
<h3 id="invoice-management-events">Invoice Management Events<a class="headerlink" href="#invoice-management-events" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="kt">event</span><span class="w"> </span><span class="nv">InvoiceDepositedToTradeDeal</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tokenId<span class="p">);</span>
<span class="kt">event</span><span class="w"> </span><span class="nv">InvoiceWithdrawnFromTradeDeal</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tokenId<span class="p">);</span>
</code></pre></div>

<h3 id="usdc-funding-events">USDC Funding Events<a class="headerlink" href="#usdc-funding-events" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="kt">event</span><span class="w"> </span><span class="nv">USDCDepositedToTradeDeal</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">depositor</span><span class="p">);</span>
<span class="kt">event</span><span class="w"> </span><span class="nv">USDCWithdrawnFromTradeDeal</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">);</span>
<span class="kt">event</span><span class="w"> </span><span class="nv">TradeDealFullyFunded</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingTarget</span><span class="p">);</span>
<span class="kt">event</span><span class="w"> </span><span class="nv">CollateralTokensDistributed</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>recipient<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">);</span>
</code></pre></div>

<h3 id="funding-withdrawal-events">Funding Withdrawal Events<a class="headerlink" href="#funding-withdrawal-events" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="kt">event</span><span class="w"> </span><span class="nv">TradeDealFundingWithdrawn</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>recipient<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">);</span>
</code></pre></div>

<h3 id="repayment-events">Repayment Events<a class="headerlink" href="#repayment-events" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="kt">event</span><span class="w"> </span><span class="nv">TradeDealRepaid</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>repayer<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nv">fullyRepaid</span><span class="p">);</span>
</code></pre></div>

<h3 id="redemption-events">Redemption Events<a class="headerlink" href="#redemption-events" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="kt">event</span><span class="w"> </span><span class="nv">CollateralTokensRedeemed</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>redeemer<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">usdcAmount</span><span class="p">);</span>
</code></pre></div>

<h2 id="security-considerations">Security Considerations<a class="headerlink" href="#security-considerations" title="Permanent link">&para;</a></h2>
<h3 id="access-control">Access Control<a class="headerlink" href="#access-control" title="Permanent link">&para;</a></h3>
<ul>
<li>Participant validation for invoice operations</li>
<li>Owner-only functions for admin operations</li>
<li>Borrower authorization for funding withdrawals</li>
<li>Collateral token holder validation for redemptions</li>
</ul>
<h3 id="financial-security">Financial Security<a class="headerlink" href="#financial-security" title="Permanent link">&para;</a></h3>
<ul>
<li>Precise amount calculations and validations</li>
<li>Overflow protection for large transactions</li>
<li>Token transfer authorization checks</li>
<li>Balance verification before operations</li>
</ul>
<h3 id="operational-security">Operational Security<a class="headerlink" href="#operational-security" title="Permanent link">&para;</a></h3>
<ul>
<li>Trade deal state validation before operations</li>
<li>Invoice ownership verification</li>
<li>Funding availability checks</li>
<li>Repayment authorization validation</li>
</ul>
<h2 id="gas-optimization">Gas Optimization<a class="headerlink" href="#gas-optimization" title="Permanent link">&para;</a></h2>
<h3 id="efficient-operations">Efficient Operations<a class="headerlink" href="#efficient-operations" title="Permanent link">&para;</a></h3>
<ul>
<li>Batch invoice deposits when possible</li>
<li>Optimize token transfer operations</li>
<li>Minimize storage updates</li>
<li>Use events for off-chain tracking</li>
</ul>
<h3 id="storage-optimization">Storage Optimization<a class="headerlink" href="#storage-optimization" title="Permanent link">&para;</a></h3>
<ul>
<li>Pack related data efficiently</li>
<li>Use mappings for participant tracking</li>
<li>Cache frequently accessed values</li>
<li>Optimize collateral calculations</li>
</ul>
<h2 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h2>
<h3 id="common-errors">Common Errors<a class="headerlink" href="#common-errors" title="Permanent link">&para;</a></h3>
<ul>
<li>Insufficient balances or allowances</li>
<li>Invalid trade deal states</li>
<li>Unauthorized operations</li>
<li>Invoice ownership mismatches</li>
<li>Funding availability issues</li>
</ul>
<h3 id="best-practices">Best Practices<a class="headerlink" href="#best-practices" title="Permanent link">&para;</a></h3>
<ul>
<li>Validate all inputs before processing</li>
<li>Check authorization before</li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../trade-deal-admin-facet/" class="btn btn-neutral float-left" title="Trade Deal Admin Facet"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../collateral-token-factory-facet/" class="btn btn-neutral float-right" title="Collateral Token Factory Facet">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../trade-deal-admin-facet/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../collateral-token-factory-facet/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
