<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Gemforce Team" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>ITradeDeal - Gemforce Documentation</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "ITradeDeal";
        var mkdocs_page_input_path = "smart-contracts/interfaces/itradedeal.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> Gemforce Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../developer-setup-guide/">Developer Setup Guide</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../system-architecture/gemforce-system-architecture/">System Architecture</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Smart Contracts</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../../">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../diamond/">Diamond Contract</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../diamond-factory/">Diamond Factory</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../identity-factory/">Identity Factory</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Facets</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../facets/marketplace-facet/">Marketplace Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../facets/trade-deal-management-facet/">Trade Deal Management Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../facets/carbon-credit-facet/">Carbon Credit Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../facets/identity-registry-facet/">Identity Registry Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../facets/trusted-issuers-registry-facet/">Trusted Issuers Registry Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../facets/fee-distributor-facet/">Fee Distributor Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../facets/gemforce-minter-facet/">Gemforce Minter Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../facets/multi-sale-facet/">Multi Sale Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../facets/svg-templates-facet/">SVG Templates Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../facets/trade-deal-admin-facet/">Trade Deal Admin Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../facets/trade-deal-operations-facet/">Trade Deal Operations Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../facets/collateral-token-factory-facet/">Collateral Token Factory Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../facets/diamond-cut-facet/">Diamond Cut Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../facets/diamond-loupe-facet/">Diamond Loupe Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../facets/ownership-facet/">Ownership Facet</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >Interfaces</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../idiamond/">IDiamond</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../imarketplace/">IMarketplace</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">ITradeDeal</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#interface-details">Interface Details</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#key-features">Key Features</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#trade-deal-lifecycle-management">ðŸ”¹ Trade Deal Lifecycle Management</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#collateral-and-funding-operations">ðŸ”¹ Collateral and Funding Operations</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#interest-and-fee-management">ðŸ”¹ Interest and Fee Management</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#participant-and-access-control">ðŸ”¹ Participant and Access Control</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#repayment-and-settlement">ðŸ”¹ Repayment and Settlement</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#core-functions">Core Functions</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#trade-deal-management-functions">Trade Deal Management Functions</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#collateral-and-funding-functions">Collateral and Funding Functions</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#interest-and-fee-management-functions">Interest and Fee Management Functions</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#repayment-functions">Repayment Functions</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#participant-management-functions">Participant Management Functions</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#query-functions">Query Functions</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#status-check-functions">Status Check Functions</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#integration-examples">Integration Examples</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#complete-trade-deal-workflow">Complete Trade Deal Workflow</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#trade-deal-analytics-dashboard">Trade Deal Analytics Dashboard</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#automated-trade-deal-manager">Automated Trade Deal Manager</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#trade-deal-analytics-dashboard_1">Trade Deal Analytics Dashboard</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#automated-trade-deal-manager_1">Automated Trade Deal Manager</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#events">Events</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#trade-deal-lifecycle-events">Trade Deal Lifecycle Events</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#participant-management-events">Participant Management Events</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#collateral-and-funding-events">Collateral and Funding Events</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#interest-and-fee-events">Interest and Fee Events</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#repayment-and-settlement-events">Repayment and Settlement Events</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#security-considerations">Security Considerations</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#access-control">Access Control</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#financial-security">Financial Security</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#operational-security">Operational Security</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#gas-optimization">Gas Optimization</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#efficient-operations">Efficient Operations</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#storage-optimization">Storage Optimization</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#error-handling">Error Handling</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#common-errors">Common Errors</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#best-practices">Best Practices</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#testing-considerations">Testing Considerations</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#unit-tests">Unit Tests</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#integration-tests">Integration Tests</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#related-documentation">Related Documentation</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../icarbon-credit/">ICarbonCredit</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ierc1155-mint/">IERC1155Mint</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ierc734/">IERC734</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ierc735/">IERC735</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ierc721a/">IERC721A</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../idiamond-factory/">IDiamondFactory</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../iidentity/">IIdentity</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../imultisale/">IMultiSale</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ifee-distributor/">IFeeDistributor</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../igemforce-minter-facet/">IGemforceMinterFacet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../iidentity-registry/">IIdentityRegistry</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../itrusted-issuers-registry/">TRUSTEDIssuersRegistry</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../isvg/">ISVG</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../iattribute/">IAttribute</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Libraries</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/carbon-credit-lib/">Carbon Credit Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/trade-deal-lib/">Trade Deal Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/multi-sale-lib/">Multi Sale Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/diamond-factory-lib/">Diamond Factory Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/svg-templates-lib/">SVG Templates Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/attribute-lib/">Attribute Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/variable-price-lib/">Variable Price Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/merkle-prover/">Merkle Prover</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/fee-distributor-lib/">Fee Distributor Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/lib-diamond/">LibDiamond</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/diamond-lib/">DiamondLib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/erc721a-lib/">ERC721A Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/erc721a-enumeration-lib/">ERC721A Enumeration Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/strings-lib/">Strings Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/trusted-issuer-lib/">Trusted Issuer Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../libraries/set-libraries/">Set Libraries</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SDK & Libraries</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../sdk-libraries/blockchain/">Blockchain Utilities</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../sdk-libraries/diamond/">Diamond Utilities</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../sdk-libraries/contract/">Contract Utilities</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../sdk-libraries/deploy/">Deployment Utilities</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../sdk-libraries/validation-utils/">Validation Utilities</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../sdk-libraries/nft-sale-utils/">NFT Sale Utilities</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Cloud Functions</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/authentication/">Authentication Functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/auth-functions/">Auth Functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/blockchain/">Blockchain Functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/bridge/">Bridge Functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/contracts/">Contract Functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/deploy/">Deploy Functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/dfns/">DFNS Functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/project/">Project Functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/trade-deal/">Trade Deal Functions</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API Documentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api-documentation/gemforce-api-documentation/">Full API Reference</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api-documentation/gemforce-api-quick-reference/">Quick Reference</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Operations Tasks</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/tasks/diamond/">Diamond Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/tasks/identities/">Identity Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/tasks/marketplace-management/">Marketplace Management Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/tasks/carbon-credit-management/">Carbon Credit Management Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/tasks/trade-deal/">Trade Deal Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/tasks/integration-test/">Integration Test Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/tasks/integration-test-marketplace/">Marketplace Integration Test Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/tasks/integration-test-trade-deal/">Trade Deal Integration Test Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/tasks/admin-utils/">Admin Utilities</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/tasks/sync-diamond/">Sync Diamond Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cloud-functions/tasks/sync-events/">Sync Events Tasks</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">EIPs (Ethereum Improvement Proposals)</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../eips/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../eips/EIP-DRAFT-Diamond-Enhanced-Marketplace/">Diamond-Enhanced Marketplace</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../eips/EIP-DRAFT-Multi-Token-Sale-Standard/">Multi-Token Sale Standard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../eips/EIP-DRAFT-Collateralized-Trade-Deal-Standard/">Collateralized Trade Deal Standard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../eips/EIP-DRAFT-Enhanced-Identity-System/">Enhanced Identity System</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../eips/EIP-DRAFT-Diamond-Factory-Standard/">Diamond Factory Standard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../eips/EIP-DRAFT-Carbon-Credit-Standard/">Carbon Credit Standard</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">User Guides</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../gemforce-administrator-guide/">Administrator Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../gemforce-deployer-guide/">Deployer Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../gemforce-integrator-guide/">Integrator Guide</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Integrator's Guide</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../integrator-guide/overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../integrator-guide/authentication/">Authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../integrator-guide/rest-api/">REST API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../integrator-guide/smart-contracts/">Smart Contracts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../integrator-guide/dfns/">DFNS Integration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../integrator-guide/webhooks/">Webhooks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../integrator-guide/error-handling/">Error Handling</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../integrator-guide/sample-code/">Sample Code</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../integrator-guide/integration-patterns/">Integration Patterns</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../integrator-guide/security/">Security</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../external-services/gemforce-external-services/">External Services</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../gemforce-documentation-gap-analysis/">Documentation Gap Analysis</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../documentation-progress-summary/">Documentation Progress Summary</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../documentation-plan/">Documentation Plan</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">Gemforce Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Smart Contracts</li>
          <li class="breadcrumb-item">Interfaces</li>
      <li class="breadcrumb-item active">ITradeDeal</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="itradedeal-interface">ITradeDeal Interface<a class="headerlink" href="#itradedeal-interface" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>The <a href="/Users/sschepis/Development/gem-base/contracts/interfaces/ITradeDeal.sol"><code>ITradeDeal.sol</code></a> defines the comprehensive interface for trade deal functionality within the Gemforce platform. This interface establishes the standard contract for creating, managing, and operating collateralized trade deals with invoice backing, USDC funding, interest distribution, and participant management.</p>
<h2 id="interface-details">Interface Details<a class="headerlink" href="#interface-details" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Interface Name</strong>: <code>ITradeDeal</code></li>
<li><strong>License</strong>: MIT</li>
<li><strong>Solidity Version</strong>: ^0.8.0</li>
</ul>
<h2 id="key-features">Key Features<a class="headerlink" href="#key-features" title="Permanent link">&para;</a></h2>
<h3 id="trade-deal-lifecycle-management">ðŸ”¹ Trade Deal Lifecycle Management<a class="headerlink" href="#trade-deal-lifecycle-management" title="Permanent link">&para;</a></h3>
<ul>
<li>Create and configure trade deals with flexible parameters</li>
<li>Activate and deactivate trade deals</li>
<li>Update trade deal settings and token addresses</li>
<li>Comprehensive status tracking and reporting</li>
</ul>
<h3 id="collateral-and-funding-operations">ðŸ”¹ Collateral and Funding Operations<a class="headerlink" href="#collateral-and-funding-operations" title="Permanent link">&para;</a></h3>
<ul>
<li>Invoice deposit and withdrawal as collateral</li>
<li>USDC funding with automatic collateral token distribution</li>
<li>Funding withdrawal for borrowers</li>
<li>Collateral token redemption system</li>
</ul>
<h3 id="interest-and-fee-management">ðŸ”¹ Interest and Fee Management<a class="headerlink" href="#interest-and-fee-management" title="Permanent link">&para;</a></h3>
<ul>
<li>Automated interest calculation and distribution</li>
<li>Multi-pool interest allocation</li>
<li>Fee distribution to configured receivers</li>
<li>Interest token minting and management</li>
</ul>
<h3 id="participant-and-access-control">ðŸ”¹ Participant and Access Control<a class="headerlink" href="#participant-and-access-control" title="Permanent link">&para;</a></h3>
<ul>
<li>Participant addition and removal</li>
<li>Identity verification through claim topics</li>
<li>Role-based access control</li>
<li>Participant validation for operations</li>
</ul>
<h3 id="repayment-and-settlement">ðŸ”¹ Repayment and Settlement<a class="headerlink" href="#repayment-and-settlement" title="Permanent link">&para;</a></h3>
<ul>
<li>Flexible repayment processing</li>
<li>Partial and full repayment support</li>
<li>Automated settlement calculations</li>
<li>Repayment tracking and validation</li>
</ul>
<h2 id="core-functions">Core Functions<a class="headerlink" href="#core-functions" title="Permanent link">&para;</a></h2>
<h3 id="trade-deal-management-functions">Trade Deal Management Functions<a class="headerlink" href="#trade-deal-management-functions" title="Permanent link">&para;</a></h3>
<h4 id="createtradedeal"><code>createTradeDeal()</code><a class="headerlink" href="#createtradedeal" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">createTradeDeal</span><span class="p">(</span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="nv">memory</span><span class="w"> </span>name<span class="p">,</span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="nv">memory</span><span class="w"> </span>symbol<span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">interestRate</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralToInterestRatio</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>requiredClaimTopics<span class="p">,</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">collateralAddress</span><span class="p">,</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">interestAddress</span><span class="p">,</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">usdcAddress</span><span class="p">,</span>
<span class="w">    </span>TradeDealLib<span class="p">.</span>OperationMode<span class="w"> </span>operationMode
<span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">)</span>
</code></pre></div>

<p><strong>Purpose</strong>: Creates a new trade deal with specified configuration parameters.</p>
<p><strong>Parameters</strong>:
- <code>name</code> (string): Human-readable name for the trade deal
- <code>symbol</code> (string): Symbol for the trade deal's collateral token
- <code>interestRate</code> (uint256): Interest rate in basis points (100 = 1%)
- <code>collateralToInterestRatio</code> (uint256): Conversion ratio for collateral to interest tokens
- <code>requiredClaimTopics</code> (uint256[]): Array of claim topic IDs required for participation
- <code>collateralAddress</code> (address): Address of the collateral token contract
- <code>interestAddress</code> (address): Address of the interest token contract
- <code>usdcAddress</code> (address): Address of the USDC token contract
- <code>operationMode</code> (TradeDealLib.OperationMode): Operation mode for the trade deal</p>
<p><strong>Returns</strong>:
- <code>uint256</code>: Unique identifier for the newly created trade deal</p>
<p><strong>Events</strong>: <code>TradeDealCreated(tradeDealId, name, symbol, interestRate, collateralToInterestRatio, active, nftAddress, collateralAddress, interestAddress, usdcAddress, operationMode)</code></p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Create a new trade deal for invoice financing</span>
<span class="kt">string</span><span class="w"> </span><span class="nv">memory</span><span class="w"> </span>dealName<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Q1 2024 Invoice Financing&quot;</span><span class="p">;</span>
<span class="kt">string</span><span class="w"> </span><span class="nv">memory</span><span class="w"> </span>dealSymbol<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Q1IF&quot;</span><span class="p">;</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">interestRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">800</span><span class="p">;</span><span class="w"> </span><span class="c1">// 8% annual interest</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralRatio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1000000</span><span class="p">;</span><span class="w"> </span><span class="c1">// 1:1 ratio (scaled)</span>

<span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>claimTopics<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="kt">uint256</span><span class="p">[](</span><span class="m m-Decimal">2</span><span class="p">);</span>
claimTopics<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// KYC verification</span>
claimTopics<span class="p">[</span><span class="m m-Decimal">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// Accredited investor</span>

<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ITradeDeal<span class="p">(</span>diamond<span class="p">).</span>createTradeDeal<span class="p">(</span>
<span class="w">    </span>dealName<span class="p">,</span>
<span class="w">    </span>dealSymbol<span class="p">,</span>
<span class="w">    </span>interestRate<span class="p">,</span>
<span class="w">    </span>collateralRatio<span class="p">,</span>
<span class="w">    </span>claimTopics<span class="p">,</span>
<span class="w">    </span>collateralTokenAddress<span class="p">,</span>
<span class="w">    </span>interestTokenAddress<span class="p">,</span>
<span class="w">    </span>usdcTokenAddress<span class="p">,</span>
<span class="w">    </span>TradeDealLib<span class="p">.</span>OperationMode<span class="p">.</span>STANDARD
<span class="p">);</span>

console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Created trade deal with ID:&quot;</span><span class="p">,</span><span class="w"> </span>tradeDealId<span class="p">);</span>
</code></pre></div>

<hr />
<h4 id="updatetradedeal"><code>updateTradeDeal()</code><a class="headerlink" href="#updatetradedeal" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">updateTradeDeal</span><span class="p">(</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="nv">memory</span><span class="w"> </span>name<span class="p">,</span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="nv">memory</span><span class="w"> </span>symbol<span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">interestRate</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralToInterestRatio</span><span class="p">,</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">collateralAddress</span><span class="p">,</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">interestAddress</span><span class="p">,</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">usdcAddress</span>
<span class="p">)</span><span class="w"> </span><span class="kt">external</span>
</code></pre></div>

<p><strong>Purpose</strong>: Updates the configuration of an existing trade deal.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal to update
- <code>name</code> (string): Updated name for the trade deal
- <code>symbol</code> (string): Updated symbol for the collateral token
- <code>interestRate</code> (uint256): Updated interest rate in basis points
- <code>collateralToInterestRatio</code> (uint256): Updated conversion ratio
- <code>collateralAddress</code> (address): Updated collateral token address
- <code>interestAddress</code> (address): Updated interest token address
- <code>usdcAddress</code> (address): Updated USDC token address</p>
<p><strong>Events</strong>: <code>TradeDealUpdated(tradeDealId, name, symbol, interestRate, collateralToInterestRatio, active, collateralAddress, interestAddress, usdcAddress)</code></p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Update trade deal interest rate</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">newInterestRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">750</span><span class="p">;</span><span class="w"> </span><span class="c1">// Reduce to 7.5%</span>

ITradeDeal<span class="p">(</span>diamond<span class="p">).</span>updateTradeDeal<span class="p">(</span>
<span class="w">    </span>tradeDealId<span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;Q1 2024 Invoice Financing - Updated&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;Q1IF&quot;</span><span class="p">,</span>
<span class="w">    </span>newInterestRate<span class="p">,</span>
<span class="w">    </span><span class="m m-Decimal">1000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// Keep same ratio</span>
<span class="w">    </span>collateralTokenAddress<span class="p">,</span>
<span class="w">    </span>interestTokenAddress<span class="p">,</span>
<span class="w">    </span>usdcTokenAddress
<span class="p">);</span>
</code></pre></div>

<hr />
<h4 id="activatetradedeal-deactivatetradedeal"><code>activateTradeDeal()</code> / <code>deactivateTradeDeal()</code><a class="headerlink" href="#activatetradedeal-deactivatetradedeal" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">activateTradeDeal</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span>
<span class="kt">function</span><span class="w"> </span><span class="nv">deactivateTradeDeal</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span>
</code></pre></div>

<p><strong>Purpose</strong>: Activates or deactivates a trade deal for participation and operations.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal</p>
<p><strong>Events</strong>: 
- <code>TradeDealActivated(tradeDealId)</code>
- <code>TradeDealDeactivated(tradeDealId)</code></p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Activate trade deal for funding</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
ITradeDeal<span class="p">(</span>diamond<span class="p">).</span>activateTradeDeal<span class="p">(</span>tradeDealId<span class="p">);</span>

<span class="c1">// Later, deactivate when funding complete</span>
ITradeDeal<span class="p">(</span>diamond<span class="p">).</span>deactivateTradeDeal<span class="p">(</span>tradeDealId<span class="p">);</span>
</code></pre></div>

<h3 id="collateral-and-funding-functions">Collateral and Funding Functions<a class="headerlink" href="#collateral-and-funding-functions" title="Permanent link">&para;</a></h3>
<h4 id="tddepositinvoice-tdwithdrawinvoice"><code>tdDepositInvoice()</code> / <code>tdWithdrawInvoice()</code><a class="headerlink" href="#tddepositinvoice-tdwithdrawinvoice" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">tdDepositInvoice</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tokenId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span>
<span class="kt">function</span><span class="w"> </span><span class="nv">tdWithdrawInvoice</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tokenId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span>
</code></pre></div>

<p><strong>Purpose</strong>: Deposits or withdraws invoice NFTs as collateral for trade deals.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal
- <code>tokenId</code> (uint256): ID of the invoice NFT</p>
<p><strong>Events</strong>: 
- <code>InvoiceDepositedToTradeDeal(tradeDealId, tokenId)</code>
- <code>InvoiceWithdrawnFromTradeDeal(tradeDealId, tokenId)</code></p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Deposit invoice as collateral</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">invoiceTokenId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">123</span><span class="p">;</span>

<span class="c1">// First approve the diamond to transfer the invoice</span>
IERC721<span class="p">(</span>invoiceContract<span class="p">).</span>approve<span class="p">(</span>diamond<span class="p">,</span><span class="w"> </span>invoiceTokenId<span class="p">);</span>

<span class="c1">// Deposit the invoice</span>
ITradeDeal<span class="p">(</span>diamond<span class="p">).</span>tdDepositInvoice<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>invoiceTokenId<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Invoice deposited as collateral&quot;</span><span class="p">);</span>

<span class="c1">// Later withdraw if needed</span>
ITradeDeal<span class="p">(</span>diamond<span class="p">).</span>tdWithdrawInvoice<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>invoiceTokenId<span class="p">);</span>
</code></pre></div>

<hr />
<h4 id="tddepositusdc-tdwithdrawusdc"><code>tdDepositUSDC()</code> / <code>tdWithdrawUSDC()</code><a class="headerlink" href="#tddepositusdc-tdwithdrawusdc" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">tdDepositUSDC</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span>
<span class="kt">function</span><span class="w"> </span><span class="nv">tdWithdrawUSDC</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span>
</code></pre></div>

<p><strong>Purpose</strong>: Deposits or withdraws USDC for trade deal funding.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal
- <code>amount</code> (uint256): Amount of USDC to deposit/withdraw</p>
<p><strong>Events</strong>: 
- <code>USDCDepositedToTradeDeal(tradeDealId, amount, depositor)</code>
- <code>CollateralTokensDistributed(tradeDealId, recipient, amount)</code>
- <code>TradeDealFullyFunded(tradeDealId, fundingTarget)</code> (if applicable)
- <code>USDCWithdrawnFromTradeDeal(tradeDealId, amount)</code></p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Fund trade deal with USDC</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">10000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">10</span><span class="o">**</span><span class="m m-Decimal">6</span><span class="p">;</span><span class="w"> </span><span class="c1">// 10,000 USDC</span>

<span class="c1">// First approve USDC transfer</span>
IERC20<span class="p">(</span>usdcToken<span class="p">).</span>approve<span class="p">(</span>diamond<span class="p">,</span><span class="w"> </span>fundingAmount<span class="p">);</span>

<span class="c1">// Deposit USDC and receive collateral tokens</span>
ITradeDeal<span class="p">(</span>diamond<span class="p">).</span>tdDepositUSDC<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>fundingAmount<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Deposited USDC and received collateral tokens&quot;</span><span class="p">);</span>
</code></pre></div>

<hr />
<h4 id="withdrawtradedealfundingforborrower"><code>withdrawTradeDealFundingForBorrower()</code><a class="headerlink" href="#withdrawtradedealfundingforborrower" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">withdrawTradeDealFundingForBorrower</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">borrowerAddress</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span>
</code></pre></div>

<p><strong>Purpose</strong>: Allows admin to withdraw funding on behalf of a borrower.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal
- <code>borrowerAddress</code> (address): Address of the borrower receiving funds</p>
<p><strong>Events</strong>: <code>TradeDealFundingWithdrawn(tradeDealId, recipient, amount)</code></p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Admin withdraws funding for borrower</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="kt">address</span><span class="w"> </span><span class="nv">borrower</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x742d35Cc6634C0532925a3b8D0C9e3e0C8b0e5e1</span><span class="p">;</span>

ITradeDeal<span class="p">(</span>diamond<span class="p">).</span>withdrawTradeDealFundingForBorrower<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>borrower<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Funding withdrawn for borrower&quot;</span><span class="p">);</span>
</code></pre></div>

<h3 id="interest-and-fee-management-functions">Interest and Fee Management Functions<a class="headerlink" href="#interest-and-fee-management-functions" title="Permanent link">&para;</a></h3>
<h4 id="tddistributeinterest"><code>tdDistributeInterest()</code><a class="headerlink" href="#tddistributeinterest" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">tdDistributeInterest</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span>
</code></pre></div>

<p><strong>Purpose</strong>: Distributes accumulated interest for a trade deal across pools and participants.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal</p>
<p><strong>Events</strong>: <code>InterestDistributedForTradeDeal(tradeDealId, totalInterest, invoicePoolInterest, interestInterest, interestTokensMinted)</code></p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Distribute interest for trade deal</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
ITradeDeal<span class="p">(</span>diamond<span class="p">).</span>tdDistributeInterest<span class="p">(</span>tradeDealId<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Interest distributed for trade deal&quot;</span><span class="p">);</span>
</code></pre></div>

<h3 id="repayment-functions">Repayment Functions<a class="headerlink" href="#repayment-functions" title="Permanent link">&para;</a></h3>
<h4 id="repaytradedeal-repaytradedealforborrower"><code>repayTradeDeal()</code> / <code>repayTradeDealForBorrower()</code><a class="headerlink" href="#repaytradedeal-repaytradedealforborrower" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">repayTradeDeal</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span>
<span class="kt">function</span><span class="w"> </span><span class="nv">repayTradeDealForBorrower</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">borrower</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span>
</code></pre></div>

<p><strong>Purpose</strong>: Processes repayments for trade deals, either by borrower or admin.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal
- <code>amount</code> (uint256): Amount to repay
- <code>borrower</code> (address): Borrower address (for admin repayment)</p>
<p><strong>Events</strong>: <code>TradeDealRepaid(tradeDealId, repayer, amount, fullyRepaid)</code></p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Borrower makes repayment</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">repaymentAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">5000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">10</span><span class="o">**</span><span class="m m-Decimal">6</span><span class="p">;</span><span class="w"> </span><span class="c1">// 5,000 USDC</span>

<span class="c1">// First approve USDC transfer</span>
IERC20<span class="p">(</span>usdcToken<span class="p">).</span>approve<span class="p">(</span>diamond<span class="p">,</span><span class="w"> </span>repaymentAmount<span class="p">);</span>

<span class="c1">// Make repayment</span>
ITradeDeal<span class="p">(</span>diamond<span class="p">).</span>repayTradeDeal<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>repaymentAmount<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Repayment made&quot;</span><span class="p">);</span>
</code></pre></div>

<hr />
<h4 id="redeemcollateraltokens"><code>redeemCollateralTokens()</code><a class="headerlink" href="#redeemcollateraltokens" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">redeemCollateralTokens</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralAmount</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span>
</code></pre></div>

<p><strong>Purpose</strong>: Redeems collateral tokens for USDC based on current redemption rate.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal
- <code>collateralAmount</code> (uint256): Amount of collateral tokens to redeem</p>
<p><strong>Events</strong>: <code>CollateralTokensRedeemed(tradeDealId, redeemer, collateralAmount, usdcAmount)</code></p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Redeem collateral tokens for USDC</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralToRedeem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">10</span><span class="o">**</span><span class="m m-Decimal">18</span><span class="p">;</span><span class="w"> </span><span class="c1">// 1,000 collateral tokens</span>

ITradeDeal<span class="p">(</span>diamond<span class="p">).</span>redeemCollateralTokens<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>collateralToRedeem<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Collateral tokens redeemed for USDC&quot;</span><span class="p">);</span>
</code></pre></div>

<h3 id="participant-management-functions">Participant Management Functions<a class="headerlink" href="#participant-management-functions" title="Permanent link">&para;</a></h3>
<h4 id="settradedealrequiredclaimtopics-gettradedealrequiredclaimtopics"><code>setTradeDealRequiredClaimTopics()</code> / <code>getTradeDealRequiredClaimTopics()</code><a class="headerlink" href="#settradedealrequiredclaimtopics-gettradedealrequiredclaimtopics" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">setTradeDealRequiredClaimTopics</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>claimTopics<span class="p">)</span><span class="w"> </span><span class="kt">external</span>
<span class="kt">function</span><span class="w"> </span><span class="nv">getTradeDealRequiredClaimTopics</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="p">)</span>
</code></pre></div>

<p><strong>Purpose</strong>: Sets or retrieves required identity claim topics for trade deal participation.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal
- <code>claimTopics</code> (uint256[]): Array of claim topic IDs</p>
<p><strong>Events</strong>: <code>TradeDealRequiredClaimTopicsSet(tradeDealId, claimTopics)</code></p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Set required claim topics</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>requiredClaims<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="kt">uint256</span><span class="p">[](</span><span class="m m-Decimal">3</span><span class="p">);</span>
requiredClaims<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// KYC verification</span>
requiredClaims<span class="p">[</span><span class="m m-Decimal">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// Accredited investor</span>
requiredClaims<span class="p">[</span><span class="m m-Decimal">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">3</span><span class="p">;</span><span class="w"> </span><span class="c1">// Geographic eligibility</span>

ITradeDeal<span class="p">(</span>diamond<span class="p">).</span>setTradeDealRequiredClaimTopics<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>requiredClaims<span class="p">);</span>

<span class="c1">// Get current requirements</span>
<span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>currentClaims<span class="w"> </span><span class="o">=</span><span class="w"> </span>ITradeDeal<span class="p">(</span>diamond<span class="p">).</span>getTradeDealRequiredClaimTopics<span class="p">(</span>tradeDealId<span class="p">);</span>
</code></pre></div>

<hr />
<h4 id="istradedealparticipant"><code>isTradeDealParticipant()</code><a class="headerlink" href="#istradedealparticipant" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">isTradeDealParticipant</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">user</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span>
</code></pre></div>

<p><strong>Purpose</strong>: Checks if an address is a verified participant in a trade deal.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal
- <code>user</code> (address): Address to check</p>
<p><strong>Returns</strong>:
- <code>bool</code>: True if user is a verified participant</p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Check if user is a participant</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="kt">address</span><span class="w"> </span><span class="nv">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x742d35Cc6634C0532925a3b8D0C9e3e0C8b0e5e1</span><span class="p">;</span>

<span class="kt">bool</span><span class="w"> </span><span class="nv">isParticipant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ITradeDeal<span class="p">(</span>diamond<span class="p">).</span>isTradeDealParticipant<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>user<span class="p">);</span>
<span class="kt">if</span><span class="w"> </span><span class="p">(</span>isParticipant<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;User is verified participant&quot;</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="kt">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;User is not a participant&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="query-functions">Query Functions<a class="headerlink" href="#query-functions" title="Permanent link">&para;</a></h3>
<h4 id="gettradedealinfo"><code>getTradeDealInfo()</code><a class="headerlink" href="#gettradedealinfo" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">getTradeDealInfo</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="nv">memory</span><span class="w"> </span>name<span class="p">,</span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="nv">memory</span><span class="w"> </span>symbol<span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">interestRate</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralToInterestRatio</span><span class="p">,</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nv">active</span><span class="p">,</span>
<span class="w">    </span>TradeDealLib<span class="p">.</span>OperationMode<span class="w"> </span>operationMode
<span class="p">)</span>
</code></pre></div>

<p><strong>Purpose</strong>: Retrieves basic information about a trade deal.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal</p>
<p><strong>Returns</strong>: Trade deal configuration details</p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Get trade deal information</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="p">(</span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="nv">memory</span><span class="w"> </span>name<span class="p">,</span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="nv">memory</span><span class="w"> </span>symbol<span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">interestRate</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralRatio</span><span class="p">,</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nv">active</span><span class="p">,</span>
<span class="w">    </span>TradeDealLib<span class="p">.</span>OperationMode<span class="w"> </span>mode
<span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ITradeDeal<span class="p">(</span>diamond<span class="p">).</span>getTradeDealInfo<span class="p">(</span>tradeDealId<span class="p">);</span>

console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Trade Deal:&quot;</span><span class="p">,</span><span class="w"> </span>name<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Interest Rate:&quot;</span><span class="p">,</span><span class="w"> </span>interestRate<span class="p">,</span><span class="w"> </span><span class="s2">&quot;basis points&quot;</span><span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Active:&quot;</span><span class="p">,</span><span class="w"> </span>active<span class="p">);</span>
</code></pre></div>

<hr />
<h4 id="gettradedealfullstatus"><code>getTradeDealFullStatus()</code><a class="headerlink" href="#gettradedealfullstatus" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">getTradeDealFullStatus</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingTarget</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">currentBalance</span><span class="p">,</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFunded</span><span class="p">,</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFundingWithdrawn</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalDebt</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">repaidAmount</span><span class="p">,</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isRepaid</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>Purpose</strong>: Retrieves comprehensive status information for a trade deal.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal</p>
<p><strong>Returns</strong>: Complete financial and operational status</p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Get complete trade deal status</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="p">(</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingTarget</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">currentBalance</span><span class="p">,</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFunded</span><span class="p">,</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFundingWithdrawn</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalDebt</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">repaidAmount</span><span class="p">,</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isRepaid</span>
<span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ITradeDeal<span class="p">(</span>diamond<span class="p">).</span>getTradeDealFullStatus<span class="p">(</span>tradeDealId<span class="p">);</span>

console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Funding Target:&quot;</span><span class="p">,</span><span class="w"> </span>fundingTarget<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Current Balance:&quot;</span><span class="p">,</span><span class="w"> </span>currentBalance<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Is Funded:&quot;</span><span class="p">,</span><span class="w"> </span>isFunded<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Total Debt:&quot;</span><span class="p">,</span><span class="w"> </span>totalDebt<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Repaid Amount:&quot;</span><span class="p">,</span><span class="w"> </span>repaidAmount<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Is Fully Repaid:&quot;</span><span class="p">,</span><span class="w"> </span>isRepaid<span class="p">);</span>
</code></pre></div>

<hr />
<h4 id="getalltradedealids"><code>getAllTradeDealIds()</code><a class="headerlink" href="#getalltradedealids" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">getAllTradeDealIds</span><span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="p">)</span>
</code></pre></div>

<p><strong>Purpose</strong>: Returns all trade deal IDs in the system.</p>
<p><strong>Returns</strong>: Array of trade deal IDs</p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Get all trade deal IDs</span>
<span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>allDeals<span class="w"> </span><span class="o">=</span><span class="w"> </span>ITradeDeal<span class="p">(</span>diamond<span class="p">).</span>getAllTradeDealIds<span class="p">();</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Total trade deals:&quot;</span><span class="p">,</span><span class="w"> </span>allDeals<span class="p">.</span>length<span class="p">);</span>

<span class="kt">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span><span class="w"> </span>i<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>allDeals<span class="p">.</span>length<span class="p">;</span><span class="w"> </span>i<span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Trade Deal ID:&quot;</span><span class="p">,</span><span class="w"> </span>allDeals<span class="p">[</span>i<span class="p">]);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="status-check-functions">Status Check Functions<a class="headerlink" href="#status-check-functions" title="Permanent link">&para;</a></h3>
<h4 id="istradedealfunded-istradedealrepaid"><code>isTradeDealFunded()</code> / <code>isTradeDealRepaid()</code><a class="headerlink" href="#istradedealfunded-istradedealrepaid" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">isTradeDealFunded</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span>
<span class="kt">function</span><span class="w"> </span><span class="nv">isTradeDealRepaid</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span>
</code></pre></div>

<p><strong>Purpose</strong>: Quick status checks for funding and repayment status.</p>
<p><strong>Parameters</strong>:
- <code>tradeDealId</code> (uint256): ID of the trade deal</p>
<p><strong>Returns</strong>: Boolean status</p>
<p><strong>Example Usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Check trade deal status</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>

<span class="kt">bool</span><span class="w"> </span><span class="nv">isFunded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ITradeDeal<span class="p">(</span>diamond<span class="p">).</span>isTradeDealFunded<span class="p">(</span>tradeDealId<span class="p">);</span>
<span class="kt">bool</span><span class="w"> </span><span class="nv">isRepaid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ITradeDeal<span class="p">(</span>diamond<span class="p">).</span>isTradeDealRepaid<span class="p">(</span>tradeDealId<span class="p">);</span>

console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Trade Deal Funded:&quot;</span><span class="p">,</span><span class="w"> </span>isFunded<span class="p">);</span>
console<span class="p">.</span>log<span class="p">(</span><span class="s2">&quot;Trade Deal Repaid:&quot;</span><span class="p">,</span><span class="w"> </span>isRepaid<span class="p">);</span>
</code></pre></div>

<h2 id="integration-examples">Integration Examples<a class="headerlink" href="#integration-examples" title="Permanent link">&para;</a></h2>
<h3 id="complete-trade-deal-workflow">Complete Trade Deal Workflow<a class="headerlink" href="#complete-trade-deal-workflow" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Comprehensive trade deal integration example</span>
<span class="k">contract</span><span class="w"> </span><span class="ni">TradeDealWorkflow</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>ITradeDeal<span class="w"> </span><span class="kt">public</span><span class="w"> </span>tradeDeal<span class="p">;</span>

<span class="w">    </span><span class="kt">struct</span><span class="w"> </span><span class="nv">WorkflowState</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">phase</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0: Created, 1: Funded, 2: Active, 3: Repaid</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalFunding</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalRepaid</span><span class="p">;</span>
<span class="w">        </span><span class="kt">address</span><span class="p">[]</span><span class="w"> </span>participants<span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span>WorkflowState<span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>workflows<span class="p">;</span>

<span class="w">    </span><span class="kt">event</span><span class="w"> </span><span class="nv">WorkflowPhaseChanged</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">newPhase</span><span class="p">);</span>

<span class="w">    </span><span class="kt">constructor</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">_tradeDeal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>tradeDeal<span class="w"> </span><span class="o">=</span><span class="w"> </span>ITradeDeal<span class="p">(</span>_tradeDeal<span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">createAndFundTradeDeal</span><span class="p">(</span>
<span class="w">        </span><span class="kt">string</span><span class="w"> </span><span class="nv">memory</span><span class="w"> </span>name<span class="p">,</span>
<span class="w">        </span><span class="kt">string</span><span class="w"> </span><span class="nv">memory</span><span class="w"> </span>symbol<span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">interestRate</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingAmount</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>invoiceTokenIds
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Create trade deal</span>
<span class="w">        </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>claimTopics<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="kt">uint256</span><span class="p">[](</span><span class="m m-Decimal">1</span><span class="p">);</span>
<span class="w">        </span>claimTopics<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// KYC required</span>

<span class="w">        </span>tradeDealId<span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDeal<span class="p">.</span>createTradeDeal<span class="p">(</span>
<span class="w">            </span>name<span class="p">,</span>
<span class="w">            </span>symbol<span class="p">,</span>
<span class="w">            </span>interestRate<span class="p">,</span>
<span class="w">            </span><span class="m m-Decimal">1000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// 1:1 collateral ratio</span>
<span class="w">            </span>claimTopics<span class="p">,</span>
<span class="w">            </span>collateralTokenAddress<span class="p">,</span>
<span class="w">            </span>interestTokenAddress<span class="p">,</span>
<span class="w">            </span>usdcTokenAddress<span class="p">,</span>
<span class="w">            </span>TradeDealLib<span class="p">.</span>OperationMode<span class="p">.</span>STANDARD
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Initialize workflow</span>
<span class="w">        </span>workflows<span class="p">[</span>tradeDealId<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>WorkflowState<span class="p">({</span>
<span class="w">            </span>tradeDealId<span class="o">:</span><span class="w"> </span>tradeDealId<span class="p">,</span>
<span class="w">            </span>phase<span class="o">:</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">,</span>
<span class="w">            </span>totalFunding<span class="o">:</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">,</span>
<span class="w">            </span>totalRepaid<span class="o">:</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">,</span>
<span class="w">            </span>participants<span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="kt">address</span><span class="p">[](</span><span class="m m-Decimal">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Activate trade deal</span>
<span class="w">        </span>tradeDeal<span class="p">.</span>activateTradeDeal<span class="p">(</span>tradeDealId<span class="p">);</span>

<span class="w">        </span><span class="c1">// Deposit invoices as collateral</span>
<span class="w">        </span><span class="kt">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span><span class="w"> </span>i<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>invoiceTokenIds<span class="p">.</span>length<span class="p">;</span><span class="w"> </span>i<span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>tradeDeal<span class="p">.</span>tdDepositInvoice<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>invoiceTokenIds<span class="p">[</span>i<span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Fund the trade deal</span>
<span class="w">        </span>tradeDeal<span class="p">.</span>tdDepositUSDC<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>fundingAmount<span class="p">);</span>
<span class="w">        </span>workflows<span class="p">[</span>tradeDealId<span class="p">].</span>totalFunding<span class="w"> </span><span class="o">=</span><span class="w"> </span>fundingAmount<span class="p">;</span>
<span class="w">        </span>workflows<span class="p">[</span>tradeDealId<span class="p">].</span>phase<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>

<span class="w">        </span>emit<span class="w"> </span>WorkflowPhaseChanged<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">processRepayment</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>WorkflowState<span class="w"> </span>storage<span class="w"> </span>workflow<span class="w"> </span><span class="o">=</span><span class="w"> </span>workflows<span class="p">[</span>tradeDealId<span class="p">];</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>workflow<span class="p">.</span>phase<span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Trade deal not funded&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Process repayment</span>
<span class="w">        </span>tradeDeal<span class="p">.</span>repayTradeDeal<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>amount<span class="p">);</span>
<span class="w">        </span>workflow<span class="p">.</span>totalRepaid<span class="w"> </span><span class="o">+=</span><span class="w"> </span>amount<span class="p">;</span>

<span class="w">        </span><span class="c1">// Check if fully repaid</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isRepaid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDeal<span class="p">.</span>isTradeDealRepaid<span class="p">(</span>tradeDealId<span class="p">);</span>
<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>isRepaid<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>workflow<span class="p">.</span>phase<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m m-Decimal">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>workflow<span class="p">.</span>phase<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">3</span><span class="p">;</span>
<span class="w">            </span>emit<span class="w"> </span>WorkflowPhaseChanged<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="m m-Decimal">3</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">distributeInterestAndFees</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>WorkflowState<span class="w"> </span>storage<span class="w"> </span>workflow<span class="w"> </span><span class="o">=</span><span class="w"> </span>workflows<span class="p">[</span>tradeDealId<span class="p">];</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>workflow<span class="p">.</span>phase<span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Trade deal not funded&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Distribute interest</span>
<span class="w">        </span>tradeDeal<span class="p">.</span>tdDistributeInterest<span class="p">(</span>tradeDealId<span class="p">);</span>

<span class="w">        </span><span class="c1">// Update phase if needed</span>
<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>workflow<span class="p">.</span>phase<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>workflow<span class="p">.</span>phase<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// Active phase</span>
<span class="w">            </span>emit<span class="w"> </span>WorkflowPhaseChanged<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="m m-Decimal">2</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">getWorkflowStatus</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">phase</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingProgress</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">repaymentProgress</span><span class="p">,</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">canRedeem</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>WorkflowState<span class="w"> </span><span class="kt">memory</span><span class="w"> </span>workflow<span class="w"> </span><span class="o">=</span><span class="w"> </span>workflows<span class="p">[</span>tradeDealId<span class="p">];</span>

<span class="w">        </span><span class="p">(</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingTarget</span><span class="p">,</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">currentBalance</span><span class="p">,</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFunded</span><span class="p">,</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFundingWithdrawn</span><span class="p">,</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalDebt</span><span class="p">,</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">repaidAmount</span><span class="p">,</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isRepaid</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDeal<span class="p">.</span>getTradeDealFullStatus<span class="p">(</span>tradeDealId<span class="p">);</span>

<span class="w">        </span>phase<span class="w"> </span><span class="o">=</span><span class="w"> </span>workflow<span class="p">.</span>phase<span class="p">;</span>
<span class="w">        </span>fundingProgress<span class="w"> </span><span class="o">=</span><span class="w"> </span>fundingTarget<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span>currentBalance<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">100</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span>fundingTarget<span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
<span class="w">        </span>repaymentProgress<span class="w"> </span><span class="o">=</span><span class="w"> </span>totalDebt<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span>repaidAmount<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">100</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span>totalDebt<span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
<span class="w">        </span>canRedeem<span class="w"> </span><span class="o">=</span><span class="w"> </span>isRepaid<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>workflow<span class="p">.</span>totalFunding<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="trade-deal-analytics-dashboard">Trade Deal Analytics Dashboard<a class="headerlink" href="#trade-deal-analytics-dashboard" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Analytics and reporting for trade deals</span>
<span class="k">contract</span><span class="w"> </span><span class="ni">TradeDealAnalytics</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>ITradeDeal<span class="w"> </span><span class="kt">public</span><span class="w"> </span>tradeDeal<span class="p">;</span>

<span class="w">    </span><span class="kt">struct</span><span class="w"> </span><span class="nv">AnalyticsData</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalDeals</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">activeDeals</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundedDeals</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">repaidDeals</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalVolume</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalInterestPaid</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">averageInterestRate</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>dealCreationTime<span class="p">;</span>
<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>dealFundingTime<span class="p">;</span>
<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>dealRepaymentTime<span class="p">;</span>

<span class="w">    </span><span class="kt">event</span><span class="w"> </span><span class="nv">AnalyticsUpdated</span><span class="p">(</span>AnalyticsData<span class="w"> </span>data<span class="p">);</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">updateAnalytics</span><span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span>AnalyticsData<span class="w"> </span><span class="kt">memory</span><span class="w"> </span>data<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>allDeals<span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDeal<span class="p">.</span>getAllTradeDealIds<span class="p">();</span>

<span class="w">        </span>data<span class="p">.</span>totalDeals<span class="w"> </span><span class="o">=</span><span class="w"> </span>allDeals<span class="p">.</span>length<span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalInterestRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>

<span class="w">        </span><span class="kt">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span><span class="w"> </span>i<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>allDeals<span class="p">.</span>length<span class="p">;</span><span class="w"> </span>i<span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">dealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>allDeals<span class="p">[</span>i<span class="p">];</span>

<span class="w">            </span><span class="p">(</span>
<span class="w">                </span><span class="kt">string</span><span class="w"> </span><span class="nv">memory</span><span class="w"> </span>name<span class="p">,</span>
<span class="w">                </span><span class="kt">string</span><span class="w"> </span><span class="nv">memory</span><span class="w"> </span>symbol<span class="p">,</span>
<span class="w">                </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">interestRate</span><span class="p">,</span>
<span class="w">                </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralRatio</span><span class="p">,</span>
<span class="w">                </span><span class="kt">bool</span><span class="w"> </span><span class="nv">active</span><span class="p">,</span>
<span class="w">                </span>TradeDealLib<span class="p">.</span>OperationMode<span class="w"> </span>mode
<span class="w">            </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDeal<span class="p">.</span>getTradeDealInfo<span class="p">(</span>dealId<span class="p">);</span>

<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>active<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span>data<span class="p">.</span>activeDeals<span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span>totalInterestRate<span class="w"> </span><span class="o">+=</span><span class="w"> </span>interestRate<span class="p">;</span>

<span class="w">            </span><span class="p">(</span>
<span class="w">                </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingTarget</span><span class="p">,</span>
<span class="w">                </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">currentBalance</span><span class="p">,</span>
<span class="w">                </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFunded</span><span class="p">,</span>
<span class="w">                </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFundingWithdrawn</span><span class="p">,</span>
<span class="w">                </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalDebt</span><span class="p">,</span>
<span class="w">                </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">repaidAmount</span><span class="p">,</span>
<span class="w">                </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isRepaid</span>
<span class="w">            </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDeal<span class="p">.</span>getTradeDealFullStatus<span class="p">(</span>dealId<span class="p">);</span>

<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>isFunded<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span>data<span class="p">.</span>fundedDeals<span class="o">++</span><span class="p">;</span>
<span class="w">                </span>data<span class="p">.</span>totalVolume<span class="w"> </span><span class="o">+=</span><span class="w"> </span>fundingTarget<span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>isRepaid<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span>data<span class="p">.</span>repaidDeals<span class="o">++</span><span class="p">;</span>
<span class="w">                </span>data<span class="p">.</span>totalInterestPaid<span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span>repaidAmount<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>fundingTarget<span class="w"> </span><span class="o">?</span><span class="w"> </span>repaidAmount<span class="w"> </span><span class="o">-</span><span class="w"> </span>fundingTarget<span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>data<span class="p">.</span>totalDeals<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>data<span class="p">.</span>averageInterestRate<span class="w"> </span><span class="o">=</span><span class="w"> </span>totalInterestRate<span class="w"> </span><span class="o">/</span><span class="w"> </span>data<span class="p">.</span>totalDeals<span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span>emit<span class="w"> </span>AnalyticsUpdated<span class="p">(</span>data<span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">getDealPerformanceMetrics</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">timeToFunding</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">timeToRepayment</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">actualInterestRate</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">performanceScore</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">creationTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>dealCreationTime<span class="p">[</span>tradeDealId<span class="p">];</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>dealFundingTime<span class="p">[</span>tradeDealId<span class="p">];</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">repaymentTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>dealRepaymentTime<span class="p">[</span>tradeDealId<span class="p">];</span>

<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>fundingTime<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>creationTime<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>timeToFunding<span class="w"> </span><span class="o">=</span><span class="w"> </span>fundingTime<span class="w"> </span><span class="o">-</span><span class="w"> </span>creationTime<span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>repaymentTime<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>fundingTime<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>fundingTime<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>timeToRepayment<span class="w"> </span><span class="o">=</span><span class="w"> </span>repaymentTime<span class="w"> </span><span class="o">-</span><span class="w"> </span>fundingTime<span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="p">(</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingTarget</span><span class="p">,</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">currentBalance</span><span class="p">,</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFunded</span><span class="p">,</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFundingWithdrawn</span><span class="p">,</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalDebt</span><span class="p">,</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">repaidAmount</span><span class="p">,</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isRepaid</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDeal<span class="p">.</span>getTradeDealFullStatus<span class="p">(</span>tradeDealId<span class="p">);</span>

<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>isRepaid<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>fundingTarget<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>actualInterestRate<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span>repaidAmount<span class="w"> </span><span class="o">-</span><span class="w"> </span>fundingTarget<span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">10000</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span>fundingTarget<span class="p">;</span>

<span class="w">            </span><span class="c1">// Calculate performance score (0-100)</span>
<span class="w">            </span>performanceScore<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">100</span><span class="p">;</span>
<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>timeToFunding<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">7</span><span class="w"> </span>days<span class="p">)</span><span class="w"> </span>performanceScore<span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="m m-Decimal">20</span><span class="p">;</span>
<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>timeToRepayment<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">90</span><span class="w"> </span>days<span class="p">)</span><span class="w"> </span>performanceScore<span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="m m-Decimal">30</span><span class="p">;</span>
<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span>isRepaid<span class="p">)</span><span class="w"> </span>performanceScore<span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="m m-Decimal">50</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="automated-trade-deal-manager">Automated Trade Deal Manager<a class="headerlink" href="#automated-trade-deal-manager" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Automated management for trade deal operations</span>
<span class="k">contract</span><span class="w"> </span><span class="ni">AutomatedTradeDealManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>ITradeDeal<span class="w"> </span><span class="kt">public</span><span class="w"> </span>tradeDeal<span class="p">;</span>

<span class="w">    </span><span class="kt">struct</span><span class="w"> </span><span class="nv">AutomationConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">autoDistributeInterest</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">interestDistributionFrequency</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">lastInterestDistribution</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">autoProcessRepayments</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">gracePeriod</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">autoRedemption</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span>AutomationConfig<span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>automationConfigs<span class="p">;</span>
<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>nextScheduledAction<span class="p">;</span>

<span class="w">    </span><span class="kt">event</span><span class="w"> </span><span class="nv">AutomationConfigured</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span>AutomationConfig<span class="w"> </span>config<span class="p">);</span>
<span class="w">    </span><span class="kt">event</span><span class="w"> </span><span class="nv">AutomatedActionExecuted</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nv">action</span><span class="p">);</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">configureAutomation</span><span class="p">(</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span>
<span class="w">        </span>AutomationConfig<span class="w"> </span><span class="kt">memory</span><span class="w"> </span>config
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>onlyAuthorized<span class="w"> </span><span class="p">{</span>
<span class="w">        </span>automationConfigs<span class="p">[</span>tradeDealId<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>config<span class="p">;</span>

<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>config<span class="p">.</span>autoDistributeInterest<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>nextScheduledAction<span class="p">[</span>tradeDealId<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">block.timestamp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>config<span class="p">.</span>interestDistributionFrequency<span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span>emit<span class="w"> </span>AutomationConfigured<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>config<span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">executeScheduledActions</span><span class="p">(</span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>tradeDealIds<span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span><span class="w"> </span>i<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>tradeDealIds<span class="p">.</span>length<span class="p">;</span><span class="w"> </span>i<span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDealIds<span class="p">[</span>i<span class="p">];</span>
<span class="w">            </span>AutomationConfig<span class="w"> </span><span class="kt">memory</span><span class="w"> </span>config<span class="w"> </span><span class="o">=</span><span class="w"> </span>automationConfigs<span class="p">[</span>tradeDealId<span class="p">];</span>

<span class="w">            </span><span class="c1">// Auto-distribute interest</span>
<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>config<span class="p">.</span>autoDistributeInterest<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">                </span><span class="k">block.timestamp</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span>nextScheduledAction<span class="p">[</span>tradeDealId<span class="p">])</span><span class="w"> </span><span class="p">{</span>

<span class="w">                </span>tradeDeal<span class="p">.</span>tdDistributeInterest<span class="p">(</span>tradeDealId<span class="p">);</span>
<span class="w">                </span>nextScheduledAction<span class="p">[</span>tradeDealId<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">block.timestamp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>config<span class="p">.</span>interestDistributionFrequency<span class="p">;</span>

<span class="w">                </span>emit<span class="w"> </span>AutomatedActionExecuted<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="s2">&quot;interest_distribution&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// Auto-process repayments (would need additional logic)</span>
<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>config<span class="p">.</span>autoProcessRepayments<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span>_processAutomaticRepayments<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>config<span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// Auto-redemption for completed deals</span>
<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>config<span class="p">.</span>autoRedemption<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span>_processAutomaticRedemption<span class="p">(</span>tradeDealId<span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">_processAutomaticRepayments</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span>AutomationConfig<span class="w"> </span><span class="kt">memory</span><span class="w"> </span>config<span class="p">)</span><span class="w"> </span><span class="kt">internal</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Implementation would check for due repayments and process them</span>
<span class="w">        </span><span class="c1">// This would integrate with external payment systems or scheduled transfers</span>

<span class="w">        </span><span class="p">(</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingTarget</span><span class="p">,</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">currentBalance</span><span class="p">,</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFunded</span><span class="p">,</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFundingWithdrawn</span><span class="p">,</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalDebt</span><span class="p">,</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">repaidAmount</span><span class="p">,</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isRepaid</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDeal<span class="p">.</span>getTradeDealFullStatus<span class="p">(</span>tradeDealId<span class="p">);</span>

<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>isFunded<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span>isRepaid<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Check if repayment is due and process if available</span>
<span class="w">            </span><span class="c1">// This would require integration with external systems</span>

<span class="w">            </span>totalRepaid<span class="o">:</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">,</span>
<span class="w">            </span>participants<span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="kt">address</span><span class="p">[](</span><span class="m m-Decimal">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Activate trade deal</span>
<span class="w">        </span>tradeDeal<span class="p">.</span>activateTradeDeal<span class="p">(</span>tradeDealId<span class="p">);</span>

<span class="w">        </span><span class="c1">// Deposit invoices as collateral</span>
<span class="w">        </span><span class="kt">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span><span class="w"> </span>i<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>invoiceTokenIds<span class="p">.</span>length<span class="p">;</span><span class="w"> </span>i<span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>tradeDeal<span class="p">.</span>tdDepositInvoice<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>invoiceTokenIds<span class="p">[</span>i<span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Fund the trade deal</span>
<span class="w">        </span>tradeDeal<span class="p">.</span>tdDepositUSDC<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>fundingAmount<span class="p">);</span>
<span class="w">        </span>workflows<span class="p">[</span>tradeDealId<span class="p">].</span>totalFunding<span class="w"> </span><span class="o">=</span><span class="w"> </span>fundingAmount<span class="p">;</span>
<span class="w">        </span>workflows<span class="p">[</span>tradeDealId<span class="p">].</span>phase<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>

<span class="w">        </span>emit<span class="w"> </span>WorkflowPhaseChanged<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">processRepayment</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>WorkflowState<span class="w"> </span>storage<span class="w"> </span>workflow<span class="w"> </span><span class="o">=</span><span class="w"> </span>workflows<span class="p">[</span>tradeDealId<span class="p">];</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>workflow<span class="p">.</span>phase<span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Trade deal not funded&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Process repayment</span>
<span class="w">        </span>tradeDeal<span class="p">.</span>repayTradeDeal<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>amount<span class="p">);</span>
<span class="w">        </span>workflow<span class="p">.</span>totalRepaid<span class="w"> </span><span class="o">+=</span><span class="w"> </span>amount<span class="p">;</span>

<span class="w">        </span><span class="c1">// Check if fully repaid</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isRepaid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDeal<span class="p">.</span>isTradeDealRepaid<span class="p">(</span>tradeDealId<span class="p">);</span>
<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>isRepaid<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>workflow<span class="p">.</span>phase<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m m-Decimal">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>workflow<span class="p">.</span>phase<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">3</span><span class="p">;</span>
<span class="w">            </span>emit<span class="w"> </span>WorkflowPhaseChanged<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="m m-Decimal">3</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">distributeInterestAndFees</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>WorkflowState<span class="w"> </span>storage<span class="w"> </span>workflow<span class="w"> </span><span class="o">=</span><span class="w"> </span>workflows<span class="p">[</span>tradeDealId<span class="p">];</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>workflow<span class="p">.</span>phase<span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Trade deal not funded&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Distribute interest</span>
<span class="w">        </span>tradeDeal<span class="p">.</span>tdDistributeInterest<span class="p">(</span>tradeDealId<span class="p">);</span>

<span class="w">        </span><span class="c1">// Update phase if needed</span>
<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>workflow<span class="p">.</span>phase<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>workflow<span class="p">.</span>phase<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// Active phase</span>
<span class="w">            </span>emit<span class="w"> </span>WorkflowPhaseChanged<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="m m-Decimal">2</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">getWorkflowStatus</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">phase</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingProgress</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">repaymentProgress</span><span class="p">,</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">canRedeem</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>WorkflowState<span class="w"> </span><span class="kt">memory</span><span class="w"> </span>workflow<span class="w"> </span><span class="o">=</span><span class="w"> </span>workflows<span class="p">[</span>tradeDealId<span class="p">];</span>

<span class="w">        </span><span class="p">(</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingTarget</span><span class="p">,</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">currentBalance</span><span class="p">,</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFunded</span><span class="p">,</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFundingWithdrawn</span><span class="p">,</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalDebt</span><span class="p">,</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">repaidAmount</span><span class="p">,</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isRepaid</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDeal<span class="p">.</span>getTradeDealFullStatus<span class="p">(</span>tradeDealId<span class="p">);</span>

<span class="w">        </span>phase<span class="w"> </span><span class="o">=</span><span class="w"> </span>workflow<span class="p">.</span>phase<span class="p">;</span>
<span class="w">        </span>fundingProgress<span class="w"> </span><span class="o">=</span><span class="w"> </span>fundingTarget<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span>currentBalance<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">100</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span>fundingTarget<span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
<span class="w">        </span>repaymentProgress<span class="w"> </span><span class="o">=</span><span class="w"> </span>totalDebt<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span>repaidAmount<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">100</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span>totalDebt<span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
<span class="w">        </span>canRedeem<span class="w"> </span><span class="o">=</span><span class="w"> </span>isRepaid<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>workflow<span class="p">.</span>totalFunding<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="trade-deal-analytics-dashboard_1">Trade Deal Analytics Dashboard<a class="headerlink" href="#trade-deal-analytics-dashboard_1" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Analytics and reporting for trade deals</span>
<span class="k">contract</span><span class="w"> </span><span class="ni">TradeDealAnalytics</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>ITradeDeal<span class="w"> </span><span class="kt">public</span><span class="w"> </span>tradeDeal<span class="p">;</span>

<span class="w">    </span><span class="kt">struct</span><span class="w"> </span><span class="nv">AnalyticsData</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalDeals</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">activeDeals</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundedDeals</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">repaidDeals</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalVolume</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalInterestPaid</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">averageInterestRate</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>dealCreationTime<span class="p">;</span>
<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>dealFundingTime<span class="p">;</span>
<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>dealRepaymentTime<span class="p">;</span>

<span class="w">    </span><span class="kt">event</span><span class="w"> </span><span class="nv">AnalyticsUpdated</span><span class="p">(</span>AnalyticsData<span class="w"> </span>data<span class="p">);</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">updateAnalytics</span><span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span>AnalyticsData<span class="w"> </span><span class="kt">memory</span><span class="w"> </span>data<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>allDeals<span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDeal<span class="p">.</span>getAllTradeDealIds<span class="p">();</span>

<span class="w">        </span>data<span class="p">.</span>totalDeals<span class="w"> </span><span class="o">=</span><span class="w"> </span>allDeals<span class="p">.</span>length<span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalInterestRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>

<span class="w">        </span><span class="kt">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span><span class="w"> </span>i<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>allDeals<span class="p">.</span>length<span class="p">;</span><span class="w"> </span>i<span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">dealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>allDeals<span class="p">[</span>i<span class="p">];</span>

<span class="w">            </span><span class="p">(</span>
<span class="w">                </span><span class="kt">string</span><span class="w"> </span><span class="nv">memory</span><span class="w"> </span>name<span class="p">,</span>
<span class="w">                </span><span class="kt">string</span><span class="w"> </span><span class="nv">memory</span><span class="w"> </span>symbol<span class="p">,</span>
<span class="w">                </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">interestRate</span><span class="p">,</span>
<span class="w">                </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralRatio</span><span class="p">,</span>
<span class="w">                </span><span class="kt">bool</span><span class="w"> </span><span class="nv">active</span><span class="p">,</span>
<span class="w">                </span>TradeDealLib<span class="p">.</span>OperationMode<span class="w"> </span>mode
<span class="w">            </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDeal<span class="p">.</span>getTradeDealInfo<span class="p">(</span>dealId<span class="p">);</span>

<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>active<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span>data<span class="p">.</span>activeDeals<span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span>totalInterestRate<span class="w"> </span><span class="o">+=</span><span class="w"> </span>interestRate<span class="p">;</span>

<span class="w">            </span><span class="p">(</span>
<span class="w">                </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingTarget</span><span class="p">,</span>
<span class="w">                </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">currentBalance</span><span class="p">,</span>
<span class="w">                </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFunded</span><span class="p">,</span>
<span class="w">                </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFundingWithdrawn</span><span class="p">,</span>
<span class="w">                </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalDebt</span><span class="p">,</span>
<span class="w">                </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">repaidAmount</span><span class="p">,</span>
<span class="w">                </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isRepaid</span>
<span class="w">            </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDeal<span class="p">.</span>getTradeDealFullStatus<span class="p">(</span>dealId<span class="p">);</span>

<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>isFunded<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span>data<span class="p">.</span>fundedDeals<span class="o">++</span><span class="p">;</span>
<span class="w">                </span>data<span class="p">.</span>totalVolume<span class="w"> </span><span class="o">+=</span><span class="w"> </span>fundingTarget<span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>isRepaid<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span>data<span class="p">.</span>repaidDeals<span class="o">++</span><span class="p">;</span>
<span class="w">                </span>data<span class="p">.</span>totalInterestPaid<span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span>repaidAmount<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>fundingTarget<span class="w"> </span><span class="o">?</span><span class="w"> </span>repaidAmount<span class="w"> </span><span class="o">-</span><span class="w"> </span>fundingTarget<span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>data<span class="p">.</span>totalDeals<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>data<span class="p">.</span>averageInterestRate<span class="w"> </span><span class="o">=</span><span class="w"> </span>totalInterestRate<span class="w"> </span><span class="o">/</span><span class="w"> </span>data<span class="p">.</span>totalDeals<span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span>emit<span class="w"> </span>AnalyticsUpdated<span class="p">(</span>data<span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">getDealPerformanceMetrics</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">timeToFunding</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">timeToRepayment</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">actualInterestRate</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">performanceScore</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">creationTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>dealCreationTime<span class="p">[</span>tradeDealId<span class="p">];</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>dealFundingTime<span class="p">[</span>tradeDealId<span class="p">];</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">repaymentTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>dealRepaymentTime<span class="p">[</span>tradeDealId<span class="p">];</span>

<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>fundingTime<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>creationTime<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>timeToFunding<span class="w"> </span><span class="o">=</span><span class="w"> </span>fundingTime<span class="w"> </span><span class="o">-</span><span class="w"> </span>creationTime<span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>repaymentTime<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>fundingTime<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>fundingTime<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>timeToRepayment<span class="w"> </span><span class="o">=</span><span class="w"> </span>repaymentTime<span class="w"> </span><span class="o">-</span><span class="w"> </span>fundingTime<span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="p">(</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingTarget</span><span class="p">,</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">currentBalance</span><span class="p">,</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFunded</span><span class="p">,</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFundingWithdrawn</span><span class="p">,</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalDebt</span><span class="p">,</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">repaidAmount</span><span class="p">,</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isRepaid</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDeal<span class="p">.</span>getTradeDealFullStatus<span class="p">(</span>tradeDealId<span class="p">);</span>

<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>isRepaid<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>fundingTarget<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>actualInterestRate<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span>repaidAmount<span class="w"> </span><span class="o">-</span><span class="w"> </span>fundingTarget<span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">10000</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span>fundingTarget<span class="p">;</span>

<span class="w">            </span><span class="c1">// Calculate performance score (0-100)</span>
<span class="w">            </span>performanceScore<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">100</span><span class="p">;</span>
<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>timeToFunding<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">7</span><span class="w"> </span>days<span class="p">)</span><span class="w"> </span>performanceScore<span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="m m-Decimal">20</span><span class="p">;</span>
<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>timeToRepayment<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">90</span><span class="w"> </span>days<span class="p">)</span><span class="w"> </span>performanceScore<span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="m m-Decimal">30</span><span class="p">;</span>
<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span>isRepaid<span class="p">)</span><span class="w"> </span>performanceScore<span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="m m-Decimal">50</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="automated-trade-deal-manager_1">Automated Trade Deal Manager<a class="headerlink" href="#automated-trade-deal-manager_1" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Automated management for trade deal operations</span>
<span class="k">contract</span><span class="w"> </span><span class="ni">AutomatedTradeDealManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>ITradeDeal<span class="w"> </span><span class="kt">public</span><span class="w"> </span>tradeDeal<span class="p">;</span>

<span class="w">    </span><span class="kt">struct</span><span class="w"> </span><span class="nv">AutomationConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">autoDistributeInterest</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">interestDistributionFrequency</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">lastInterestDistribution</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">autoProcessRepayments</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">gracePeriod</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">autoRedemption</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span>AutomationConfig<span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>automationConfigs<span class="p">;</span>
<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>nextScheduledAction<span class="p">;</span>

<span class="w">    </span><span class="kt">event</span><span class="w"> </span><span class="nv">AutomationConfigured</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span>AutomationConfig<span class="w"> </span>config<span class="p">);</span>
<span class="w">    </span><span class="kt">event</span><span class="w"> </span><span class="nv">AutomatedActionExecuted</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nv">action</span><span class="p">);</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">configureAutomation</span><span class="p">(</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span>
<span class="w">        </span>AutomationConfig<span class="w"> </span><span class="kt">memory</span><span class="w"> </span>config
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>onlyAuthorized<span class="w"> </span><span class="p">{</span>
<span class="w">        </span>automationConfigs<span class="p">[</span>tradeDealId<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>config<span class="p">;</span>

<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>config<span class="p">.</span>autoDistributeInterest<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>nextScheduledAction<span class="p">[</span>tradeDealId<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">block.timestamp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>config<span class="p">.</span>interestDistributionFrequency<span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span>emit<span class="w"> </span>AutomationConfigured<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>config<span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">executeScheduledActions</span><span class="p">(</span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>tradeDealIds<span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span><span class="w"> </span>i<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>tradeDealIds<span class="p">.</span>length<span class="p">;</span><span class="w"> </span>i<span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDealIds<span class="p">[</span>i<span class="p">];</span>
<span class="w">            </span>AutomationConfig<span class="w"> </span><span class="kt">memory</span><span class="w"> </span>config<span class="w"> </span><span class="o">=</span><span class="w"> </span>automationConfigs<span class="p">[</span>tradeDealId<span class="p">];</span>

<span class="w">            </span><span class="c1">// Auto-distribute interest</span>
<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>config<span class="p">.</span>autoDistributeInterest<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">                </span><span class="k">block.timestamp</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span>nextScheduledAction<span class="p">[</span>tradeDealId<span class="p">])</span><span class="w"> </span><span class="p">{</span>

<span class="w">                </span>tradeDeal<span class="p">.</span>tdDistributeInterest<span class="p">(</span>tradeDealId<span class="p">);</span>
<span class="w">                </span>nextScheduledAction<span class="p">[</span>tradeDealId<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">block.timestamp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>config<span class="p">.</span>interestDistributionFrequency<span class="p">;</span>

<span class="w">                </span>emit<span class="w"> </span>AutomatedActionExecuted<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="s2">&quot;interest_distribution&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// Auto-process repayments (would need additional logic)</span>
<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>config<span class="p">.</span>autoProcessRepayments<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span>_processAutomaticRepayments<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span>config<span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// Auto-redemption for completed deals</span>
<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>config<span class="p">.</span>autoRedemption<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span>_processAutomaticRedemption<span class="p">(</span>tradeDealId<span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">_processAutomaticRepayments</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">,</span><span class="w"> </span>AutomationConfig<span class="w"> </span><span class="kt">memory</span><span class="w"> </span>config<span class="p">)</span><span class="w"> </span><span class="kt">internal</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Implementation would check for due repayments and process them</span>
<span class="w">        </span><span class="c1">// This would integrate with external payment systems or scheduled transfers</span>

<span class="w">        </span><span class="p">(</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingTarget</span><span class="p">,</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">currentBalance</span><span class="p">,</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFunded</span><span class="p">,</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isFundingWithdrawn</span><span class="p">,</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalDebt</span><span class="p">,</span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">repaidAmount</span><span class="p">,</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isRepaid</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDeal<span class="p">.</span>getTradeDealFullStatus<span class="p">(</span>tradeDealId<span class="p">);</span>

<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>isFunded<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span>isRepaid<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Check if repayment is due and process if available</span>
<span class="w">            </span><span class="c1">// This would require integration with external systems</span>
<span class="w">            </span>emit<span class="w"> </span>AutomatedActionExecuted<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="s2">&quot;repayment_check&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">_processAutomaticRedemption</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tradeDealId</span><span class="p">)</span><span class="w"> </span><span class="kt">internal</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">isRepaid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tradeDeal<span class="p">.</span>isTradeDealRepaid<span class="p">(</span>tradeDealId<span class="p">);</span>

<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>isRepaid<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Process automatic redemption for eligible participants</span>
<span class="w">            </span><span class="c1">// This would require additional participant tracking</span>
<span class="w">            </span>emit<span class="w"> </span>AutomatedActionExecuted<span class="p">(</span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="s2">&quot;auto_redemption&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="events">Events<a class="headerlink" href="#events" title="Permanent link">&para;</a></h2>
<h3 id="trade-deal-lifecycle-events">Trade Deal Lifecycle Events<a class="headerlink" href="#trade-deal-lifecycle-events" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="kt">event</span><span class="w"> </span><span class="nv">TradeDealCreated</span><span class="p">(</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="nv">name</span><span class="p">,</span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="nv">symbol</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">interestRate</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralToInterestRatio</span><span class="p">,</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nv">active</span><span class="p">,</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">nftAddress</span><span class="p">,</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">collateralAddress</span><span class="p">,</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">interestAddress</span><span class="p">,</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">usdcAddress</span><span class="p">,</span>
<span class="w">    </span>TradeDealLib<span class="p">.</span>OperationMode<span class="w"> </span>operationMode
<span class="p">);</span>

<span class="kt">event</span><span class="w"> </span><span class="nv">TradeDealUpdated</span><span class="p">(</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="nv">name</span><span class="p">,</span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="nv">symbol</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">interestRate</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralToInterestRatio</span><span class="p">,</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nv">active</span><span class="p">,</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">collateralAddress</span><span class="p">,</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">interestAddress</span><span class="p">,</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">usdcAddress</span>
<span class="p">);</span>

<span class="kt">event</span><span class="w"> </span><span class="nv">TradeDealActivated</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">);</span>
<span class="kt">event</span><span class="w"> </span><span class="nv">TradeDealDeactivated</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">);</span>
</code></pre></div>

<h3 id="participant-management-events">Participant Management Events<a class="headerlink" href="#participant-management-events" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="kt">event</span><span class="w"> </span><span class="nv">TradeDealParticipantAdded</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>participant<span class="p">);</span>
<span class="kt">event</span><span class="w"> </span><span class="nv">TradeDealParticipantRemoved</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>participant<span class="p">);</span>
<span class="kt">event</span><span class="w"> </span><span class="nv">TradeDealRequiredClaimTopicsSet</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span>claimTopics<span class="p">);</span>
</code></pre></div>

<h3 id="collateral-and-funding-events">Collateral and Funding Events<a class="headerlink" href="#collateral-and-funding-events" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="kt">event</span><span class="w"> </span><span class="nv">InvoiceDepositedToTradeDeal</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tokenId<span class="p">);</span>
<span class="kt">event</span><span class="w"> </span><span class="nv">InvoiceWithdrawnFromTradeDeal</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tokenId<span class="p">);</span>
<span class="kt">event</span><span class="w"> </span><span class="nv">USDCDepositedToTradeDeal</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">depositor</span><span class="p">);</span>
<span class="kt">event</span><span class="w"> </span><span class="nv">USDCWithdrawnFromTradeDeal</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">);</span>
<span class="kt">event</span><span class="w"> </span><span class="nv">TradeDealFullyFunded</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">fundingTarget</span><span class="p">);</span>
<span class="kt">event</span><span class="w"> </span><span class="nv">CollateralTokensDistributed</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>recipient<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">);</span>
</code></pre></div>

<h3 id="interest-and-fee-events">Interest and Fee Events<a class="headerlink" href="#interest-and-fee-events" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="kt">event</span><span class="w"> </span><span class="nv">InterestDistributedForTradeDeal</span><span class="p">(</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">totalInterest</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">invoicePoolInterest</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">interestInterest</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">interestTokensMinted</span>
<span class="p">);</span>

<span class="kt">event</span><span class="w"> </span><span class="nv">TradeDealFeesDistributed</span><span class="p">(</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span>
<span class="w">    </span><span class="kt">address</span><span class="p">[]</span><span class="w"> </span>feeReceivers<span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span>feeAmounts
<span class="p">);</span>
</code></pre></div>

<h3 id="repayment-and-settlement-events">Repayment and Settlement Events<a class="headerlink" href="#repayment-and-settlement-events" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="kt">event</span><span class="w"> </span><span class="nv">TradeDealFundingWithdrawn</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>recipient<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">);</span>
<span class="kt">event</span><span class="w"> </span><span class="nv">TradeDealRepaid</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>repayer<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nv">fullyRepaid</span><span class="p">);</span>
<span class="kt">event</span><span class="w"> </span><span class="nv">CollateralTokensRedeemed</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>tradeDealId<span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>redeemer<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">collateralAmount</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">usdcAmount</span><span class="p">);</span>
</code></pre></div>

<h2 id="security-considerations">Security Considerations<a class="headerlink" href="#security-considerations" title="Permanent link">&para;</a></h2>
<h3 id="access-control">Access Control<a class="headerlink" href="#access-control" title="Permanent link">&para;</a></h3>
<ul>
<li>Owner-only functions for trade deal creation and configuration</li>
<li>Participant validation for operations and access</li>
<li>Identity verification through claim topics</li>
<li>Role-based permissions for administrative functions</li>
</ul>
<h3 id="financial-security">Financial Security<a class="headerlink" href="#financial-security" title="Permanent link">&para;</a></h3>
<ul>
<li>Precise amount calculations and validations</li>
<li>Overflow protection for large transactions</li>
<li>Secure token transfer mechanisms</li>
<li>Interest calculation accuracy and validation</li>
</ul>
<h3 id="operational-security">Operational Security<a class="headerlink" href="#operational-security" title="Permanent link">&para;</a></h3>
<ul>
<li>Trade deal state validation before operations</li>
<li>Invoice ownership verification</li>
<li>Funding availability checks</li>
<li>Repayment authorization validation</li>
</ul>
<h2 id="gas-optimization">Gas Optimization<a class="headerlink" href="#gas-optimization" title="Permanent link">&para;</a></h2>
<h3 id="efficient-operations">Efficient Operations<a class="headerlink" href="#efficient-operations" title="Permanent link">&para;</a></h3>
<ul>
<li>Batch operations for multiple trade deals</li>
<li>Optimized storage layout for trade deal data</li>
<li>Minimal external calls in view functions</li>
<li>Efficient event emission patterns</li>
</ul>
<h3 id="storage-optimization">Storage Optimization<a class="headerlink" href="#storage-optimization" title="Permanent link">&para;</a></h3>
<ul>
<li>Packed storage structures where possible</li>
<li>Efficient mapping usage for participant tracking</li>
<li>Optimized array operations for bulk queries</li>
<li>Cached calculations for frequently accessed data</li>
</ul>
<h2 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h2>
<h3 id="common-errors">Common Errors<a class="headerlink" href="#common-errors" title="Permanent link">&para;</a></h3>
<ul>
<li>Trade deal not found or inactive</li>
<li>Insufficient permissions or authorization</li>
<li>Invalid amounts or parameters</li>
<li>Funding or repayment validation failures</li>
<li>Participant verification failures</li>
</ul>
<h3 id="best-practices">Best Practices<a class="headerlink" href="#best-practices" title="Permanent link">&para;</a></h3>
<ul>
<li>Validate all inputs before processing</li>
<li>Check trade deal state before operations</li>
<li>Verify participant eligibility for operations</li>
<li>Handle token transfer failures gracefully</li>
<li>Provide clear error messages for debugging</li>
</ul>
<h2 id="testing-considerations">Testing Considerations<a class="headerlink" href="#testing-considerations" title="Permanent link">&para;</a></h2>
<h3 id="unit-tests">Unit Tests<a class="headerlink" href="#unit-tests" title="Permanent link">&para;</a></h3>
<ul>
<li>Interface compliance verification</li>
<li>Function parameter validation</li>
<li>Return value accuracy testing</li>
<li>Event emission verification</li>
<li>Error condition handling</li>
</ul>
<h3 id="integration-tests">Integration Tests<a class="headerlink" href="#integration-tests" title="Permanent link">&para;</a></h3>
<ul>
<li>Complete trade deal lifecycle workflows</li>
<li>Multi-participant scenarios</li>
<li>Interest distribution and fee calculations</li>
<li>Repayment and redemption processes</li>
<li>Cross-facet integration testing</li>
</ul>
<h2 id="related-documentation">Related Documentation<a class="headerlink" href="#related-documentation" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="../../facets/trade-deal-management-facet/">TradeDealManagementFacet</a> - Core trade deal operations</li>
<li><a href="../../facets/trade-deal-admin-facet/">TradeDealAdminFacet</a> - Administrative functions</li>
<li><a href="../../facets/trade-deal-operations-facet/">TradeDealOperationsFacet</a> - Operational functions</li>
<li><a href="../../libraries/trade-deal-lib/">TradeDealLib</a> - Trade deal utilities</li>
<li><a href="../../facets/collateral-token-factory-facet/">CollateralTokenFactoryFacet</a> - Token factory integration</li>
<li><a href="../../guides/trade-deals.md">Trade Deal Guide</a> - Implementation guide</li>
</ul>
<hr />
<p><em>This interface defines the comprehensive contract for trade deal functionality within the Gemforce platform, providing standardized operations for collateralized finance instruments with invoice backing and automated settlement.</em></p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../imarketplace/" class="btn btn-neutral float-left" title="IMarketplace"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../icarbon-credit/" class="btn btn-neutral float-right" title="ICarbonCredit">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../imarketplace/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../icarbon-credit/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
