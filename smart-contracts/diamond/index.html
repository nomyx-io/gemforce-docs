<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Gemforce Team" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Diamond Contract - Gemforce Documentation</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Diamond Contract";
        var mkdocs_page_input_path = "smart-contracts/diamond.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Gemforce Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../developer-setup-guide/">Developer Setup Guide</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../system-architecture/gemforce-system-architecture/">System Architecture</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Smart Contracts</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../">Overview</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Diamond Contract</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#contract-details">Contract Details</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#key-features">Key Features</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#eip-2535-diamond-standard-implementation">ðŸ”¹ EIP-2535 Diamond Standard Implementation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#multi-interface-support">ðŸ”¹ Multi-Interface Support</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#upgrade-timelock-security">ðŸ”¹ Upgrade Timelock Security</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#core-functions">Core Functions</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#initialization">Initialization</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#initialize">initialize()</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#ownership-management">Ownership Management</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#transferownership">transferOwnership()</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#owner">owner()</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#utility-functions">Utility Functions</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#diamondaddress">diamondAddress()</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#proxy-functionality">Proxy Functionality</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#fallback">fallback()</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#receive">receive()</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#architecture-integration">Architecture Integration</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#diamond-storage-pattern">Diamond Storage Pattern</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#facet-routing">Facet Routing</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#security-considerations">Security Considerations</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#access-control">Access Control</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#upgrade-safety">Upgrade Safety</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#reentrancy-protection">Reentrancy Protection</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#gas-optimization">Gas Optimization</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#efficient-proxy-pattern">Efficient Proxy Pattern</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#storage-efficiency">Storage Efficiency</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#integration-examples">Integration Examples</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#basic-diamond-deployment">Basic Diamond Deployment</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#adding-new-facets">Adding New Facets</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#events">Events</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#error-handling">Error Handling</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#common-errors">Common Errors</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#testing-considerations">Testing Considerations</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#unit-tests">Unit Tests</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#integration-tests">Integration Tests</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#related-documentation">Related Documentation</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#external-references">External References</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../diamond-factory/">Diamond Factory</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../identity-factory/">Identity Factory</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Facets</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../facets/marketplace-facet/">Marketplace Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../facets/trade-deal-management-facet/">Trade Deal Management Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../facets/carbon-credit-facet/">Carbon Credit Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../facets/identity-registry-facet/">Identity Registry Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../facets/trusted-issuers-registry-facet/">Trusted Issuers Registry Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../facets/fee-distributor-facet/">Fee Distributor Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../facets/gemforce-minter-facet/">Gemforce Minter Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../facets/multi-sale-facet/">Multi Sale Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../facets/svg-templates-facet/">SVG Templates Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../facets/trade-deal-admin-facet/">Trade Deal Admin Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../facets/trade-deal-operations-facet/">Trade Deal Operations Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../facets/collateral-token-factory-facet/">Collateral Token Factory Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../facets/diamond-cut-facet/">Diamond Cut Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../facets/diamond-loupe-facet/">Diamond Loupe Facet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../facets/ownership-facet/">Ownership Facet</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Interfaces</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../interfaces/idiamond/">IDiamond</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../interfaces/imarketplace/">IMarketplace</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../interfaces/itradedeal/">ITradeDeal</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../interfaces/icarbon-credit/">ICarbonCredit</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../interfaces/ierc1155-mint/">IERC1155Mint</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../interfaces/ierc734/">IERC734</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../interfaces/ierc735/">IERC735</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../interfaces/ierc721a/">IERC721A</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../interfaces/idiamond-factory/">IDiamondFactory</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../interfaces/iidentity/">IIdentity</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../interfaces/imultisale/">IMultiSale</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../interfaces/ifee-distributor/">IFeeDistributor</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../interfaces/igemforce-minter-facet/">IGemforceMinterFacet</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../interfaces/iidentity-registry/">IIdentityRegistry</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../interfaces/itrusted-issuers-registry/">TRUSTEDIssuersRegistry</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../interfaces/isvg/">ISVG</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../interfaces/iattribute/">IAttribute</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Libraries</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../libraries/carbon-credit-lib/">Carbon Credit Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../libraries/trade-deal-lib/">Trade Deal Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../libraries/multi-sale-lib/">Multi Sale Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../libraries/diamond-factory-lib/">Diamond Factory Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../libraries/svg-templates-lib/">SVG Templates Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../libraries/attribute-lib/">Attribute Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../libraries/variable-price-lib/">Variable Price Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../libraries/merkle-prover/">Merkle Prover</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../libraries/fee-distributor-lib/">Fee Distributor Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../libraries/lib-diamond/">LibDiamond</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../libraries/diamond-lib/">DiamondLib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../libraries/erc721a-lib/">ERC721A Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../libraries/erc721a-enumeration-lib/">ERC721A Enumeration Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../libraries/strings-lib/">Strings Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../libraries/trusted-issuer-lib/">Trusted Issuer Lib</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../libraries/set-libraries/">Set Libraries</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SDK & Libraries</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../sdk-libraries/blockchain/">Blockchain Utilities</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../sdk-libraries/diamond/">Diamond Utilities</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../sdk-libraries/contract/">Contract Utilities</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../sdk-libraries/deploy/">Deployment Utilities</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../sdk-libraries/validation-utils/">Validation Utilities</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../sdk-libraries/nft-sale-utils/">NFT Sale Utilities</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Cloud Functions</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/authentication/">Authentication Functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/auth-functions/">Auth Functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/blockchain/">Blockchain Functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/bridge/">Bridge Functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/contracts/">Contract Functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/deploy/">Deploy Functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/dfns/">DFNS Functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/project/">Project Functions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/trade-deal/">Trade Deal Functions</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API Documentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../api-documentation/gemforce-api-documentation/">Full API Reference</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api-documentation/gemforce-api-quick-reference/">Quick Reference</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Operations Tasks</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/tasks/diamond/">Diamond Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/tasks/identities/">Identity Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/tasks/marketplace-management/">Marketplace Management Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/tasks/carbon-credit-management/">Carbon Credit Management Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/tasks/trade-deal/">Trade Deal Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/tasks/integration-test/">Integration Test Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/tasks/integration-test-marketplace/">Marketplace Integration Test Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/tasks/integration-test-trade-deal/">Trade Deal Integration Test Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/tasks/admin-utils/">Admin Utilities</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/tasks/sync-diamond/">Sync Diamond Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cloud-functions/tasks/sync-events/">Sync Events Tasks</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">EIPs (Ethereum Improvement Proposals)</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../eips/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../eips/EIP-DRAFT-Diamond-Enhanced-Marketplace/">Diamond-Enhanced Marketplace</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../eips/EIP-DRAFT-Multi-Token-Sale-Standard/">Multi-Token Sale Standard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../eips/EIP-DRAFT-Collateralized-Trade-Deal-Standard/">Collateralized Trade Deal Standard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../eips/EIP-DRAFT-Enhanced-Identity-System/">Enhanced Identity System</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../eips/EIP-DRAFT-Diamond-Factory-Standard/">Diamond Factory Standard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../eips/EIP-DRAFT-Carbon-Credit-Standard/">Carbon Credit Standard</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">User Guides</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../gemforce-administrator-guide/">Administrator Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../gemforce-deployer-guide/">Deployer Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../gemforce-integrator-guide/">Integrator Guide</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Integrator's Guide</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../integrator-guide/overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../integrator-guide/authentication/">Authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../integrator-guide/rest-api/">REST API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../integrator-guide/smart-contracts/">Smart Contracts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../integrator-guide/dfns/">DFNS Integration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../integrator-guide/webhooks/">Webhooks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../integrator-guide/error-handling/">Error Handling</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../integrator-guide/sample-code/">Sample Code</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../integrator-guide/integration-patterns/">Integration Patterns</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../integrator-guide/security/">Security</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../external-services/gemforce-external-services/">External Services</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../gemforce-documentation-gap-analysis/">Documentation Gap Analysis</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../documentation-progress-summary/">Documentation Progress Summary</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../documentation-plan/">Documentation Plan</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Gemforce Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Smart Contracts</li>
      <li class="breadcrumb-item active">Diamond Contract</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="diamond-contract">Diamond Contract<a class="headerlink" href="#diamond-contract" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>The <a href="/Users/sschepis/Development/gem-base/contracts/Diamond.sol"><code>Diamond.sol</code></a> contract is the core proxy contract implementing the EIP-2535 Diamond Standard. It serves as the main entry point for all diamond-based contracts in the Gemforce system, providing upgradeable functionality through modular facets.</p>
<h2 id="contract-details">Contract Details<a class="headerlink" href="#contract-details" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Contract Name</strong>: <code>Diamond</code></li>
<li><strong>Inheritance</strong>: <code>Initializable</code>, <code>IERC173</code></li>
<li><strong>License</strong>: MIT</li>
<li><strong>Solidity Version</strong>: ^0.8.0</li>
</ul>
<h2 id="key-features">Key Features<a class="headerlink" href="#key-features" title="Permanent link">&para;</a></h2>
<h3 id="eip-2535-diamond-standard-implementation">ðŸ”¹ EIP-2535 Diamond Standard Implementation<a class="headerlink" href="#eip-2535-diamond-standard-implementation" title="Permanent link">&para;</a></h3>
<ul>
<li>Modular architecture through facets</li>
<li>Upgradeable functionality without changing contract address</li>
<li>Gas-efficient proxy pattern with delegatecall</li>
</ul>
<h3 id="multi-interface-support">ðŸ”¹ Multi-Interface Support<a class="headerlink" href="#multi-interface-support" title="Permanent link">&para;</a></h3>
<ul>
<li>ERC165 (Interface Detection)</li>
<li>ERC173 (Contract Ownership)</li>
<li>ERC721 (Non-Fungible Token)</li>
<li>ERC721Metadata (Token Metadata)</li>
<li>ERC721Enumerable (Token Enumeration)</li>
</ul>
<h3 id="upgrade-timelock-security">ðŸ”¹ Upgrade Timelock Security<a class="headerlink" href="#upgrade-timelock-security" title="Permanent link">&para;</a></h3>
<ul>
<li>Built-in upgrade timelock mechanism</li>
<li>Prevents immediate malicious upgrades</li>
<li>Configurable timelock duration</li>
</ul>
<h2 id="core-functions">Core Functions<a class="headerlink" href="#core-functions" title="Permanent link">&para;</a></h2>
<h3 id="initialization">Initialization<a class="headerlink" href="#initialization" title="Permanent link">&para;</a></h3>
<h4 id="initialize"><code>initialize()</code><a class="headerlink" href="#initialize" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">initialize</span><span class="p">(</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">_owner</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span>DiamondSettings<span class="w"> </span><span class="kt">memory</span><span class="w"> </span>params<span class="p">,</span>
<span class="w">    </span>IDiamondCut<span class="p">.</span>FacetCut<span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>_facets<span class="p">,</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">diamondInit</span><span class="p">,</span>
<span class="w">    </span><span class="kt">bytes</span><span class="w"> </span><span class="nv">calldata</span><span class="w"> </span>_calldata
<span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>initializer
</code></pre></div>

<p><strong>Purpose</strong>: Initializes the Diamond contract with owner, settings, and initial facets.</p>
<p><strong>Parameters</strong>:
- <code>_owner</code>: The initial owner of the contract
- <code>params</code>: Diamond settings including name and symbol
- <code>_facets</code>: Array of initial facets to add during deployment
- <code>diamondInit</code>: Address of the initialization contract
- <code>_calldata</code>: Initialization calldata to execute</p>
<p><strong>Key Operations</strong>:
1. Sets up supported interfaces (ERC165, ERC173, ERC721, etc.)
2. Performs diamond cut to add initial facets
3. Sets contract owner
4. Configures diamond metadata (name, symbol)
5. Initializes upgrade timelock with default duration</p>
<h3 id="ownership-management">Ownership Management<a class="headerlink" href="#ownership-management" title="Permanent link">&para;</a></h3>
<h4 id="transferownership"><code>transferOwnership()</code><a class="headerlink" href="#transferownership" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">transferOwnership</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">_newOwner</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>override
</code></pre></div>

<p><strong>Purpose</strong>: Transfers contract ownership to a new address.</p>
<p><strong>Access Control</strong>: Only current owner</p>
<p><strong>Parameters</strong>:
- <code>_newOwner</code>: Address of the new owner</p>
<h4 id="owner"><code>owner()</code><a class="headerlink" href="#owner" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">owner</span><span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>override<span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">owner_</span><span class="p">)</span>
</code></pre></div>

<p><strong>Purpose</strong>: Returns the current contract owner.</p>
<p><strong>Returns</strong>: Current owner address</p>
<h3 id="utility-functions">Utility Functions<a class="headerlink" href="#utility-functions" title="Permanent link">&para;</a></h3>
<h4 id="diamondaddress"><code>diamondAddress()</code><a class="headerlink" href="#diamondaddress" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">diamondAddress</span><span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">address</span><span class="p">)</span>
</code></pre></div>

<p><strong>Purpose</strong>: Returns this contract's address.</p>
<p><strong>Returns</strong>: The diamond contract address</p>
<h3 id="proxy-functionality">Proxy Functionality<a class="headerlink" href="#proxy-functionality" title="Permanent link">&para;</a></h3>
<h4 id="fallback"><code>fallback()</code><a class="headerlink" href="#fallback" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>fallback<span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="kt">payable</span>
</code></pre></div>

<p><strong>Purpose</strong>: Core proxy functionality that routes function calls to appropriate facets.</p>
<p><strong>Process</strong>:
1. Retrieves diamond storage
2. Looks up facet address for the called function selector
3. Executes function using <code>delegatecall</code>
4. Returns result or reverts with error</p>
<h4 id="receive"><code>receive()</code><a class="headerlink" href="#receive" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>receive<span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="kt">payable</span>
</code></pre></div>

<p><strong>Purpose</strong>: Allows the contract to receive ETH directly.</p>
<h2 id="architecture-integration">Architecture Integration<a class="headerlink" href="#architecture-integration" title="Permanent link">&para;</a></h2>
<h3 id="diamond-storage-pattern">Diamond Storage Pattern<a class="headerlink" href="#diamond-storage-pattern" title="Permanent link">&para;</a></h3>
<p>The Diamond contract uses the diamond storage pattern to avoid storage collisions:</p>
<div class="codehilite"><pre><span></span><code>LibDiamond<span class="p">.</span>DiamondStorage<span class="w"> </span>storage<span class="w"> </span>ds<span class="p">;</span>
<span class="kt">bytes32</span><span class="w"> </span><span class="nv">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>LibDiamond<span class="p">.</span>DIAMOND_STORAGE_POSITION<span class="p">;</span>
assembly<span class="w"> </span><span class="p">{</span>
<span class="w">    </span>ds<span class="p">.</span>slot<span class="w"> </span><span class="o">:=</span><span class="w"> </span>position
<span class="p">}</span>
</code></pre></div>

<h3 id="facet-routing">Facet Routing<a class="headerlink" href="#facet-routing" title="Permanent link">&para;</a></h3>
<p>Function calls are routed through the fallback function:</p>
<ol>
<li><strong>Function Selector Lookup</strong>: <code>msg.sig</code> is used to find the corresponding facet</li>
<li><strong>Delegatecall Execution</strong>: Function is executed in the context of the diamond</li>
<li><strong>Return Handling</strong>: Results are returned to the caller</li>
</ol>
<h2 id="security-considerations">Security Considerations<a class="headerlink" href="#security-considerations" title="Permanent link">&para;</a></h2>
<h3 id="access-control">Access Control<a class="headerlink" href="#access-control" title="Permanent link">&para;</a></h3>
<ul>
<li>Owner-only functions protected by <code>LibDiamond.enforceIsContractOwner()</code></li>
<li>Upgrade timelock prevents immediate malicious upgrades</li>
<li>Interface validation ensures proper ERC compliance</li>
</ul>
<h3 id="upgrade-safety">Upgrade Safety<a class="headerlink" href="#upgrade-safety" title="Permanent link">&para;</a></h3>
<ul>
<li>Timelock mechanism for upgrades</li>
<li>Facet validation during diamond cuts</li>
<li>Storage collision prevention through diamond storage pattern</li>
</ul>
<h3 id="reentrancy-protection">Reentrancy Protection<a class="headerlink" href="#reentrancy-protection" title="Permanent link">&para;</a></h3>
<ul>
<li>Inherits reentrancy protection from facets</li>
<li>Delegatecall pattern maintains security context</li>
</ul>
<h2 id="gas-optimization">Gas Optimization<a class="headerlink" href="#gas-optimization" title="Permanent link">&para;</a></h2>
<h3 id="efficient-proxy-pattern">Efficient Proxy Pattern<a class="headerlink" href="#efficient-proxy-pattern" title="Permanent link">&para;</a></h3>
<ul>
<li>Single storage slot lookup for facet routing</li>
<li>Assembly-optimized delegatecall implementation</li>
<li>Minimal overhead for function calls</li>
</ul>
<h3 id="storage-efficiency">Storage Efficiency<a class="headerlink" href="#storage-efficiency" title="Permanent link">&para;</a></h3>
<ul>
<li>Diamond storage pattern prevents storage collisions</li>
<li>Packed structs in diamond settings</li>
<li>Efficient interface registration</li>
</ul>
<h2 id="integration-examples">Integration Examples<a class="headerlink" href="#integration-examples" title="Permanent link">&para;</a></h2>
<h3 id="basic-diamond-deployment">Basic Diamond Deployment<a class="headerlink" href="#basic-diamond-deployment" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Deploy diamond with initial facets</span>
IDiamondCut<span class="p">.</span>FacetCut<span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>cuts<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span>IDiamondCut<span class="p">.</span>FacetCut<span class="p">[](</span><span class="m m-Decimal">3</span><span class="p">);</span>

<span class="c1">// Add DiamondCutFacet</span>
cuts<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>IDiamondCut<span class="p">.</span>FacetCut<span class="p">({</span>
<span class="w">    </span>facetAddress<span class="o">:</span><span class="w"> </span>diamondCutFacet<span class="p">,</span>
<span class="w">    </span>action<span class="o">:</span><span class="w"> </span>IDiamondCut<span class="p">.</span>FacetCutAction<span class="p">.</span>Add<span class="p">,</span>
<span class="w">    </span>functionSelectors<span class="o">:</span><span class="w"> </span>diamondCutSelectors
<span class="p">});</span>

<span class="c1">// Add DiamondLoupeFacet</span>
cuts<span class="p">[</span><span class="m m-Decimal">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>IDiamondCut<span class="p">.</span>FacetCut<span class="p">({</span>
<span class="w">    </span>facetAddress<span class="o">:</span><span class="w"> </span>diamondLoupeFacet<span class="p">,</span>
<span class="w">    </span>action<span class="o">:</span><span class="w"> </span>IDiamondCut<span class="p">.</span>FacetCutAction<span class="p">.</span>Add<span class="p">,</span>
<span class="w">    </span>functionSelectors<span class="o">:</span><span class="w"> </span>diamondLoupeSelectors
<span class="p">});</span>

<span class="c1">// Add OwnershipFacet</span>
cuts<span class="p">[</span><span class="m m-Decimal">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>IDiamondCut<span class="p">.</span>FacetCut<span class="p">({</span>
<span class="w">    </span>facetAddress<span class="o">:</span><span class="w"> </span>ownershipFacet<span class="p">,</span>
<span class="w">    </span>action<span class="o">:</span><span class="w"> </span>IDiamondCut<span class="p">.</span>FacetCutAction<span class="p">.</span>Add<span class="p">,</span>
<span class="w">    </span>functionSelectors<span class="o">:</span><span class="w"> </span>ownershipSelectors
<span class="p">});</span>

<span class="c1">// Initialize diamond</span>
diamond<span class="p">.</span>initialize<span class="p">(</span>
<span class="w">    </span>owner<span class="p">,</span>
<span class="w">    </span>DiamondSettings<span class="p">({</span>name<span class="o">:</span><span class="w"> </span><span class="s2">&quot;MyDiamond&quot;</span><span class="p">,</span><span class="w"> </span>symbol<span class="o">:</span><span class="w"> </span><span class="s2">&quot;MD&quot;</span><span class="p">}),</span>
<span class="w">    </span>cuts<span class="p">,</span>
<span class="w">    </span>diamondInit<span class="p">,</span>
<span class="w">    </span>initCalldata
<span class="p">);</span>
</code></pre></div>

<h3 id="adding-new-facets">Adding New Facets<a class="headerlink" href="#adding-new-facets" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Add marketplace functionality</span>
IDiamondCut<span class="p">.</span>FacetCut<span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>cuts<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span>IDiamondCut<span class="p">.</span>FacetCut<span class="p">[](</span><span class="m m-Decimal">1</span><span class="p">);</span>
cuts<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>IDiamondCut<span class="p">.</span>FacetCut<span class="p">({</span>
<span class="w">    </span>facetAddress<span class="o">:</span><span class="w"> </span>marketplaceFacet<span class="p">,</span>
<span class="w">    </span>action<span class="o">:</span><span class="w"> </span>IDiamondCut<span class="p">.</span>FacetCutAction<span class="p">.</span>Add<span class="p">,</span>
<span class="w">    </span>functionSelectors<span class="o">:</span><span class="w"> </span>marketplaceSelectors
<span class="p">});</span>

IDiamondCut<span class="p">(</span>diamond<span class="p">).</span>diamondCut<span class="p">(</span>cuts<span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="m m-Decimal">0</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">);</span>
</code></pre></div>

<h2 id="events">Events<a class="headerlink" href="#events" title="Permanent link">&para;</a></h2>
<p>The Diamond contract itself doesn't emit events directly, but inherits events from:
- <code>LibDiamond</code> for diamond cuts and ownership changes
- Individual facets for their specific functionality</p>
<h2 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h2>
<h3 id="common-errors">Common Errors<a class="headerlink" href="#common-errors" title="Permanent link">&para;</a></h3>
<ul>
<li><code>"Diamond: Function does not exist"</code>: Called function selector not found in any facet</li>
<li><code>"LibDiamond: Must be contract owner"</code>: Unauthorized access to owner-only functions</li>
<li><code>"LibDiamond: Upgrade timelock not expired"</code>: Attempted upgrade before timelock expiration</li>
</ul>
<h2 id="testing-considerations">Testing Considerations<a class="headerlink" href="#testing-considerations" title="Permanent link">&para;</a></h2>
<h3 id="unit-tests">Unit Tests<a class="headerlink" href="#unit-tests" title="Permanent link">&para;</a></h3>
<ul>
<li>Test initialization with various facet combinations</li>
<li>Verify ownership transfer functionality</li>
<li>Test fallback function routing</li>
<li>Validate interface support</li>
</ul>
<h3 id="integration-tests">Integration Tests<a class="headerlink" href="#integration-tests" title="Permanent link">&para;</a></h3>
<ul>
<li>Test with real facet implementations</li>
<li>Verify upgrade procedures</li>
<li>Test complex multi-facet interactions</li>
</ul>
<h2 id="related-documentation">Related Documentation<a class="headerlink" href="#related-documentation" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="../diamond-factory/">DiamondFactory</a> - Factory for diamond deployment</li>
<li><a href="../facets/diamond-cut-facet/">DiamondCutFacet</a> - Diamond upgrade functionality</li>
<li><a href="../facets/diamond-loupe-facet/">DiamondLoupeFacet</a> - Diamond introspection</li>
<li><a href="../libraries/lib-diamond/">LibDiamond</a> - Diamond utility library</li>
</ul>
<h2 id="external-references">External References<a class="headerlink" href="#external-references" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://eips.ethereum.org/EIPS/eip-2535">EIP-2535: Diamonds, Multi-Facet Proxy</a></li>
<li><a href="https://eip2535diamonds.substack.com/">Diamond Standard Documentation</a></li>
<li><a href="https://docs.openzeppelin.com/contracts/4.x/api/proxy#Initializable">OpenZeppelin Initializable</a></li>
</ul>
<hr />
<p><em>This documentation covers the core Diamond contract. For specific functionality, refer to the individual facet documentation.</em></p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../" class="btn btn-neutral float-left" title="Overview"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../diamond-factory/" class="btn btn-neutral float-right" title="Diamond Factory">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../diamond-factory/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
